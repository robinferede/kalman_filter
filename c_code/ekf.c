
#include "ekf.h"
#include <math.h>

// Kalman filter process noise covariance matrix (diagonal)
float ekf_Q_diag[N_INPUTS];

// Kalman filter measurement noise covariance matrix (diagonal)
float ekf_R_diag[N_MEASUREMENTS];

// Kalman filter state
float ekf_X[N_STATES];
float ekf_X_new[N_STATES];

// Kalman filter covariance matrix (lower diagonal)
float ekf_P_lower_diagonal[N_STATES*(N_STATES+1)/2];
float ekf_P_lower_diagonal_new[N_STATES*(N_STATES+1)/2];

// Temporary variables
float tmp[200];

// pointers
float *X = ekf_X;
float *X_new = ekf_X_new;

float *P = ekf_P_lower_diagonal;
float *P_new = ekf_P_lower_diagonal_new;

float *Q_diag = ekf_Q_diag;
float *R_diag = ekf_R_diag;

// pointer for swapping
float *swap_ptr;

void ekf_init(float Q_diag[N_INPUTS], float R_diag[N_MEASUREMENTS], float X0[N_STATES], float P_diag0[N_STATES]) {
    // initialize Q and R
    for (int i=0; i<N_INPUTS; i++) {
        ekf_Q_diag[i] = Q_diag[i];
    }
    for (int i=0; i<N_MEASUREMENTS; i++) {
        ekf_R_diag[i] = R_diag[i];
    }

    // set P to zeros
    for (int i=0; i<N_STATES*(N_STATES+1)/2; i++) {
        P[i] = 0;
    }

    // initialize X and P
    for (int i=0; i<N_STATES; i++) {
        X[i] = X0[i];
        P[i*(i+1)/2+i] = P_diag0[i];
    }
}

float* ekf_get_state() {
    return X;
}

void ekf_predict(float U[N_INPUTS], float dt) {
    // PREDICTION STEP X_new, P_new = ...
    tmp[0] = cos(X[8]);
	tmp[1] = cos(X[7]);
	tmp[2] = U[0] - X[9];
	tmp[3] = tmp[1]*tmp[2];
	tmp[4] = U[2] - X[11];
	tmp[5] = sin(X[6]);
	tmp[6] = sin(X[8]);
	tmp[7] = tmp[5]*tmp[6];
	tmp[8] = sin(X[7]);
	tmp[9] = cos(X[6]);
	tmp[10] = tmp[0]*tmp[9];
	tmp[11] = tmp[10]*tmp[8] + tmp[7];
	tmp[12] = U[1] - X[10];
	tmp[13] = tmp[6]*tmp[9];
	tmp[14] = tmp[0]*tmp[5];
	tmp[15] = -tmp[13] + tmp[14]*tmp[8];
	tmp[16] = tmp[0]*tmp[3] + tmp[11]*tmp[4] + tmp[12]*tmp[15];
	tmp[17] = dt*tmp[16];
	tmp[18] = tmp[10] + tmp[7]*tmp[8];
	tmp[19] = -tmp[13]*tmp[8] + tmp[14];
	tmp[20] = tmp[12]*tmp[18] - tmp[19]*tmp[4] + tmp[3]*tmp[6];
	tmp[21] = dt*tmp[20];
	tmp[22] = tmp[12]*tmp[5];
	tmp[23] = tmp[4]*tmp[9];
	tmp[24] = tmp[1]*tmp[22] + tmp[1]*tmp[23] - tmp[2]*tmp[8];
	tmp[25] = tan(X[7]);
	tmp[26] = U[4] - X[13];
	tmp[27] = tmp[26]*tmp[5];
	tmp[28] = U[5] - X[14];
	tmp[29] = tmp[28]*tmp[9];
	tmp[30] = tmp[26]*tmp[9] - tmp[28]*tmp[5];
	tmp[31] = dt*tmp[30];
	tmp[32] = 1.0/tmp[1];
	tmp[33] = tmp[27] + tmp[29];
	tmp[34] = dt*tmp[33];
	tmp[35] = dt*tmp[0];
	tmp[36] = tmp[1]*tmp[35];
	tmp[37] = dt*tmp[11];
	tmp[38] = dt*tmp[15];
	tmp[39] = tmp[24]*tmp[35];
	tmp[40] = tmp[11]*tmp[12] - tmp[15]*tmp[4];
	tmp[41] = dt*tmp[40];
	tmp[42] = P[48]*dt;
	tmp[43] = tmp[0]*tmp[1];
	tmp[44] = tmp[42]*tmp[43];
	tmp[45] = P[69]*dt;
	tmp[46] = tmp[11]*tmp[45];
	tmp[47] = P[58]*dt;
	tmp[48] = tmp[15]*tmp[47];
	tmp[49] = P[39]*tmp[21];
	tmp[50] = P[49]*dt;
	tmp[51] = P[70]*dt;
	tmp[52] = P[59]*dt;
	tmp[53] = -P[18];
	tmp[54] = P[50]*dt;
	tmp[55] = P[71]*dt;
	tmp[56] = P[60]*dt;
	tmp[57] = pow(tmp[1], 2);
	tmp[58] = pow(dt, 2);
	tmp[59] = Q_diag[0]*tmp[58];
	tmp[60] = tmp[57]*tmp[59];
	tmp[61] = Q_diag[2]*tmp[58];
	tmp[62] = Q_diag[1]*tmp[58];
	tmp[63] = P[48] + P[51]*dt*tmp[40] + P[52]*dt*tmp[0]*tmp[24] - P[53]*tmp[21] - P[54]*tmp[36] - P[64]*tmp[38] - P[75]*tmp[37];
	tmp[64] = P[69] + P[72]*dt*tmp[40] + P[73]*dt*tmp[0]*tmp[24] - P[74]*tmp[21] - P[75]*tmp[36] - P[76]*tmp[38] - P[77]*tmp[37];
	tmp[65] = P[58] + P[61]*dt*tmp[40] + P[62]*dt*tmp[0]*tmp[24] - P[63]*tmp[21] - P[64]*tmp[36] - P[65]*tmp[38] - P[76]*tmp[37];
	tmp[66] = -P[39];
	tmp[67] = dt*tmp[6];
	tmp[68] = tmp[1]*tmp[67];
	tmp[69] = dt*tmp[18];
	tmp[70] = dt*tmp[19];
	tmp[71] = tmp[24]*tmp[67];
	tmp[72] = tmp[12]*tmp[19] + tmp[18]*tmp[4];
	tmp[73] = dt*tmp[72];
	tmp[74] = tmp[1]*tmp[6];
	tmp[75] = P[13] - P[24]*tmp[73] + P[31]*tmp[71] + P[39]*tmp[17] - tmp[18]*tmp[47] + tmp[19]*tmp[45] - tmp[42]*tmp[74];
	tmp[76] = P[14] - P[25]*tmp[73] + P[32]*tmp[71] + P[40]*tmp[17] - tmp[18]*tmp[52] + tmp[19]*tmp[51] - tmp[50]*tmp[74];
	tmp[77] = P[25] - P[27]*tmp[73] + P[34]*tmp[71] + P[42]*tmp[17] - P[51]*tmp[68] - P[61]*tmp[69] + P[72]*tmp[70];
	tmp[78] = P[70] - P[72]*tmp[73] + P[73]*tmp[71] + P[74]*tmp[17] - P[75]*tmp[68] - P[76]*tmp[69] + P[77]*tmp[70];
	tmp[79] = P[59] - P[61]*tmp[73] + P[62]*tmp[71] + P[63]*tmp[17] - P[64]*tmp[68] - P[65]*tmp[69] + P[76]*tmp[70];
	tmp[80] = P[40] - P[42]*tmp[73] + P[43]*tmp[71] + P[44]*tmp[17] - P[53]*tmp[68] - P[63]*tmp[69] + P[74]*tmp[70];
	tmp[81] = P[32] - P[34]*tmp[73] + P[35]*tmp[71] + P[43]*tmp[17] - P[52]*tmp[68] - P[62]*tmp[69] + P[73]*tmp[70];
	tmp[82] = P[49] - P[51]*tmp[73] + P[52]*tmp[71] + P[53]*tmp[17] - P[54]*tmp[68] - P[64]*tmp[69] + P[75]*tmp[70];
	tmp[83] = dt*tmp[8];
	tmp[84] = dt*tmp[5];
	tmp[85] = tmp[1]*tmp[84];
	tmp[86] = dt*tmp[9];
	tmp[87] = tmp[1]*tmp[86];
	tmp[88] = tmp[12]*tmp[9] - tmp[4]*tmp[5];
	tmp[89] = tmp[1]*tmp[88];
	tmp[90] = dt*tmp[89];
	tmp[91] = tmp[22]*tmp[8] + tmp[23]*tmp[8] + tmp[3];
	tmp[92] = dt*tmp[91];
	tmp[93] = tmp[1]*tmp[5];
	tmp[94] = tmp[47]*tmp[93];
	tmp[95] = tmp[1]*tmp[9];
	tmp[96] = tmp[45]*tmp[95];
	tmp[97] = P[31]*tmp[92];
	tmp[98] = tmp[52]*tmp[93];
	tmp[99] = tmp[51]*tmp[95];
	tmp[100] = P[32]*tmp[92];
	tmp[101] = P[20] + P[26]*tmp[90] - P[33]*tmp[92] + tmp[54]*tmp[8] - tmp[55]*tmp[95] - tmp[56]*tmp[93];
	tmp[102] = tmp[59]*tmp[8];
	tmp[103] = P[50] + P[51]*tmp[90] - P[52]*tmp[92] + P[54]*tmp[83] - P[64]*tmp[85] - P[75]*tmp[87];
	tmp[104] = P[71] + P[72]*tmp[90] - P[73]*tmp[92] + P[75]*tmp[83] - P[76]*tmp[85] - P[77]*tmp[87];
	tmp[105] = P[60] + P[61]*tmp[90] - P[62]*tmp[92] + P[64]*tmp[83] - P[65]*tmp[85] - P[76]*tmp[87];
	tmp[106] = P[33] + P[34]*tmp[90] - P[35]*tmp[92] + P[52]*tmp[83] - P[62]*tmp[85] - P[73]*tmp[87];
	tmp[107] = P[26] + P[27]*tmp[90] - P[34]*tmp[92] + P[51]*tmp[83] - P[61]*tmp[85] - P[72]*tmp[87];
	tmp[108] = P[41] + P[42]*tmp[90] - P[43]*tmp[92] + P[53]*tmp[83] - P[63]*tmp[85] - P[74]*tmp[87];
	tmp[109] = pow(tmp[5], 2);
	tmp[110] = pow(tmp[9], 2);
	tmp[111] = tmp[25]*tmp[86];
	tmp[112] = tmp[25]*tmp[84];
	tmp[113] = tmp[25]*tmp[31] + 1;
	tmp[114] = pow(tmp[25], 2);
	tmp[115] = tmp[114] + 1;
	tmp[116] = P[81]*dt;
	tmp[117] = P[108]*dt;
	tmp[118] = tmp[25]*tmp[9];
	tmp[119] = P[94]*dt;
	tmp[120] = tmp[25]*tmp[5];
	tmp[121] = tmp[115]*tmp[34];
	tmp[122] = -P[24]*tmp[113] - P[31]*tmp[121] + tmp[116] + tmp[117]*tmp[118] + tmp[119]*tmp[120];
	tmp[123] = P[82]*dt;
	tmp[124] = P[109]*dt;
	tmp[125] = P[95]*dt;
	tmp[126] = -P[25]*tmp[113] - P[32]*tmp[121] + tmp[118]*tmp[124] + tmp[120]*tmp[125] + tmp[123];
	tmp[127] = P[83]*dt;
	tmp[128] = P[110]*dt;
	tmp[129] = P[96]*dt;
	tmp[130] = -P[26]*tmp[113] - P[33]*tmp[121] + tmp[118]*tmp[128] + tmp[120]*tmp[129] + tmp[127];
	tmp[131] = P[84]*dt;
	tmp[132] = P[34]*tmp[34];
	tmp[133] = P[111]*tmp[111] - P[27]*tmp[113] + P[97]*tmp[112] - tmp[115]*tmp[132] + tmp[131];
	tmp[134] = P[113]*tmp[111] - P[42]*tmp[113] - P[43]*tmp[121] + P[86]*dt + P[99]*tmp[112];
	tmp[135] = P[89]*dt;
	tmp[136] = P[102]*tmp[112] + P[116]*tmp[111] - P[72]*tmp[113] - P[73]*tmp[121] + tmp[135];
	tmp[137] = P[88]*dt;
	tmp[138] = P[101]*tmp[112] + P[115]*tmp[111] - P[61]*tmp[113] - P[62]*tmp[121] + tmp[137];
	tmp[139] = P[85]*dt;
	tmp[140] = P[112]*tmp[111] - P[34]*tmp[113] - P[35]*tmp[121] + P[98]*tmp[112] + tmp[139];
	tmp[141] = P[87]*dt;
	tmp[142] = P[100]*tmp[112] + P[114]*tmp[111] - P[51]*tmp[113] - P[52]*tmp[121] + tmp[141];
	tmp[143] = Q_diag[4]*tmp[58];
	tmp[144] = tmp[109]*tmp[143];
	tmp[145] = Q_diag[5]*tmp[58];
	tmp[146] = tmp[110]*tmp[145];
	tmp[147] = P[103]*dt;
	tmp[148] = P[117]*dt;
	tmp[149] = tmp[139]*tmp[33];
	tmp[150] = -P[84]*tmp[113] + P[90]*dt - tmp[115]*tmp[149] + tmp[118]*tmp[148] + tmp[120]*tmp[147];
	tmp[151] = P[118]*tmp[86];
	tmp[152] = P[104]*tmp[112] - P[97]*tmp[113] - P[98]*tmp[121] + tmp[147] + tmp[151]*tmp[25];
	tmp[153] = P[118]*tmp[84];
	tmp[154] = -P[111]*tmp[113] - P[112]*tmp[121] + P[119]*tmp[111] + tmp[148] + tmp[153]*tmp[25];
	tmp[155] = -P[24]*tmp[34] + P[31] + tmp[117]*tmp[5] - tmp[119]*tmp[9];
	tmp[156] = -P[25]*tmp[34] + P[32] + tmp[124]*tmp[5] - tmp[125]*tmp[9];
	tmp[157] = tmp[129]*tmp[9];
	tmp[158] = P[26]*tmp[34];
	tmp[159] = P[111]*tmp[84] - P[27]*tmp[34] + P[34] - P[97]*tmp[86];
	tmp[160] = P[102]*tmp[86];
	tmp[161] = -P[116]*tmp[84] + P[72]*tmp[34] - P[73] + tmp[160];
	tmp[162] = P[115]*tmp[84];
	tmp[163] = P[101]*tmp[86] + P[61]*tmp[34] - P[62] - tmp[162];
	tmp[164] = P[113]*tmp[84] - P[42]*tmp[34] + P[43] - P[99]*tmp[86];
	tmp[165] = P[112]*tmp[84] + P[35] - P[98]*tmp[86] - tmp[132];
	tmp[166] = P[100]*tmp[86] - P[114]*tmp[84] + P[51]*tmp[34] - P[52];
	tmp[167] = -tmp[166];
	tmp[168] = -tmp[163];
	tmp[169] = -tmp[161];
	tmp[170] = P[117]*dt*tmp[5] + P[85] - tmp[131]*tmp[33] - tmp[147]*tmp[9];
	tmp[171] = P[104]*tmp[86] - P[118]*dt*tmp[5] + P[97]*tmp[34] - P[98];
	tmp[172] = -tmp[171];
	tmp[173] = P[111]*tmp[34] - P[112] - P[119]*dt*tmp[5] + tmp[151];
	tmp[174] = -tmp[173];
	tmp[175] = tmp[32]*tmp[86];
	tmp[176] = tmp[32]*tmp[84];
	tmp[177] = tmp[31]*tmp[32];
	tmp[178] = 1.0/tmp[57];
	tmp[179] = tmp[178]*tmp[8];
	tmp[180] = tmp[179]*tmp[34];
	tmp[181] = tmp[32]*tmp[9];
	tmp[182] = tmp[117]*tmp[181];
	tmp[183] = tmp[32]*tmp[5];
	tmp[184] = tmp[119]*tmp[183];
	tmp[185] = P[25]*tmp[177] + P[32]*tmp[180] + P[40] - tmp[124]*tmp[181] - tmp[125]*tmp[183];
	tmp[186] = tmp[128]*tmp[181];
	tmp[187] = tmp[129]*tmp[183];
	tmp[188] = -P[100]*tmp[176] - P[114]*tmp[175] + P[51]*tmp[177] + P[52]*tmp[180] + P[53];
	tmp[189] = -P[102]*tmp[176] - P[116]*tmp[175] + P[72]*tmp[177] + P[73]*tmp[180] + P[74];
	tmp[190] = -P[101]*tmp[176] - P[115]*tmp[175] + P[61]*tmp[177] + P[62]*tmp[180] + P[63];
	tmp[191] = P[112]*tmp[175];
	tmp[192] = P[98]*tmp[176];
	tmp[193] = P[34]*tmp[177] + P[35]*tmp[180] + P[43] - tmp[191] - tmp[192];
	tmp[194] = -P[111]*tmp[175] + P[27]*tmp[177] + P[42] - P[97]*tmp[176] + tmp[132]*tmp[179];
	tmp[195] = -P[113]*tmp[175] + P[42]*tmp[177] + P[43]*tmp[180] + P[44] - P[99]*tmp[176];
	tmp[196] = tmp[25]*tmp[32];
	tmp[197] = P[84]*tmp[177] + P[86] - tmp[147]*tmp[183] - tmp[148]*tmp[181] + tmp[149]*tmp[179];
	tmp[198] = -P[104]*tmp[176] + P[97]*tmp[177] + P[98]*tmp[180] + P[99] - tmp[151]*tmp[32];
	tmp[199] = P[111]*tmp[177] + P[112]*tmp[180] + P[113] - P[119]*tmp[175] - tmp[153]*tmp[32];
	X_new[0] = X[0] + X[3]*dt;
	X_new[1] = X[1] + X[4]*dt;
	X_new[2] = X[2] + X[5]*dt;
	X_new[3] = X[3] + tmp[17];
	X_new[4] = X[4] + tmp[21];
	X_new[5] = X[5] + dt*(tmp[24] + 9.8100000000000005);
	X_new[6] = X[6] + dt*(U[3] - X[12] + tmp[25]*tmp[27] + tmp[25]*tmp[29]);
	X_new[7] = X[7] + tmp[31];
	X_new[8] = X[8] + tmp[32]*tmp[34];
	X_new[9] = X[9];
	X_new[10] = X[10];
	X_new[11] = X[11];
	X_new[12] = X[12];
	X_new[13] = X[13];
	X_new[14] = X[14];
	P_new[0] = P[0] + P[6]*dt + dt*(P[6] + P[9]*dt);
	P_new[1] = P[10]*dt + P[1] + dt*(P[13]*dt + P[7]);
	P_new[2] = P[11]*dt + P[2] + dt*(P[11] + P[14]*dt);
	P_new[3] = P[15]*dt + P[3] + dt*(P[18]*dt + P[8]);
	P_new[4] = P[16]*dt + P[4] + dt*(P[12] + P[19]*dt);
	P_new[5] = P[17]*dt + P[5] + dt*(P[17] + P[20]*dt);
	P_new[6] = P[21]*tmp[41] + P[28]*tmp[39] - P[36]*tmp[21] - P[45]*tmp[36] - P[55]*tmp[38] - P[66]*tmp[37] + P[6] + dt*(P[24]*dt*tmp[40] + P[31]*dt*tmp[0]*tmp[24] + P[9] - tmp[44] - tmp[46] - tmp[48] - tmp[49]);
	P_new[7] = P[22]*tmp[41] + P[29]*tmp[39] - P[37]*tmp[21] - P[46]*tmp[36] - P[56]*tmp[38] - P[67]*tmp[37] + P[7] + dt*(P[13] + P[25]*dt*tmp[40] + P[32]*dt*tmp[0]*tmp[24] - P[40]*tmp[21] - tmp[11]*tmp[51] - tmp[15]*tmp[52] - tmp[43]*tmp[50]);
	P_new[8] = P[23]*tmp[41] + P[30]*tmp[39] - P[38]*tmp[21] - P[47]*tmp[36] - P[57]*tmp[38] - P[68]*tmp[37] + P[8] + dt*(P[26]*dt*tmp[40] + P[33]*dt*tmp[0]*tmp[24] - P[41]*tmp[21] - tmp[11]*tmp[55] - tmp[15]*tmp[56] - tmp[43]*tmp[54] - tmp[53]);
	P_new[9] = P[24]*tmp[41] + P[31]*tmp[39] + P[9] + pow(tmp[0], 2)*tmp[60] + pow(tmp[11], 2)*tmp[61] + pow(tmp[15], 2)*tmp[62] - tmp[21]*(P[42]*dt*tmp[40] + P[43]*dt*tmp[0]*tmp[24] - P[44]*tmp[21] - P[53]*tmp[36] - P[63]*tmp[38] - P[74]*tmp[37] - tmp[66]) - tmp[36]*tmp[63] - tmp[37]*tmp[64] - tmp[38]*tmp[65] + tmp[39]*(P[31] + P[34]*dt*tmp[40] + P[35]*dt*tmp[0]*tmp[24] - P[43]*tmp[21] - P[52]*tmp[36] - P[62]*tmp[38] - P[73]*tmp[37]) + tmp[41]*(P[24] + P[27]*dt*tmp[40] + P[34]*dt*tmp[0]*tmp[24] - P[42]*tmp[21] - P[51]*tmp[36] - P[61]*tmp[38] - P[72]*tmp[37]) - tmp[44] - tmp[46] - tmp[48] - tmp[49];
	P_new[10] = P[10] - P[21]*tmp[73] + P[28]*tmp[71] + P[36]*tmp[17] - P[45]*tmp[68] - P[55]*tmp[69] + P[66]*tmp[70] + dt*tmp[75];
	P_new[11] = P[11] - P[22]*tmp[73] + P[29]*tmp[71] + P[37]*tmp[17] - P[46]*tmp[68] - P[56]*tmp[69] + P[67]*tmp[70] + dt*tmp[76];
	P_new[12] = P[12] - P[23]*tmp[73] + P[30]*tmp[71] + P[38]*tmp[17] - P[47]*tmp[68] - P[57]*tmp[69] + P[68]*tmp[70] + dt*(P[19] - P[26]*tmp[73] + P[33]*tmp[71] + P[41]*tmp[17] - tmp[18]*tmp[56] + tmp[19]*tmp[55] - tmp[54]*tmp[74]);
	P_new[13] = tmp[0]*tmp[60]*tmp[6] - tmp[11]*tmp[19]*tmp[61] + tmp[15]*tmp[18]*tmp[62] - tmp[21]*tmp[80] - tmp[36]*tmp[82] - tmp[37]*tmp[78] - tmp[38]*tmp[79] + tmp[39]*tmp[81] + tmp[41]*tmp[77] + tmp[75];
	P_new[14] = tmp[17]*tmp[80] + pow(tmp[18], 2)*tmp[62] + pow(tmp[19], 2)*tmp[61] + tmp[60]*pow(tmp[6], 2) - tmp[68]*tmp[82] - tmp[69]*tmp[79] + tmp[70]*tmp[78] + tmp[71]*tmp[81] - tmp[73]*tmp[77] + tmp[76];
	P_new[15] = P[15] + P[21]*tmp[90] - P[28]*tmp[92] + P[45]*tmp[83] - P[55]*tmp[85] - P[66]*tmp[87] + dt*(P[18] + P[24]*tmp[90] + tmp[42]*tmp[8] - tmp[94] - tmp[96] - tmp[97]);
	P_new[16] = P[16] + P[22]*tmp[90] - P[29]*tmp[92] + P[46]*tmp[83] - P[56]*tmp[85] - P[67]*tmp[87] + dt*(P[19] + P[25]*tmp[90] - tmp[100] + tmp[50]*tmp[8] - tmp[98] - tmp[99]);
	P_new[17] = P[17] + P[23]*tmp[90] - P[30]*tmp[92] + P[47]*tmp[83] - P[57]*tmp[85] - P[68]*tmp[87] + dt*tmp[101];
	P_new[18] = P[24]*dt*tmp[1]*tmp[88] + P[48]*dt*tmp[8] + Q_diag[1]*tmp[15]*tmp[1]*tmp[58]*tmp[5] + Q_diag[2]*tmp[11]*tmp[1]*tmp[58]*tmp[9] + dt*tmp[0]*tmp[106]*tmp[24] + dt*tmp[107]*tmp[40] - tmp[102]*tmp[43] - tmp[103]*tmp[36] - tmp[104]*tmp[37] - tmp[105]*tmp[38] - tmp[108]*tmp[21] - tmp[53] - tmp[94] - tmp[96] - tmp[97];
	P_new[19] = P[19] + P[25]*dt*tmp[1]*tmp[88] + P[49]*dt*tmp[8] + Q_diag[1]*tmp[18]*tmp[1]*tmp[58]*tmp[5] + dt*tmp[104]*tmp[19] + dt*tmp[106]*tmp[24]*tmp[6] + dt*tmp[108]*tmp[16] - tmp[100] - tmp[102]*tmp[74] - tmp[103]*tmp[68] - tmp[105]*tmp[69] - tmp[107]*tmp[73] - tmp[19]*tmp[61]*tmp[95] - tmp[98] - tmp[99];
	P_new[20] = tmp[101] + tmp[103]*tmp[83] - tmp[104]*tmp[87] - tmp[105]*tmp[85] - tmp[106]*tmp[92] + tmp[107]*tmp[90] + tmp[109]*tmp[57]*tmp[62] + tmp[110]*tmp[57]*tmp[61] + tmp[59]*pow(tmp[8], 2);
	P_new[21] = -P[105]*tmp[111] + P[21]*tmp[113] + P[28]*dt*tmp[115]*tmp[33] - P[78]*dt - P[91]*tmp[112] - dt*tmp[122];
	P_new[22] = -P[106]*tmp[111] + P[22]*tmp[113] + P[29]*dt*tmp[115]*tmp[33] - P[79]*dt - P[92]*tmp[112] - dt*tmp[126];
	P_new[23] = -P[107]*tmp[111] + P[23]*tmp[113] + P[30]*dt*tmp[115]*tmp[33] - P[80]*dt - P[93]*tmp[112] - dt*tmp[130];
	P_new[24] = dt*tmp[0]*tmp[142]*tmp[1] + dt*tmp[11]*tmp[136] + dt*tmp[134]*tmp[20] + dt*tmp[138]*tmp[15] - tmp[122] - tmp[133]*tmp[41] - tmp[140]*tmp[39];
	P_new[25] = dt*tmp[133]*tmp[72] + dt*tmp[138]*tmp[18] + dt*tmp[142]*tmp[1]*tmp[6] - tmp[126] - tmp[134]*tmp[17] - tmp[136]*tmp[70] - tmp[140]*tmp[71];
	P_new[26] = dt*tmp[136]*tmp[1]*tmp[9] + dt*tmp[138]*tmp[1]*tmp[5] + dt*tmp[140]*tmp[91] - tmp[130] - tmp[133]*tmp[90] - tmp[142]*tmp[83];
	P_new[27] = Q_diag[3]*tmp[58] + dt*tmp[150] + tmp[111]*tmp[154] + tmp[112]*tmp[152] - tmp[113]*tmp[133] + tmp[114]*tmp[144] + tmp[114]*tmp[146] - tmp[121]*tmp[140];
	P_new[28] = P[105]*tmp[84] - P[21]*tmp[34] + P[28] - P[91]*tmp[86] + dt*tmp[155];
	P_new[29] = P[106]*tmp[84] - P[22]*tmp[34] + P[29] - P[92]*tmp[86] + dt*tmp[156];
	P_new[30] = P[107]*tmp[84] - P[23]*tmp[34] + P[30] - P[93]*tmp[86] + dt*(P[33] + tmp[128]*tmp[5] - tmp[157] - tmp[158]);
	P_new[31] = tmp[155] + tmp[159]*tmp[41] + tmp[161]*tmp[37] + tmp[163]*tmp[38] - tmp[164]*tmp[21] + tmp[165]*tmp[39] + tmp[166]*tmp[36];
	P_new[32] = tmp[156] - tmp[159]*tmp[73] - tmp[161]*tmp[70] + tmp[163]*tmp[69] + tmp[164]*tmp[17] + tmp[165]*tmp[71] + tmp[166]*tmp[68];
	P_new[33] = P[110]*dt*tmp[5] + P[33] + dt*tmp[159]*tmp[1]*tmp[88] + dt*tmp[167]*tmp[8] - tmp[157] - tmp[158] - tmp[165]*tmp[92] - tmp[168]*tmp[85] - tmp[169]*tmp[87];
	P_new[34] = Q_diag[4]*tmp[25]*tmp[58]*tmp[5]*tmp[9] + dt*tmp[115]*tmp[165]*tmp[33] - dt*tmp[170] - tmp[111]*tmp[174] - tmp[112]*tmp[172] + tmp[113]*tmp[159] - tmp[118]*tmp[145]*tmp[5];
	P_new[35] = tmp[109]*tmp[145] + tmp[110]*tmp[143] - tmp[159]*tmp[34] + tmp[165] + tmp[171]*tmp[86] - tmp[173]*tmp[84];
	P_new[36] = -P[105]*tmp[175] + P[21]*tmp[177] + P[28]*tmp[180] + P[36] - P[91]*tmp[176] + dt*(P[24]*tmp[177] + P[31]*tmp[180] + P[39] - tmp[182] - tmp[184]);
	P_new[37] = -P[106]*tmp[175] + P[22]*tmp[177] + P[29]*tmp[180] + P[37] - P[92]*tmp[176] + dt*tmp[185];
	P_new[38] = -P[107]*tmp[175] + P[23]*tmp[177] + P[30]*tmp[180] + P[38] - P[93]*tmp[176] + dt*(P[26]*tmp[177] + P[33]*tmp[180] + P[41] - tmp[186] - tmp[187]);
	P_new[39] = P[24]*dt*tmp[30]*tmp[32] + P[31]*dt*tmp[178]*tmp[33]*tmp[8] + dt*tmp[0]*tmp[193]*tmp[24] + dt*tmp[194]*tmp[40] - tmp[182] - tmp[184] - tmp[188]*tmp[36] - tmp[189]*tmp[37] - tmp[190]*tmp[38] - tmp[195]*tmp[21] - tmp[66];
	P_new[40] = tmp[17]*tmp[195] + tmp[185] - tmp[188]*tmp[68] + tmp[189]*tmp[70] - tmp[190]*tmp[69] + tmp[193]*tmp[71] - tmp[194]*tmp[73];
	P_new[41] = P[26]*dt*tmp[30]*tmp[32] + P[33]*dt*tmp[178]*tmp[33]*tmp[8] + P[41] + dt*tmp[188]*tmp[8] + dt*tmp[194]*tmp[1]*tmp[88] - tmp[186] - tmp[187] - tmp[189]*tmp[87] - tmp[190]*tmp[85] - tmp[193]*tmp[92];
	P_new[42] = -dt*tmp[197] - tmp[111]*tmp[199] - tmp[112]*tmp[198] + tmp[113]*tmp[194] + tmp[121]*tmp[193] + tmp[144]*tmp[196] + tmp[146]*tmp[196];
	P_new[43] = P[34]*dt*tmp[30]*tmp[32] + P[35]*dt*tmp[178]*tmp[33]*tmp[8] + P[43] + Q_diag[4]*tmp[32]*tmp[58]*tmp[5]*tmp[9] + dt*tmp[199]*tmp[5] - tmp[145]*tmp[181]*tmp[5] - tmp[191] - tmp[192] - tmp[194]*tmp[34] - tmp[198]*tmp[86];
	P_new[44] = tmp[144]*tmp[178] + tmp[146]*tmp[178] - tmp[175]*tmp[199] - tmp[176]*tmp[198] + tmp[177]*tmp[194] + tmp[180]*tmp[193] + tmp[195];
	P_new[45] = P[45] + tmp[42];
	P_new[46] = P[46] + tmp[50];
	P_new[47] = P[47] + tmp[54];
	P_new[48] = tmp[63];
	P_new[49] = tmp[82];
	P_new[50] = tmp[103];
	P_new[51] = -tmp[142];
	P_new[52] = tmp[167];
	P_new[53] = tmp[188];
	P_new[54] = P[54];
	P_new[55] = P[55] + tmp[47];
	P_new[56] = P[56] + tmp[52];
	P_new[57] = P[57] + tmp[56];
	P_new[58] = tmp[65];
	P_new[59] = tmp[79];
	P_new[60] = tmp[105];
	P_new[61] = -tmp[138];
	P_new[62] = tmp[168];
	P_new[63] = tmp[190];
	P_new[64] = P[64];
	P_new[65] = P[65];
	P_new[66] = P[66] + tmp[45];
	P_new[67] = P[67] + tmp[51];
	P_new[68] = P[68] + tmp[55];
	P_new[69] = tmp[64];
	P_new[70] = tmp[78];
	P_new[71] = tmp[104];
	P_new[72] = -tmp[136];
	P_new[73] = tmp[169];
	P_new[74] = tmp[189];
	P_new[75] = P[75];
	P_new[76] = P[76];
	P_new[77] = P[77];
	P_new[78] = P[78] + tmp[116];
	P_new[79] = P[79] + tmp[123];
	P_new[80] = P[80] + tmp[127];
	P_new[81] = P[81] + P[84]*dt*tmp[40] + P[85]*dt*tmp[0]*tmp[24] - P[86]*tmp[21] - tmp[11]*tmp[135] - tmp[137]*tmp[15] - tmp[141]*tmp[43];
	P_new[82] = P[82] + P[86]*tmp[17] - tmp[131]*tmp[72] + tmp[135]*tmp[19] - tmp[137]*tmp[18] + tmp[139]*tmp[24]*tmp[6] - tmp[141]*tmp[74];
	P_new[83] = P[83] + tmp[131]*tmp[89] - tmp[135]*tmp[95] - tmp[137]*tmp[93] - tmp[139]*tmp[91] + tmp[141]*tmp[8];
	P_new[84] = -tmp[150];
	P_new[85] = tmp[170];
	P_new[86] = tmp[197];
	P_new[87] = P[87];
	P_new[88] = P[88];
	P_new[89] = P[89];
	P_new[90] = P[90];
	P_new[91] = P[91] + tmp[119];
	P_new[92] = P[92] + tmp[125];
	P_new[93] = P[93] + tmp[129];
	P_new[94] = -P[100]*tmp[36] - P[101]*tmp[38] - P[102]*tmp[37] + P[94] + P[97]*dt*tmp[40] + P[98]*dt*tmp[0]*tmp[24] - P[99]*tmp[21];
	P_new[95] = -P[100]*tmp[68] - P[101]*tmp[69] + P[102]*tmp[70] + P[95] - P[97]*tmp[73] + P[98]*tmp[71] + P[99]*tmp[17];
	P_new[96] = P[100]*tmp[83] - P[101]*tmp[85] + P[96] + P[97]*tmp[90] - P[98]*tmp[92] - tmp[160]*tmp[1];
	P_new[97] = -tmp[152];
	P_new[98] = tmp[172];
	P_new[99] = tmp[198];
	P_new[100] = P[100];
	P_new[101] = P[101];
	P_new[102] = P[102];
	P_new[103] = P[103];
	P_new[104] = P[104];
	P_new[105] = P[105] + tmp[117];
	P_new[106] = P[106] + tmp[124];
	P_new[107] = P[107] + tmp[128];
	P_new[108] = P[108] + P[111]*dt*tmp[40] + P[112]*dt*tmp[0]*tmp[24] - P[113]*tmp[21] - P[114]*tmp[36] - P[115]*tmp[38] - P[116]*tmp[37];
	P_new[109] = P[109] - P[111]*tmp[73] + P[112]*tmp[71] + P[113]*tmp[17] - P[114]*tmp[68] - P[115]*tmp[69] + P[116]*tmp[70];
	P_new[110] = P[110] + P[111]*tmp[90] - P[112]*tmp[92] + P[114]*tmp[83] - P[116]*tmp[87] - tmp[162]*tmp[1];
	P_new[111] = -tmp[154];
	P_new[112] = tmp[174];
	P_new[113] = tmp[199];
	P_new[114] = P[114];
	P_new[115] = P[115];
	P_new[116] = P[116];
	P_new[117] = P[117];
	P_new[118] = P[118];
	P_new[119] = P[119];

    // swap X, X_new and P, P_new pointers
    swap_ptr = X;
    X = X_new;
    X_new = swap_ptr;

    swap_ptr = P;
    P = P_new;
    P_new = swap_ptr;
}

void ekf_update(float Z[N_MEASUREMENTS]) {
    // UPDATE STEP X_new, P_new = ...
    tmp[0] = X[8] - Z[3];
	tmp[1] = 1.0/(P[0] + R_diag[0]);
	tmp[2] = P[1]*tmp[1];
	tmp[3] = P[36]*tmp[2] - P[37];
	tmp[4] = -tmp[3];
	tmp[5] = 1.0/(-pow(P[1], 2)*tmp[1] + P[2] + R_diag[1]);
	tmp[6] = P[3]*tmp[1];
	tmp[7] = P[1]*tmp[6];
	tmp[8] = -P[4] + tmp[7];
	tmp[9] = -tmp[8];
	tmp[10] = pow(P[3], 2)*tmp[1] - P[5] - R_diag[2] + tmp[5]*pow(tmp[9], 2);
	tmp[11] = -1/tmp[10];
	tmp[12] = P[36]*tmp[6] - P[38] + tmp[4]*tmp[5]*tmp[9];
	tmp[13] = -tmp[12];
	tmp[14] = tmp[11]*pow(tmp[13], 2);
	tmp[15] = pow(P[36], 2)*tmp[1] - P[44] - R_diag[3] + tmp[14] + pow(tmp[4], 2)*tmp[5];
	tmp[16] = 1.0/tmp[15];
	tmp[17] = 1.0/tmp[10];
	tmp[18] = P[1]*tmp[5];
	tmp[19] = -1/tmp[15];
	tmp[20] = tmp[11]*tmp[13];
	tmp[21] = tmp[20]*tmp[9] + tmp[3];
	tmp[22] = -tmp[21];
	tmp[23] = tmp[19]*tmp[22];
	tmp[24] = P[0]*tmp[1];
	tmp[25] = P[36] - P[3]*tmp[20] + tmp[18]*tmp[21];
	tmp[26] = tmp[19]*tmp[25];
	tmp[27] = X[2] - Z[2];
	tmp[28] = pow(tmp[12], 2)*tmp[16]*tmp[17] + 1;
	tmp[29] = tmp[12]*tmp[16]*tmp[3] - tmp[28]*tmp[8];
	tmp[30] = tmp[13]*tmp[19];
	tmp[31] = tmp[14]*tmp[19] + 1;
	tmp[32] = tmp[30]*tmp[4] - tmp[31]*tmp[9];
	tmp[33] = -P[36]*tmp[30] + P[3]*tmp[31] + tmp[18]*tmp[32];
	tmp[34] = tmp[11]*tmp[33];
	tmp[35] = P[4] + tmp[21]*tmp[30] - tmp[7];
	tmp[36] = tmp[35]*tmp[5];
	tmp[37] = tmp[11]*tmp[36]*tmp[9] - tmp[19]*tmp[21]*tmp[4]*tmp[5] + 1;
	tmp[38] = -tmp[37];
	tmp[39] = P[36]*tmp[19];
	tmp[40] = P[3]*tmp[11];
	tmp[41] = P[1]*tmp[37] + tmp[21]*tmp[39] - tmp[35]*tmp[40];
	tmp[42] = tmp[1]*tmp[41];
	tmp[43] = tmp[5]*(X[1] - Z[1]);
	tmp[44] = -P[1]*tmp[4]*tmp[5] + P[36] + tmp[20]*(-P[3] + tmp[18]*tmp[9]);
	tmp[45] = -tmp[44];
	tmp[46] = -P[1]*tmp[5]*tmp[9] + P[3] + tmp[30]*tmp[45];
	tmp[47] = tmp[19]*tmp[45];
	tmp[48] = -tmp[46];
	tmp[49] = tmp[11]*tmp[48];
	tmp[50] = P[1] + tmp[47]*tmp[4] + tmp[49]*tmp[9];
	tmp[51] = tmp[50]*tmp[5];
	tmp[52] = tmp[2]*tmp[51];
	tmp[53] = -P[36]*tmp[19]*tmp[1]*tmp[45] - P[3]*tmp[11]*tmp[1]*tmp[48] + tmp[52] + 1;
	tmp[54] = -tmp[53];
	tmp[55] = tmp[1]*(X[0] - Z[0]);
	tmp[56] = P[2]*tmp[5];
	tmp[57] = P[4]*tmp[17];
	tmp[58] = P[2]*tmp[51];
	tmp[59] = P[38]*tmp[16];
	tmp[60] = P[4]*tmp[5];
	tmp[61] = tmp[12]*tmp[17];
	tmp[62] = P[5]*tmp[17];
	tmp[63] = -P[4]*tmp[51];
	tmp[64] = P[39]*tmp[16];
	tmp[65] = P[7]*tmp[5];
	tmp[66] = P[6]*tmp[1];
	tmp[67] = P[8]*tmp[17];
	tmp[68] = -P[7]*tmp[51];
	tmp[69] = P[11]*tmp[5];
	tmp[70] = P[10]*tmp[1];
	tmp[71] = P[11]*tmp[51];
	tmp[72] = P[16]*tmp[5];
	tmp[73] = P[15]*tmp[1];
	tmp[74] = P[16]*tmp[51];
	tmp[75] = P[22]*tmp[5];
	tmp[76] = P[21]*tmp[1];
	tmp[77] = P[22]*tmp[51];
	tmp[78] = P[29]*tmp[5];
	tmp[79] = P[28]*tmp[1];
	tmp[80] = P[29]*tmp[51];
	tmp[81] = P[37]*tmp[19];
	tmp[82] = tmp[5]*tmp[81];
	tmp[83] = tmp[1]*tmp[39];
	tmp[84] = P[36]*tmp[1];
	tmp[85] = P[37]*tmp[51];
	tmp[86] = P[46]*tmp[5];
	tmp[87] = P[45]*tmp[1];
	tmp[88] = P[46]*tmp[51];
	tmp[89] = P[56]*tmp[5];
	tmp[90] = P[55]*tmp[1];
	tmp[91] = P[56]*tmp[51];
	tmp[92] = P[67]*tmp[5];
	tmp[93] = P[66]*tmp[1];
	tmp[94] = P[67]*tmp[51];
	tmp[95] = P[79]*tmp[5];
	tmp[96] = P[78]*tmp[1];
	tmp[97] = P[79]*tmp[51];
	tmp[98] = P[92]*tmp[5];
	tmp[99] = P[91]*tmp[1];
	tmp[100] = P[92]*tmp[51];
	tmp[101] = P[106]*tmp[5];
	tmp[102] = P[105]*tmp[1];
	tmp[103] = P[106]*tmp[51];
	tmp[104] = -tmp[25];
	tmp[105] = -tmp[33];
	tmp[106] = -tmp[41];
	tmp[107] = P[37] - P[4]*tmp[20] + tmp[104]*tmp[2] + tmp[21]*tmp[56];
	tmp[108] = -P[37]*tmp[30] + P[4]*tmp[31] + tmp[105]*tmp[2] + tmp[32]*tmp[56];
	tmp[109] = P[4]*tmp[11];
	tmp[110] = tmp[21]*tmp[82] - 1;
	tmp[111] = tmp[106]*tmp[2]*tmp[5] - tmp[109]*tmp[36] + tmp[110] + tmp[37]*tmp[56];
	tmp[112] = P[1]*tmp[53] + P[37]*tmp[47] + P[4]*tmp[49] - tmp[58];
	tmp[113] = P[38] - P[5]*tmp[20] + tmp[104]*tmp[6] + tmp[21]*tmp[60];
	tmp[114] = P[38]*tmp[11];
	tmp[115] = -tmp[114]*tmp[30];
	tmp[116] = P[5]*tmp[11];
	tmp[117] = tmp[105]*tmp[11]*tmp[6] + tmp[109]*tmp[32]*tmp[5] + tmp[115] + tmp[116]*tmp[31] - 1;
	tmp[118] = P[38]*tmp[19];
	tmp[119] = P[4]*tmp[37] + tmp[106]*tmp[6] - tmp[116]*tmp[35] + tmp[118]*tmp[21];
	tmp[120] = P[38]*tmp[47] + P[3]*tmp[53] + P[5]*tmp[49] + tmp[63];
	tmp[121] = P[39] - P[8]*tmp[20] + tmp[104]*tmp[66] + tmp[21]*tmp[65];
	tmp[122] = -P[39]*tmp[30] + P[8]*tmp[31] + tmp[105]*tmp[66] + tmp[32]*tmp[65];
	tmp[123] = P[39]*tmp[19];
	tmp[124] = P[8]*tmp[11];
	tmp[125] = P[7]*tmp[37] + tmp[106]*tmp[66] + tmp[123]*tmp[21] - tmp[124]*tmp[35];
	tmp[126] = P[39]*tmp[47] + P[6]*tmp[53] + P[8]*tmp[49] + tmp[68];
	tmp[127] = -P[12]*tmp[20] + P[40] + tmp[104]*tmp[70] + tmp[21]*tmp[69];
	tmp[128] = P[12]*tmp[31] - P[40]*tmp[30] + tmp[105]*tmp[70] + tmp[32]*tmp[69];
	tmp[129] = P[40]*tmp[19];
	tmp[130] = P[12]*tmp[11];
	tmp[131] = P[11]*tmp[37] + tmp[106]*tmp[70] + tmp[129]*tmp[21] - tmp[130]*tmp[35];
	tmp[132] = P[10]*tmp[53] + P[12]*tmp[49] + P[40]*tmp[47] - tmp[71];
	tmp[133] = -P[17]*tmp[20] + P[41] + tmp[104]*tmp[73] + tmp[21]*tmp[72];
	tmp[134] = P[17]*tmp[31] - P[41]*tmp[30] + tmp[105]*tmp[73] + tmp[32]*tmp[72];
	tmp[135] = P[41]*tmp[19];
	tmp[136] = P[17]*tmp[11];
	tmp[137] = P[16]*tmp[37] + tmp[106]*tmp[73] + tmp[135]*tmp[21] - tmp[136]*tmp[35];
	tmp[138] = P[15]*tmp[53] + P[17]*tmp[49] + P[41]*tmp[47] - tmp[74];
	tmp[139] = -P[23]*tmp[20] + P[42] + tmp[104]*tmp[76] + tmp[21]*tmp[75];
	tmp[140] = P[23]*tmp[31] - P[42]*tmp[30] + tmp[105]*tmp[76] + tmp[32]*tmp[75];
	tmp[141] = P[42]*tmp[19];
	tmp[142] = P[23]*tmp[11];
	tmp[143] = P[22]*tmp[37] + tmp[106]*tmp[76] + tmp[141]*tmp[21] - tmp[142]*tmp[35];
	tmp[144] = P[21]*tmp[53] + P[23]*tmp[49] + P[42]*tmp[47] - tmp[77];
	tmp[145] = -P[30]*tmp[20] + P[43] + tmp[104]*tmp[79] + tmp[21]*tmp[78];
	tmp[146] = P[30]*tmp[31] - P[43]*tmp[30] + tmp[105]*tmp[79] + tmp[32]*tmp[78];
	tmp[147] = P[43]*tmp[19];
	tmp[148] = P[30]*tmp[11];
	tmp[149] = P[29]*tmp[37] + tmp[106]*tmp[79] + tmp[147]*tmp[21] - tmp[148]*tmp[35];
	tmp[150] = P[28]*tmp[53] + P[30]*tmp[49] + P[43]*tmp[47] - tmp[80];
	tmp[151] = P[44]*tmp[19];
	tmp[152] = tmp[104]*tmp[83] + tmp[110] + tmp[115] + tmp[151];
	tmp[153] = P[37]*tmp[5];
	tmp[154] = P[38]*tmp[31] + tmp[105]*tmp[84] - tmp[13]*tmp[151] + tmp[153]*tmp[32];
	tmp[155] = P[37]*tmp[37] + tmp[106]*tmp[84] - tmp[114]*tmp[35] + tmp[151]*tmp[21];
	tmp[156] = P[36]*tmp[53] + P[38]*tmp[49] + tmp[151]*tmp[45] - tmp[85];
	tmp[157] = -P[47]*tmp[20] + P[53] + tmp[104]*tmp[87] + tmp[21]*tmp[86];
	tmp[158] = P[47]*tmp[31] - P[53]*tmp[30] + tmp[105]*tmp[87] + tmp[32]*tmp[86];
	tmp[159] = P[53]*tmp[19];
	tmp[160] = P[47]*tmp[11];
	tmp[161] = P[46]*tmp[37] + tmp[106]*tmp[87] + tmp[159]*tmp[21] - tmp[160]*tmp[35];
	tmp[162] = P[45]*tmp[53] + P[47]*tmp[49] + P[53]*tmp[47] - tmp[88];
	tmp[163] = -P[57]*tmp[20] + P[63] + tmp[104]*tmp[90] + tmp[21]*tmp[89];
	tmp[164] = P[57]*tmp[31] - P[63]*tmp[30] + tmp[105]*tmp[90] + tmp[32]*tmp[89];
	tmp[165] = P[63]*tmp[19];
	tmp[166] = P[57]*tmp[11];
	tmp[167] = P[56]*tmp[37] + tmp[106]*tmp[90] + tmp[165]*tmp[21] - tmp[166]*tmp[35];
	tmp[168] = P[55]*tmp[53] + P[57]*tmp[49] + P[63]*tmp[47] - tmp[91];
	tmp[169] = -P[68]*tmp[20] + P[74] + tmp[104]*tmp[93] + tmp[21]*tmp[92];
	tmp[170] = P[68]*tmp[31] - P[74]*tmp[30] + tmp[105]*tmp[93] + tmp[32]*tmp[92];
	tmp[171] = P[74]*tmp[19];
	tmp[172] = P[68]*tmp[11];
	tmp[173] = P[67]*tmp[37] + tmp[106]*tmp[93] + tmp[171]*tmp[21] - tmp[172]*tmp[35];
	tmp[174] = P[66]*tmp[53] + P[68]*tmp[49] + P[74]*tmp[47] - tmp[94];
	tmp[175] = -P[80]*tmp[20] + P[86] + tmp[104]*tmp[96] + tmp[21]*tmp[95];
	tmp[176] = P[80]*tmp[31] - P[86]*tmp[30] + tmp[105]*tmp[96] + tmp[32]*tmp[95];
	tmp[177] = P[86]*tmp[19];
	tmp[178] = P[80]*tmp[11];
	tmp[179] = P[79]*tmp[37] + tmp[106]*tmp[96] + tmp[177]*tmp[21] - tmp[178]*tmp[35];
	tmp[180] = P[78]*tmp[53] + P[80]*tmp[49] + P[86]*tmp[47] - tmp[97];
	tmp[181] = -P[93]*tmp[20] + P[99] + tmp[104]*tmp[99] + tmp[21]*tmp[98];
	tmp[182] = P[93]*tmp[31] - P[99]*tmp[30] + tmp[105]*tmp[99] + tmp[32]*tmp[98];
	tmp[183] = P[99]*tmp[19];
	tmp[184] = P[93]*tmp[11];
	tmp[185] = P[92]*tmp[37] + tmp[106]*tmp[99] + tmp[183]*tmp[21] - tmp[184]*tmp[35];
	tmp[186] = P[91]*tmp[53] + P[93]*tmp[49] + P[99]*tmp[47] - tmp[100];
	tmp[187] = -P[107]*tmp[20] + P[113] + tmp[101]*tmp[21] + tmp[102]*tmp[104];
	tmp[188] = P[107]*tmp[31] - P[113]*tmp[30] + tmp[101]*tmp[32] + tmp[102]*tmp[105];
	tmp[189] = P[113]*tmp[19];
	tmp[190] = P[107]*tmp[11];
	tmp[191] = P[106]*tmp[37] + tmp[102]*tmp[106] + tmp[189]*tmp[21] - tmp[190]*tmp[35];
	tmp[192] = P[105]*tmp[53] + P[107]*tmp[49] + P[113]*tmp[47] - tmp[103];
	X_new[0] = X[0] - tmp[0]*(-P[36]*tmp[16] + P[3]*tmp[12]*tmp[16]*tmp[17] - tmp[18]*tmp[23] - tmp[24]*tmp[26]) - tmp[27]*(P[1]*tmp[17]*tmp[29]*tmp[5] + P[36]*tmp[12]*tmp[16]*tmp[17] - P[3]*tmp[17]*tmp[28] - tmp[24]*tmp[34]) - tmp[43]*(-P[0]*tmp[42] - P[1]*tmp[38] + P[36]*tmp[16]*tmp[22] + P[3]*tmp[17]*tmp[35]) - tmp[55]*(-P[0]*tmp[54] + P[36]*tmp[16]*tmp[44] + P[3]*tmp[17]*tmp[46] - tmp[18]*tmp[50]);
	X_new[1] = X[1] - tmp[0]*(-P[37]*tmp[16] + P[4]*tmp[12]*tmp[16]*tmp[17] - tmp[23]*tmp[56] - tmp[26]*tmp[2]) - tmp[27]*(P[2]*tmp[17]*tmp[29]*tmp[5] + P[37]*tmp[12]*tmp[16]*tmp[17] - tmp[28]*tmp[57] - tmp[2]*tmp[34]) - tmp[43]*(-P[2]*tmp[38] + P[37]*tmp[16]*tmp[22] + P[4]*tmp[17]*tmp[35] - tmp[2]*tmp[41]) - tmp[55]*(-P[1]*tmp[54] + P[37]*tmp[16]*tmp[44] + P[4]*tmp[17]*tmp[46] - tmp[58]);
	X_new[2] = X[2] - tmp[0]*(P[5]*tmp[12]*tmp[16]*tmp[17] - tmp[23]*tmp[60] - tmp[26]*tmp[6] - tmp[59]) - tmp[27]*(-tmp[28]*tmp[62] + tmp[29]*tmp[57]*tmp[5] - tmp[34]*tmp[6] + tmp[59]*tmp[61]) - tmp[43]*(-P[4]*tmp[38] + tmp[22]*tmp[59] + tmp[35]*tmp[62] - tmp[41]*tmp[6]) - tmp[55]*(-P[3]*tmp[54] + tmp[44]*tmp[59] + tmp[46]*tmp[62] + tmp[63]);
	X_new[3] = X[3] - tmp[0]*(P[8]*tmp[12]*tmp[16]*tmp[17] - tmp[23]*tmp[65] - tmp[26]*tmp[66] - tmp[64]) - tmp[27]*(tmp[17]*tmp[29]*tmp[65] - tmp[28]*tmp[67] - tmp[34]*tmp[66] + tmp[61]*tmp[64]) - tmp[43]*(-P[6]*tmp[42] - P[7]*tmp[38] + tmp[22]*tmp[64] + tmp[35]*tmp[67]) - tmp[55]*(-P[6]*tmp[54] + tmp[44]*tmp[64] + tmp[46]*tmp[67] + tmp[68]);
	X_new[4] = X[4] - tmp[0]*(P[12]*tmp[12]*tmp[16]*tmp[17] - P[40]*tmp[16] - tmp[23]*tmp[69] - tmp[26]*tmp[70]) - tmp[27]*(P[11]*tmp[17]*tmp[29]*tmp[5] - P[12]*tmp[17]*tmp[28] + P[40]*tmp[12]*tmp[16]*tmp[17] - tmp[34]*tmp[70]) - tmp[43]*(-P[10]*tmp[42] - P[11]*tmp[38] + P[12]*tmp[17]*tmp[35] + P[40]*tmp[16]*tmp[22]) - tmp[55]*(-P[10]*tmp[54] + P[12]*tmp[17]*tmp[46] + P[40]*tmp[16]*tmp[44] - tmp[71]);
	X_new[5] = X[5] - tmp[0]*(P[17]*tmp[12]*tmp[16]*tmp[17] - P[41]*tmp[16] - tmp[23]*tmp[72] - tmp[26]*tmp[73]) - tmp[27]*(P[16]*tmp[17]*tmp[29]*tmp[5] - P[17]*tmp[17]*tmp[28] + P[41]*tmp[12]*tmp[16]*tmp[17] - tmp[34]*tmp[73]) - tmp[43]*(-P[15]*tmp[42] - P[16]*tmp[38] + P[17]*tmp[17]*tmp[35] + P[41]*tmp[16]*tmp[22]) - tmp[55]*(-P[15]*tmp[54] + P[17]*tmp[17]*tmp[46] + P[41]*tmp[16]*tmp[44] - tmp[74]);
	X_new[6] = X[6] - tmp[0]*(P[23]*tmp[12]*tmp[16]*tmp[17] - P[42]*tmp[16] - tmp[23]*tmp[75] - tmp[26]*tmp[76]) - tmp[27]*(P[22]*tmp[17]*tmp[29]*tmp[5] - P[23]*tmp[17]*tmp[28] + P[42]*tmp[12]*tmp[16]*tmp[17] - tmp[34]*tmp[76]) - tmp[43]*(-P[21]*tmp[42] - P[22]*tmp[38] + P[23]*tmp[17]*tmp[35] + P[42]*tmp[16]*tmp[22]) - tmp[55]*(-P[21]*tmp[54] + P[23]*tmp[17]*tmp[46] + P[42]*tmp[16]*tmp[44] - tmp[77]);
	X_new[7] = X[7] - tmp[0]*(P[30]*tmp[12]*tmp[16]*tmp[17] - P[43]*tmp[16] - tmp[23]*tmp[78] - tmp[26]*tmp[79]) - tmp[27]*(P[29]*tmp[17]*tmp[29]*tmp[5] - P[30]*tmp[17]*tmp[28] + P[43]*tmp[12]*tmp[16]*tmp[17] - tmp[34]*tmp[79]) - tmp[43]*(-P[28]*tmp[42] - P[29]*tmp[38] + P[30]*tmp[17]*tmp[35] + P[43]*tmp[16]*tmp[22]) - tmp[55]*(-P[28]*tmp[54] + P[30]*tmp[17]*tmp[46] + P[43]*tmp[16]*tmp[44] - tmp[80]);
	X_new[8] = X[8] - tmp[0]*(P[38]*tmp[12]*tmp[16]*tmp[17] - P[44]*tmp[16] - tmp[22]*tmp[82] - tmp[25]*tmp[83]) - tmp[27]*(P[37]*tmp[17]*tmp[29]*tmp[5] - P[38]*tmp[17]*tmp[28] + P[44]*tmp[12]*tmp[16]*tmp[17] - tmp[34]*tmp[84]) - tmp[43]*(-P[36]*tmp[42] - P[37]*tmp[38] + P[38]*tmp[17]*tmp[35] + P[44]*tmp[16]*tmp[22]) - tmp[55]*(-P[36]*tmp[54] + P[38]*tmp[17]*tmp[46] + P[44]*tmp[16]*tmp[44] - tmp[85]);
	X_new[9] = X[9] - tmp[0]*(P[47]*tmp[12]*tmp[16]*tmp[17] - P[53]*tmp[16] - tmp[23]*tmp[86] - tmp[26]*tmp[87]) - tmp[27]*(P[46]*tmp[17]*tmp[29]*tmp[5] - P[47]*tmp[17]*tmp[28] + P[53]*tmp[12]*tmp[16]*tmp[17] - tmp[34]*tmp[87]) - tmp[43]*(-P[45]*tmp[42] - P[46]*tmp[38] + P[47]*tmp[17]*tmp[35] + P[53]*tmp[16]*tmp[22]) - tmp[55]*(-P[45]*tmp[54] + P[47]*tmp[17]*tmp[46] + P[53]*tmp[16]*tmp[44] - tmp[88]);
	X_new[10] = X[10] - tmp[0]*(P[57]*tmp[12]*tmp[16]*tmp[17] - P[63]*tmp[16] - tmp[23]*tmp[89] - tmp[26]*tmp[90]) - tmp[27]*(P[56]*tmp[17]*tmp[29]*tmp[5] - P[57]*tmp[17]*tmp[28] + P[63]*tmp[12]*tmp[16]*tmp[17] - tmp[34]*tmp[90]) - tmp[43]*(-P[55]*tmp[42] - P[56]*tmp[38] + P[57]*tmp[17]*tmp[35] + P[63]*tmp[16]*tmp[22]) - tmp[55]*(-P[55]*tmp[54] + P[57]*tmp[17]*tmp[46] + P[63]*tmp[16]*tmp[44] - tmp[91]);
	X_new[11] = X[11] - tmp[0]*(P[68]*tmp[12]*tmp[16]*tmp[17] - P[74]*tmp[16] - tmp[23]*tmp[92] - tmp[26]*tmp[93]) - tmp[27]*(P[67]*tmp[17]*tmp[29]*tmp[5] - P[68]*tmp[17]*tmp[28] + P[74]*tmp[12]*tmp[16]*tmp[17] - tmp[34]*tmp[93]) - tmp[43]*(-P[66]*tmp[42] - P[67]*tmp[38] + P[68]*tmp[17]*tmp[35] + P[74]*tmp[16]*tmp[22]) - tmp[55]*(-P[66]*tmp[54] + P[68]*tmp[17]*tmp[46] + P[74]*tmp[16]*tmp[44] - tmp[94]);
	X_new[12] = X[12] - tmp[0]*(P[80]*tmp[12]*tmp[16]*tmp[17] - P[86]*tmp[16] - tmp[23]*tmp[95] - tmp[26]*tmp[96]) - tmp[27]*(P[79]*tmp[17]*tmp[29]*tmp[5] - P[80]*tmp[17]*tmp[28] + P[86]*tmp[12]*tmp[16]*tmp[17] - tmp[34]*tmp[96]) - tmp[43]*(-P[78]*tmp[42] - P[79]*tmp[38] + P[80]*tmp[17]*tmp[35] + P[86]*tmp[16]*tmp[22]) - tmp[55]*(-P[78]*tmp[54] + P[80]*tmp[17]*tmp[46] + P[86]*tmp[16]*tmp[44] - tmp[97]);
	X_new[13] = X[13] - tmp[0]*(P[93]*tmp[12]*tmp[16]*tmp[17] - P[99]*tmp[16] - tmp[23]*tmp[98] - tmp[26]*tmp[99]) - tmp[27]*(P[92]*tmp[17]*tmp[29]*tmp[5] - P[93]*tmp[17]*tmp[28] + P[99]*tmp[12]*tmp[16]*tmp[17] - tmp[34]*tmp[99]) - tmp[43]*(-P[91]*tmp[42] - P[92]*tmp[38] + P[93]*tmp[17]*tmp[35] + P[99]*tmp[16]*tmp[22]) - tmp[55]*(-P[91]*tmp[54] + P[93]*tmp[17]*tmp[46] + P[99]*tmp[16]*tmp[44] - tmp[100]);
	X_new[14] = X[14] - tmp[0]*(P[107]*tmp[12]*tmp[16]*tmp[17] - P[113]*tmp[16] - tmp[101]*tmp[23] - tmp[102]*tmp[26]) - tmp[27]*(P[106]*tmp[17]*tmp[29]*tmp[5] - P[107]*tmp[17]*tmp[28] + P[113]*tmp[12]*tmp[16]*tmp[17] - tmp[102]*tmp[34]) - tmp[43]*(-P[105]*tmp[42] - P[106]*tmp[38] + P[107]*tmp[17]*tmp[35] + P[113]*tmp[16]*tmp[22]) - tmp[55]*(-P[105]*tmp[54] + P[107]*tmp[17]*tmp[46] + P[113]*tmp[16]*tmp[44] - tmp[103]);
	P_new[0] = -P[0]*(tmp[24]*tmp[53] + tmp[47]*tmp[84] + tmp[49]*tmp[6] - tmp[52] - 1) - tmp[18]*(tmp[106]*tmp[24] + tmp[41]) - tmp[39]*(tmp[104]*tmp[24] + tmp[25]) - tmp[40]*(tmp[105]*tmp[24] + tmp[33]);
	P_new[1] = -P[1]*tmp[111] - tmp[107]*tmp[39] - tmp[108]*tmp[40] - tmp[112]*tmp[24];
	P_new[2] = -P[2]*tmp[111] - tmp[107]*tmp[81] - tmp[108]*tmp[109] - tmp[112]*tmp[2];
	P_new[3] = -P[3]*tmp[117] - tmp[113]*tmp[39] - tmp[119]*tmp[18] - tmp[120]*tmp[24];
	P_new[4] = -P[4]*tmp[117] - tmp[113]*tmp[81] - tmp[119]*tmp[56] - tmp[120]*tmp[2];
	P_new[5] = -P[5]*tmp[117] - tmp[113]*tmp[118] - tmp[119]*tmp[60] - tmp[120]*tmp[6];
	P_new[6] = P[6] - tmp[121]*tmp[39] - tmp[122]*tmp[40] - tmp[125]*tmp[18] - tmp[126]*tmp[24];
	P_new[7] = P[7] - tmp[109]*tmp[122] - tmp[121]*tmp[81] - tmp[125]*tmp[56] - tmp[126]*tmp[2];
	P_new[8] = P[8] - tmp[116]*tmp[122] - tmp[118]*tmp[121] - tmp[125]*tmp[60] - tmp[126]*tmp[6];
	P_new[9] = P[9] - tmp[121]*tmp[123] - tmp[122]*tmp[124] - tmp[125]*tmp[65] - tmp[126]*tmp[66];
	P_new[10] = P[10] - tmp[127]*tmp[39] - tmp[128]*tmp[40] - tmp[131]*tmp[18] - tmp[132]*tmp[24];
	P_new[11] = P[11] - tmp[109]*tmp[128] - tmp[127]*tmp[81] - tmp[131]*tmp[56] - tmp[132]*tmp[2];
	P_new[12] = P[12] - tmp[116]*tmp[128] - tmp[118]*tmp[127] - tmp[131]*tmp[60] - tmp[132]*tmp[6];
	P_new[13] = P[13] - tmp[123]*tmp[127] - tmp[124]*tmp[128] - tmp[131]*tmp[65] - tmp[132]*tmp[66];
	P_new[14] = P[14] - tmp[127]*tmp[129] - tmp[128]*tmp[130] - tmp[131]*tmp[69] - tmp[132]*tmp[70];
	P_new[15] = P[15] - tmp[133]*tmp[39] - tmp[134]*tmp[40] - tmp[137]*tmp[18] - tmp[138]*tmp[24];
	P_new[16] = P[16] - tmp[109]*tmp[134] - tmp[133]*tmp[81] - tmp[137]*tmp[56] - tmp[138]*tmp[2];
	P_new[17] = P[17] - tmp[116]*tmp[134] - tmp[118]*tmp[133] - tmp[137]*tmp[60] - tmp[138]*tmp[6];
	P_new[18] = P[18] - tmp[123]*tmp[133] - tmp[124]*tmp[134] - tmp[137]*tmp[65] - tmp[138]*tmp[66];
	P_new[19] = P[19] - tmp[129]*tmp[133] - tmp[130]*tmp[134] - tmp[137]*tmp[69] - tmp[138]*tmp[70];
	P_new[20] = P[20] - tmp[133]*tmp[135] - tmp[134]*tmp[136] - tmp[137]*tmp[72] - tmp[138]*tmp[73];
	P_new[21] = P[21] - tmp[139]*tmp[39] - tmp[140]*tmp[40] - tmp[143]*tmp[18] - tmp[144]*tmp[24];
	P_new[22] = P[22] - tmp[109]*tmp[140] - tmp[139]*tmp[81] - tmp[143]*tmp[56] - tmp[144]*tmp[2];
	P_new[23] = P[23] - tmp[116]*tmp[140] - tmp[118]*tmp[139] - tmp[143]*tmp[60] - tmp[144]*tmp[6];
	P_new[24] = P[24] - tmp[123]*tmp[139] - tmp[124]*tmp[140] - tmp[143]*tmp[65] - tmp[144]*tmp[66];
	P_new[25] = P[25] - tmp[129]*tmp[139] - tmp[130]*tmp[140] - tmp[143]*tmp[69] - tmp[144]*tmp[70];
	P_new[26] = P[26] - tmp[135]*tmp[139] - tmp[136]*tmp[140] - tmp[143]*tmp[72] - tmp[144]*tmp[73];
	P_new[27] = P[27] - tmp[139]*tmp[141] - tmp[140]*tmp[142] - tmp[143]*tmp[75] - tmp[144]*tmp[76];
	P_new[28] = P[28] - tmp[145]*tmp[39] - tmp[146]*tmp[40] - tmp[149]*tmp[18] - tmp[150]*tmp[24];
	P_new[29] = P[29] - tmp[109]*tmp[146] - tmp[145]*tmp[81] - tmp[149]*tmp[56] - tmp[150]*tmp[2];
	P_new[30] = P[30] - tmp[116]*tmp[146] - tmp[118]*tmp[145] - tmp[149]*tmp[60] - tmp[150]*tmp[6];
	P_new[31] = P[31] - tmp[123]*tmp[145] - tmp[124]*tmp[146] - tmp[149]*tmp[65] - tmp[150]*tmp[66];
	P_new[32] = P[32] - tmp[129]*tmp[145] - tmp[130]*tmp[146] - tmp[149]*tmp[69] - tmp[150]*tmp[70];
	P_new[33] = P[33] - tmp[135]*tmp[145] - tmp[136]*tmp[146] - tmp[149]*tmp[72] - tmp[150]*tmp[73];
	P_new[34] = P[34] - tmp[141]*tmp[145] - tmp[142]*tmp[146] - tmp[149]*tmp[75] - tmp[150]*tmp[76];
	P_new[35] = P[35] - tmp[145]*tmp[147] - tmp[146]*tmp[148] - tmp[149]*tmp[78] - tmp[150]*tmp[79];
	P_new[36] = -P[36]*tmp[152] - tmp[154]*tmp[40] - tmp[155]*tmp[18] - tmp[156]*tmp[24];
	P_new[37] = -P[37]*tmp[152] - tmp[109]*tmp[154] - tmp[155]*tmp[56] - tmp[156]*tmp[2];
	P_new[38] = -P[38]*tmp[152] - tmp[116]*tmp[154] - tmp[155]*tmp[60] - tmp[156]*tmp[6];
	P_new[39] = -P[39]*tmp[152] - tmp[124]*tmp[154] - tmp[155]*tmp[65] - tmp[156]*tmp[66];
	P_new[40] = -P[40]*tmp[152] - tmp[130]*tmp[154] - tmp[155]*tmp[69] - tmp[156]*tmp[70];
	P_new[41] = -P[41]*tmp[152] - tmp[136]*tmp[154] - tmp[155]*tmp[72] - tmp[156]*tmp[73];
	P_new[42] = -P[42]*tmp[152] - tmp[142]*tmp[154] - tmp[155]*tmp[75] - tmp[156]*tmp[76];
	P_new[43] = -P[43]*tmp[152] - tmp[148]*tmp[154] - tmp[155]*tmp[78] - tmp[156]*tmp[79];
	P_new[44] = -P[44]*tmp[152] - tmp[114]*tmp[154] - tmp[153]*tmp[155] - tmp[156]*tmp[84];
	P_new[45] = P[45] - tmp[157]*tmp[39] - tmp[158]*tmp[40] - tmp[161]*tmp[18] - tmp[162]*tmp[24];
	P_new[46] = P[46] - tmp[109]*tmp[158] - tmp[157]*tmp[81] - tmp[161]*tmp[56] - tmp[162]*tmp[2];
	P_new[47] = P[47] - tmp[116]*tmp[158] - tmp[118]*tmp[157] - tmp[161]*tmp[60] - tmp[162]*tmp[6];
	P_new[48] = P[48] - tmp[123]*tmp[157] - tmp[124]*tmp[158] - tmp[161]*tmp[65] - tmp[162]*tmp[66];
	P_new[49] = P[49] - tmp[129]*tmp[157] - tmp[130]*tmp[158] - tmp[161]*tmp[69] - tmp[162]*tmp[70];
	P_new[50] = P[50] - tmp[135]*tmp[157] - tmp[136]*tmp[158] - tmp[161]*tmp[72] - tmp[162]*tmp[73];
	P_new[51] = P[51] - tmp[141]*tmp[157] - tmp[142]*tmp[158] - tmp[161]*tmp[75] - tmp[162]*tmp[76];
	P_new[52] = P[52] - tmp[147]*tmp[157] - tmp[148]*tmp[158] - tmp[161]*tmp[78] - tmp[162]*tmp[79];
	P_new[53] = P[53] - tmp[114]*tmp[158] - tmp[151]*tmp[157] - tmp[153]*tmp[161] - tmp[162]*tmp[84];
	P_new[54] = P[54] - tmp[157]*tmp[159] - tmp[158]*tmp[160] - tmp[161]*tmp[86] - tmp[162]*tmp[87];
	P_new[55] = P[55] - tmp[163]*tmp[39] - tmp[164]*tmp[40] - tmp[167]*tmp[18] - tmp[168]*tmp[24];
	P_new[56] = P[56] - tmp[109]*tmp[164] - tmp[163]*tmp[81] - tmp[167]*tmp[56] - tmp[168]*tmp[2];
	P_new[57] = P[57] - tmp[116]*tmp[164] - tmp[118]*tmp[163] - tmp[167]*tmp[60] - tmp[168]*tmp[6];
	P_new[58] = P[58] - tmp[123]*tmp[163] - tmp[124]*tmp[164] - tmp[167]*tmp[65] - tmp[168]*tmp[66];
	P_new[59] = P[59] - tmp[129]*tmp[163] - tmp[130]*tmp[164] - tmp[167]*tmp[69] - tmp[168]*tmp[70];
	P_new[60] = P[60] - tmp[135]*tmp[163] - tmp[136]*tmp[164] - tmp[167]*tmp[72] - tmp[168]*tmp[73];
	P_new[61] = P[61] - tmp[141]*tmp[163] - tmp[142]*tmp[164] - tmp[167]*tmp[75] - tmp[168]*tmp[76];
	P_new[62] = P[62] - tmp[147]*tmp[163] - tmp[148]*tmp[164] - tmp[167]*tmp[78] - tmp[168]*tmp[79];
	P_new[63] = P[63] - tmp[114]*tmp[164] - tmp[151]*tmp[163] - tmp[153]*tmp[167] - tmp[168]*tmp[84];
	P_new[64] = P[64] - tmp[159]*tmp[163] - tmp[160]*tmp[164] - tmp[167]*tmp[86] - tmp[168]*tmp[87];
	P_new[65] = P[65] - tmp[163]*tmp[165] - tmp[164]*tmp[166] - tmp[167]*tmp[89] - tmp[168]*tmp[90];
	P_new[66] = P[66] - tmp[169]*tmp[39] - tmp[170]*tmp[40] - tmp[173]*tmp[18] - tmp[174]*tmp[24];
	P_new[67] = P[67] - tmp[109]*tmp[170] - tmp[169]*tmp[81] - tmp[173]*tmp[56] - tmp[174]*tmp[2];
	P_new[68] = P[68] - tmp[116]*tmp[170] - tmp[118]*tmp[169] - tmp[173]*tmp[60] - tmp[174]*tmp[6];
	P_new[69] = P[69] - tmp[123]*tmp[169] - tmp[124]*tmp[170] - tmp[173]*tmp[65] - tmp[174]*tmp[66];
	P_new[70] = P[70] - tmp[129]*tmp[169] - tmp[130]*tmp[170] - tmp[173]*tmp[69] - tmp[174]*tmp[70];
	P_new[71] = P[71] - tmp[135]*tmp[169] - tmp[136]*tmp[170] - tmp[173]*tmp[72] - tmp[174]*tmp[73];
	P_new[72] = P[72] - tmp[141]*tmp[169] - tmp[142]*tmp[170] - tmp[173]*tmp[75] - tmp[174]*tmp[76];
	P_new[73] = P[73] - tmp[147]*tmp[169] - tmp[148]*tmp[170] - tmp[173]*tmp[78] - tmp[174]*tmp[79];
	P_new[74] = P[74] - tmp[114]*tmp[170] - tmp[151]*tmp[169] - tmp[153]*tmp[173] - tmp[174]*tmp[84];
	P_new[75] = P[75] - tmp[159]*tmp[169] - tmp[160]*tmp[170] - tmp[173]*tmp[86] - tmp[174]*tmp[87];
	P_new[76] = P[76] - tmp[165]*tmp[169] - tmp[166]*tmp[170] - tmp[173]*tmp[89] - tmp[174]*tmp[90];
	P_new[77] = P[77] - tmp[169]*tmp[171] - tmp[170]*tmp[172] - tmp[173]*tmp[92] - tmp[174]*tmp[93];
	P_new[78] = P[78] - tmp[175]*tmp[39] - tmp[176]*tmp[40] - tmp[179]*tmp[18] - tmp[180]*tmp[24];
	P_new[79] = P[79] - tmp[109]*tmp[176] - tmp[175]*tmp[81] - tmp[179]*tmp[56] - tmp[180]*tmp[2];
	P_new[80] = P[80] - tmp[116]*tmp[176] - tmp[118]*tmp[175] - tmp[179]*tmp[60] - tmp[180]*tmp[6];
	P_new[81] = P[81] - tmp[123]*tmp[175] - tmp[124]*tmp[176] - tmp[179]*tmp[65] - tmp[180]*tmp[66];
	P_new[82] = P[82] - tmp[129]*tmp[175] - tmp[130]*tmp[176] - tmp[179]*tmp[69] - tmp[180]*tmp[70];
	P_new[83] = P[83] - tmp[135]*tmp[175] - tmp[136]*tmp[176] - tmp[179]*tmp[72] - tmp[180]*tmp[73];
	P_new[84] = P[84] - tmp[141]*tmp[175] - tmp[142]*tmp[176] - tmp[179]*tmp[75] - tmp[180]*tmp[76];
	P_new[85] = P[85] - tmp[147]*tmp[175] - tmp[148]*tmp[176] - tmp[179]*tmp[78] - tmp[180]*tmp[79];
	P_new[86] = P[86] - tmp[114]*tmp[176] - tmp[151]*tmp[175] - tmp[153]*tmp[179] - tmp[180]*tmp[84];
	P_new[87] = P[87] - tmp[159]*tmp[175] - tmp[160]*tmp[176] - tmp[179]*tmp[86] - tmp[180]*tmp[87];
	P_new[88] = P[88] - tmp[165]*tmp[175] - tmp[166]*tmp[176] - tmp[179]*tmp[89] - tmp[180]*tmp[90];
	P_new[89] = P[89] - tmp[171]*tmp[175] - tmp[172]*tmp[176] - tmp[179]*tmp[92] - tmp[180]*tmp[93];
	P_new[90] = P[90] - tmp[175]*tmp[177] - tmp[176]*tmp[178] - tmp[179]*tmp[95] - tmp[180]*tmp[96];
	P_new[91] = P[91] - tmp[181]*tmp[39] - tmp[182]*tmp[40] - tmp[185]*tmp[18] - tmp[186]*tmp[24];
	P_new[92] = P[92] - tmp[109]*tmp[182] - tmp[181]*tmp[81] - tmp[185]*tmp[56] - tmp[186]*tmp[2];
	P_new[93] = P[93] - tmp[116]*tmp[182] - tmp[118]*tmp[181] - tmp[185]*tmp[60] - tmp[186]*tmp[6];
	P_new[94] = P[94] - tmp[123]*tmp[181] - tmp[124]*tmp[182] - tmp[185]*tmp[65] - tmp[186]*tmp[66];
	P_new[95] = P[95] - tmp[129]*tmp[181] - tmp[130]*tmp[182] - tmp[185]*tmp[69] - tmp[186]*tmp[70];
	P_new[96] = P[96] - tmp[135]*tmp[181] - tmp[136]*tmp[182] - tmp[185]*tmp[72] - tmp[186]*tmp[73];
	P_new[97] = P[97] - tmp[141]*tmp[181] - tmp[142]*tmp[182] - tmp[185]*tmp[75] - tmp[186]*tmp[76];
	P_new[98] = P[98] - tmp[147]*tmp[181] - tmp[148]*tmp[182] - tmp[185]*tmp[78] - tmp[186]*tmp[79];
	P_new[99] = P[99] - tmp[114]*tmp[182] - tmp[151]*tmp[181] - tmp[153]*tmp[185] - tmp[186]*tmp[84];
	P_new[100] = P[100] - tmp[159]*tmp[181] - tmp[160]*tmp[182] - tmp[185]*tmp[86] - tmp[186]*tmp[87];
	P_new[101] = P[101] - tmp[165]*tmp[181] - tmp[166]*tmp[182] - tmp[185]*tmp[89] - tmp[186]*tmp[90];
	P_new[102] = P[102] - tmp[171]*tmp[181] - tmp[172]*tmp[182] - tmp[185]*tmp[92] - tmp[186]*tmp[93];
	P_new[103] = P[103] - tmp[177]*tmp[181] - tmp[178]*tmp[182] - tmp[185]*tmp[95] - tmp[186]*tmp[96];
	P_new[104] = P[104] - tmp[181]*tmp[183] - tmp[182]*tmp[184] - tmp[185]*tmp[98] - tmp[186]*tmp[99];
	P_new[105] = P[105] - tmp[187]*tmp[39] - tmp[188]*tmp[40] - tmp[18]*tmp[191] - tmp[192]*tmp[24];
	P_new[106] = P[106] - tmp[109]*tmp[188] - tmp[187]*tmp[81] - tmp[191]*tmp[56] - tmp[192]*tmp[2];
	P_new[107] = P[107] - tmp[116]*tmp[188] - tmp[118]*tmp[187] - tmp[191]*tmp[60] - tmp[192]*tmp[6];
	P_new[108] = P[108] - tmp[123]*tmp[187] - tmp[124]*tmp[188] - tmp[191]*tmp[65] - tmp[192]*tmp[66];
	P_new[109] = P[109] - tmp[129]*tmp[187] - tmp[130]*tmp[188] - tmp[191]*tmp[69] - tmp[192]*tmp[70];
	P_new[110] = P[110] - tmp[135]*tmp[187] - tmp[136]*tmp[188] - tmp[191]*tmp[72] - tmp[192]*tmp[73];
	P_new[111] = P[111] - tmp[141]*tmp[187] - tmp[142]*tmp[188] - tmp[191]*tmp[75] - tmp[192]*tmp[76];
	P_new[112] = P[112] - tmp[147]*tmp[187] - tmp[148]*tmp[188] - tmp[191]*tmp[78] - tmp[192]*tmp[79];
	P_new[113] = P[113] - tmp[114]*tmp[188] - tmp[151]*tmp[187] - tmp[153]*tmp[191] - tmp[192]*tmp[84];
	P_new[114] = P[114] - tmp[159]*tmp[187] - tmp[160]*tmp[188] - tmp[191]*tmp[86] - tmp[192]*tmp[87];
	P_new[115] = P[115] - tmp[165]*tmp[187] - tmp[166]*tmp[188] - tmp[191]*tmp[89] - tmp[192]*tmp[90];
	P_new[116] = P[116] - tmp[171]*tmp[187] - tmp[172]*tmp[188] - tmp[191]*tmp[92] - tmp[192]*tmp[93];
	P_new[117] = P[117] - tmp[177]*tmp[187] - tmp[178]*tmp[188] - tmp[191]*tmp[95] - tmp[192]*tmp[96];
	P_new[118] = P[118] - tmp[183]*tmp[187] - tmp[184]*tmp[188] - tmp[191]*tmp[98] - tmp[192]*tmp[99];
	P_new[119] = P[119] - tmp[101]*tmp[191] - tmp[102]*tmp[192] - tmp[187]*tmp[189] - tmp[188]*tmp[190];

    // swap X, X_new and P, P_new pointers
    swap_ptr = X;
    X = X_new;
    X_new = swap_ptr;

    swap_ptr = P;
    P = P_new;
    P_new = swap_ptr;
}
