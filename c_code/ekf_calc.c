
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// This file is automatically generated in "Generate Kalman Filter C Code.ipynb" from https://github.com/tudelft/kalman_filter   //
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

#include "ekf_calc.h"
#include <math.h>
#include <stdio.h>
#include "common/maths.h"
#include <stdbool.h>

bool ekf_use_quat = false;

float ekf_Q[N_PROC_NOISES];         // Kalman filter process noise covariance matrix (diagonal)

// 2 measurement models: mocap and vbody
float ekf_R_mocap[N_MEASUREMENTS_MOCAP];   // Kalman filter measurement noise covariance matrix (diagonal)
float ekf_R_vbody[N_MEASUREMENTS_VBODY];

// state
float ekf_X[N_STATES];
float ekf_X_new[N_STATES];

// covariance matrix (upper diagonal) P[i,j] = P_upper_diagonal[i*(i+1)/2+j] (if i>=j)
float ekf_P_upper_diagonal[N_STATES*(N_STATES+1)/2];
float ekf_P_upper_diagonal_new[N_STATES*(N_STATES+1)/2];

// gain matrix calculations MOCAP
float ekf_S_full_mocap[N_MEASUREMENTS_MOCAP*N_MEASUREMENTS_MOCAP];
float ekf_S_chol_mocap[N_MEASUREMENTS_MOCAP*N_MEASUREMENTS_MOCAP];
float ekf_S_iDiag_mocap[N_MEASUREMENTS_MOCAP];
float ekf_HP_mocap[N_STATES*N_MEASUREMENTS_MOCAP];
float ekf_K_mocap[N_STATES*N_MEASUREMENTS_MOCAP];

// gain matrix calculations VBODY
float ekf_S_full_vbody[N_MEASUREMENTS_VBODY*N_MEASUREMENTS_VBODY];
float ekf_S_chol_vbody[N_MEASUREMENTS_VBODY*N_MEASUREMENTS_VBODY];
float ekf_S_iDiag_vbody[N_MEASUREMENTS_VBODY];
float ekf_HP_vbody[N_STATES*N_MEASUREMENTS_VBODY];
float ekf_K_vbody[N_STATES*N_MEASUREMENTS_VBODY];

// temporary variables
float tmp[371];

// pointers
float *X = ekf_X;
float *X_new = ekf_X_new;

float *P = ekf_P_upper_diagonal;
float *P_new = ekf_P_upper_diagonal_new;

// MOCAP
float *S_mocap = ekf_S_full_mocap;
float *HP_mocap = ekf_HP_mocap;
float *K_mocap = ekf_K_mocap;

// VBODY
float *S_vbody = ekf_S_full_vbody;
float *HP_vbody = ekf_HP_vbody;
float *K_vbody = ekf_K_vbody;

// renaming
float *Q = ekf_Q;

float *R_mocap = ekf_R_mocap;
float *R_vbody = ekf_R_vbody;

// pointer for swapping
float *swap_ptr;

float* ekf_get_X(void) {
    return X;
}

float* ekf_get_P(void) {
    return P;
}

void ekf_set_Q(float Q[N_INPUTS]) {
    for (int i=0; i<N_PROC_NOISES; i++) {
        ekf_Q[i] = Q[i];
    }
}

// MOCAP
void ekf_set_R_mocap(float R[N_MEASUREMENTS_MOCAP]) {
    for (int i=0; i<N_MEASUREMENTS_MOCAP; i++) {
        ekf_R_mocap[i] = R[i];
    }
}

// VBODY
void ekf_set_R_vbody(float R[N_MEASUREMENTS_VBODY]) {
    for (int i=0; i<N_MEASUREMENTS_VBODY; i++) {
        ekf_R_vbody[i] = R[i];
    }
}

void ekf_set_X(float X0[N_STATES]) {
    for (int i=0; i<N_STATES; i++) {
        X[i] = X0[i];
    }
}

void ekf_set_P_diag(float P_diag[N_STATES]) {
    // set P to zeros
    for (int i=0; i<N_STATES*(N_STATES+1)/2; i++) {
        P[i] = 0.;
    }
    // set diagonal
    for (int i=0; i<N_STATES; i++) {
        P[i*(i+1)/2+i] = P_diag[i];
    }
}

void ekf_predict(float U[N_INPUTS], float dt) {
    // PREDICTION STEP X_new, P_new = ...
    tmp[0] = powf(X[6], 2);
	tmp[1] = powf(X[7], 2);
	tmp[2] = powf(X[8], 2);
	tmp[3] = powf(X[9], 2);
	tmp[4] = tmp[0] + tmp[1] + tmp[2] + tmp[3];
	tmp[5] = powf(tmp[4], -1.0/2.0);
	tmp[6] = U[0] - X[10];
	tmp[7] = tmp[5]*tmp[6];
	tmp[8] = U[2] - X[12];
	tmp[9] = tmp[5]*tmp[8];
	tmp[10] = U[1] - X[11];
	tmp[11] = tmp[10]*tmp[5];
	tmp[12] = X[6]*tmp[7] + X[8]*tmp[9] - X[9]*tmp[11];
	tmp[13] = tmp[12]*tmp[5];
	tmp[14] = X[6]*tmp[9] + X[7]*tmp[11] - X[8]*tmp[7];
	tmp[15] = tmp[14]*tmp[5];
	tmp[16] = X[6]*tmp[11] - X[7]*tmp[9] + X[9]*tmp[7];
	tmp[17] = tmp[16]*tmp[5];
	tmp[18] = -X[7]*tmp[7] - X[8]*tmp[11] - X[9]*tmp[9];
	tmp[19] = tmp[18]*tmp[5];
	tmp[20] = -tmp[12];
	tmp[21] = tmp[20]*tmp[5];
	tmp[22] = 0.5*U[3] - 0.5*X[13];
	tmp[23] = U[4] - X[14];
	tmp[24] = 0.5*X[8];
	tmp[25] = U[5] - X[15];
	tmp[26] = 0.5*X[9];
	tmp[27] = 0.5*X[6];
	tmp[28] = 0.5*X[7];
	tmp[29] = P[6] + P[9]*dt;
	tmp[30] = P[13]*dt;
	tmp[31] = P[10] + tmp[30];
	tmp[32] = P[18]*dt;
	tmp[33] = P[15] + tmp[32];
	tmp[34] = powf(tmp[4], -3.0/2.0);
	tmp[35] = X[6]*tmp[34];
	tmp[36] = X[9]*tmp[35];
	tmp[37] = tmp[16]*tmp[36];
	tmp[38] = X[8]*tmp[35];
	tmp[39] = tmp[14]*tmp[38];
	tmp[40] = tmp[0]*tmp[34];
	tmp[41] = X[7]*tmp[35];
	tmp[42] = tmp[41]*tmp[6];
	tmp[43] = tmp[10]*tmp[35];
	tmp[44] = X[8]*tmp[43];
	tmp[45] = tmp[36]*tmp[8];
	tmp[46] = tmp[42] + tmp[44] + tmp[45];
	tmp[47] = X[7]*tmp[5];
	tmp[48] = -tmp[7];
	tmp[49] = tmp[38]*tmp[8];
	tmp[50] = X[9]*tmp[43];
	tmp[51] = tmp[40]*tmp[6] + tmp[48] + tmp[49] - tmp[50];
	tmp[52] = -tmp[51];
	tmp[53] = X[6]*tmp[5];
	tmp[54] = -tmp[9];
	tmp[55] = X[7]*tmp[43];
	tmp[56] = tmp[38]*tmp[6];
	tmp[57] = -tmp[40]*tmp[8] - tmp[54] - tmp[55] + tmp[56];
	tmp[58] = X[8]*tmp[5];
	tmp[59] = -tmp[11];
	tmp[60] = tmp[36]*tmp[6];
	tmp[61] = tmp[41]*tmp[8];
	tmp[62] = -tmp[10]*tmp[40] - tmp[59] - tmp[60] + tmp[61];
	tmp[63] = X[9]*tmp[5];
	tmp[64] = -tmp[12]*tmp[40] + tmp[13] + tmp[18]*tmp[41] + tmp[37] - tmp[39] - tmp[46]*tmp[47] + tmp[52]*tmp[53] + tmp[57]*tmp[58] - tmp[62]*tmp[63];
	tmp[65] = P[24]*dt;
	tmp[66] = P[21] + tmp[65];
	tmp[67] = dt*tmp[66];
	tmp[68] = X[7]*tmp[34];
	tmp[69] = X[8]*tmp[68];
	tmp[70] = tmp[14]*tmp[69];
	tmp[71] = X[9]*tmp[68];
	tmp[72] = tmp[16]*tmp[71];
	tmp[73] = tmp[69]*tmp[8];
	tmp[74] = tmp[10]*tmp[68];
	tmp[75] = X[9]*tmp[74];
	tmp[76] = tmp[42] + tmp[73] - tmp[75];
	tmp[77] = -tmp[76];
	tmp[78] = X[8]*tmp[74];
	tmp[79] = tmp[1]*tmp[34];
	tmp[80] = tmp[48] + tmp[6]*tmp[79] + tmp[71]*tmp[8] + tmp[78];
	tmp[81] = X[7]*X[8]*tmp[34]*tmp[6] - tmp[10]*tmp[79] - tmp[59] - tmp[61];
	tmp[82] = tmp[6]*tmp[71];
	tmp[83] = tmp[1]*tmp[34]*tmp[8] - tmp[55] - tmp[82] - tmp[9];
	tmp[84] = X[6]*tmp[5]*tmp[77] + X[8]*tmp[5]*tmp[81] - tmp[12]*tmp[41] + tmp[18]*tmp[1]*tmp[34] - tmp[19] - tmp[47]*tmp[80] - tmp[63]*tmp[83] - tmp[70] + tmp[72];
	tmp[85] = P[31]*dt;
	tmp[86] = P[28] + tmp[85];
	tmp[87] = dt*tmp[86];
	tmp[88] = X[8]*X[9];
	tmp[89] = tmp[34]*tmp[88];
	tmp[90] = tmp[12]*tmp[38];
	tmp[91] = tmp[2]*tmp[34];
	tmp[92] = tmp[6]*tmp[89];
	tmp[93] = -tmp[44] + tmp[73] - tmp[92];
	tmp[94] = -X[8]*X[9]*tmp[10]*tmp[34] + tmp[54] + tmp[56] + tmp[8]*tmp[91];
	tmp[95] = -tmp[94];
	tmp[96] = tmp[89]*tmp[8];
	tmp[97] = tmp[10]*tmp[91] + tmp[59] + tmp[69]*tmp[6] + tmp[96];
	tmp[98] = tmp[2]*tmp[34]*tmp[6] - tmp[49] - tmp[78] - tmp[7];
	tmp[99] = -tmp[14]*tmp[91] + tmp[15] + tmp[16]*tmp[89] + tmp[18]*tmp[69] - tmp[47]*tmp[97] + tmp[53]*tmp[95] + tmp[58]*tmp[98] - tmp[63]*tmp[93] - tmp[90];
	tmp[100] = P[39]*dt;
	tmp[101] = P[36] + tmp[100];
	tmp[102] = dt*tmp[101];
	tmp[103] = -tmp[45] - tmp[75] + tmp[92];
	tmp[104] = tmp[34]*tmp[3];
	tmp[105] = tmp[104]*tmp[8] + tmp[10]*tmp[89] + tmp[54] + tmp[82];
	tmp[106] = X[7]*X[9]*tmp[34]*tmp[8] - tmp[104]*tmp[6] - tmp[48] - tmp[50];
	tmp[107] = -tmp[10]*tmp[34]*tmp[3] + tmp[11] + tmp[60] + tmp[96];
	tmp[108] = -tmp[107];
	tmp[109] = X[6]*tmp[108]*tmp[5] + X[7]*X[9]*tmp[18]*tmp[34] + X[8]*tmp[103]*tmp[5] - tmp[105]*tmp[47] - tmp[106]*tmp[63] - tmp[12]*tmp[36] - tmp[14]*tmp[89] + tmp[16]*tmp[34]*tmp[3] - tmp[17];
	tmp[110] = P[48]*dt;
	tmp[111] = P[45] + tmp[110];
	tmp[112] = dt*tmp[111];
	tmp[113] = 1.0/tmp[4];
	tmp[114] = tmp[113]*tmp[1];
	tmp[115] = tmp[113]*tmp[2];
	tmp[116] = -tmp[115];
	tmp[117] = tmp[0]*tmp[113];
	tmp[118] = tmp[113]*tmp[3];
	tmp[119] = tmp[117] - tmp[118];
	tmp[120] = -tmp[114] - tmp[116] - tmp[119];
	tmp[121] = P[58]*dt;
	tmp[122] = P[55] + tmp[121];
	tmp[123] = dt*tmp[122];
	tmp[124] = 2*tmp[113];
	tmp[125] = X[6]*tmp[124];
	tmp[126] = X[9]*tmp[125];
	tmp[127] = X[7]*X[8];
	tmp[128] = tmp[124]*tmp[127];
	tmp[129] = tmp[126] - tmp[128];
	tmp[130] = P[69]*dt;
	tmp[131] = P[66] + tmp[130];
	tmp[132] = dt*tmp[131];
	tmp[133] = X[8]*tmp[125];
	tmp[134] = X[7]*X[9];
	tmp[135] = tmp[124]*tmp[134];
	tmp[136] = -tmp[133] - tmp[135];
	tmp[137] = P[81]*dt;
	tmp[138] = P[78] + tmp[137];
	tmp[139] = dt*tmp[138];
	tmp[140] = tmp[14]*tmp[41];
	tmp[141] = tmp[140] - tmp[16]*tmp[40] + tmp[17] + tmp[18]*tmp[38] + tmp[20]*tmp[36] - tmp[46]*tmp[58] - tmp[47]*tmp[57] - tmp[51]*tmp[63] + tmp[53]*tmp[62];
	tmp[142] = tmp[16]*tmp[41];
	tmp[143] = X[6]*tmp[5]*tmp[83] + X[7]*X[8]*tmp[18]*tmp[34] + X[7]*X[9]*tmp[20]*tmp[34] - tmp[142] + tmp[14]*tmp[1]*tmp[34] - tmp[15] - tmp[47]*tmp[81] - tmp[58]*tmp[80] - tmp[63]*tmp[76];
	tmp[144] = X[6]*tmp[5]*tmp[93] + X[8]*X[9]*tmp[20]*tmp[34] - tmp[16]*tmp[38] + tmp[18]*tmp[2]*tmp[34] - tmp[19] - tmp[47]*tmp[98] - tmp[58]*tmp[97] - tmp[63]*tmp[94] + tmp[70];
	tmp[145] = -X[8]*X[9]*tmp[18]*tmp[34];
	tmp[146] = X[6]*tmp[106]*tmp[5] + X[7]*X[9]*tmp[14]*tmp[34] - tmp[103]*tmp[47] - tmp[105]*tmp[58] - tmp[107]*tmp[63] - tmp[145] + tmp[20]*tmp[34]*tmp[3] - tmp[21] - tmp[37];
	tmp[147] = -tmp[126] - tmp[128];
	tmp[148] = -tmp[114];
	tmp[149] = -tmp[115] - tmp[119] - tmp[148];
	tmp[150] = X[7]*tmp[125];
	tmp[151] = tmp[124]*tmp[88];
	tmp[152] = tmp[150] - tmp[151];
	tmp[153] = -tmp[142] - tmp[14]*tmp[40] + tmp[15] + tmp[18]*tmp[36] - tmp[46]*tmp[63] + tmp[47]*tmp[62] - tmp[52]*tmp[58] + tmp[53]*tmp[57] + tmp[90];
	tmp[154] = tmp[12]*tmp[69] - tmp[140] - tmp[16]*tmp[79] + tmp[17] + tmp[18]*tmp[71] + tmp[47]*tmp[83] + tmp[53]*tmp[81] - tmp[58]*tmp[77] - tmp[63]*tmp[80];
	tmp[155] = X[6]*tmp[5]*tmp[98] + X[7]*tmp[5]*tmp[93] + tmp[12]*tmp[2]*tmp[34] - tmp[13] - tmp[145] - tmp[16]*tmp[69] - tmp[39] - tmp[58]*tmp[95] - tmp[63]*tmp[97];
	tmp[156] = X[6]*tmp[103]*tmp[5] + X[7]*tmp[106]*tmp[5] + X[8]*X[9]*tmp[12]*tmp[34] - tmp[105]*tmp[63] - tmp[108]*tmp[58] - tmp[14]*tmp[36] + tmp[18]*tmp[34]*tmp[3] - tmp[19] - tmp[72];
	tmp[157] = tmp[133] - tmp[135];
	tmp[158] = -tmp[150] - tmp[151];
	tmp[159] = -tmp[116] - tmp[117] - tmp[118] - tmp[148];
	tmp[160] = 0.5*U[3] - 0.5*X[13];
	tmp[161] = -tmp[160];
	tmp[162] = 0.5*U[4] - 0.5*X[14];
	tmp[163] = -tmp[162];
	tmp[164] = 0.5*U[5] - 0.5*X[15];
	tmp[165] = -tmp[164];
	tmp[166] = P[91] + P[94]*dt;
	tmp[167] = dt*tmp[166];
	tmp[168] = P[105] + P[108]*dt;
	tmp[169] = dt*tmp[168];
	tmp[170] = P[120] + P[123]*dt;
	tmp[171] = dt*tmp[170];
	tmp[172] = P[11] + P[14]*dt;
	tmp[173] = P[19]*dt;
	tmp[174] = P[16] + tmp[173];
	tmp[175] = P[70]*dt;
	tmp[176] = P[67] + tmp[175];
	tmp[177] = dt*tmp[176];
	tmp[178] = P[82]*dt;
	tmp[179] = P[79] + tmp[178];
	tmp[180] = dt*tmp[179];
	tmp[181] = P[59]*dt;
	tmp[182] = P[56] + tmp[181];
	tmp[183] = dt*tmp[182];
	tmp[184] = P[25]*dt;
	tmp[185] = P[22] + tmp[184];
	tmp[186] = dt*tmp[185];
	tmp[187] = P[40]*dt;
	tmp[188] = P[37] + tmp[187];
	tmp[189] = dt*tmp[188];
	tmp[190] = P[49]*dt;
	tmp[191] = P[46] + tmp[190];
	tmp[192] = dt*tmp[191];
	tmp[193] = P[32]*dt;
	tmp[194] = P[29] + tmp[193];
	tmp[195] = dt*tmp[194];
	tmp[196] = P[92] + P[95]*dt;
	tmp[197] = dt*tmp[196];
	tmp[198] = P[106] + P[109]*dt;
	tmp[199] = dt*tmp[198];
	tmp[200] = P[121] + P[124]*dt;
	tmp[201] = dt*tmp[200];
	tmp[202] = P[17] + P[20]*dt;
	tmp[203] = P[71]*dt;
	tmp[204] = P[68] + tmp[203];
	tmp[205] = dt*tmp[204];
	tmp[206] = P[83]*dt;
	tmp[207] = P[80] + tmp[206];
	tmp[208] = dt*tmp[207];
	tmp[209] = P[60]*dt;
	tmp[210] = P[57] + tmp[209];
	tmp[211] = dt*tmp[210];
	tmp[212] = P[26]*dt;
	tmp[213] = P[23] + tmp[212];
	tmp[214] = dt*tmp[213];
	tmp[215] = P[41]*dt;
	tmp[216] = P[38] + tmp[215];
	tmp[217] = dt*tmp[216];
	tmp[218] = P[50]*dt;
	tmp[219] = P[47] + tmp[218];
	tmp[220] = dt*tmp[219];
	tmp[221] = P[33]*dt;
	tmp[222] = P[30] + tmp[221];
	tmp[223] = dt*tmp[222];
	tmp[224] = P[93] + P[96]*dt;
	tmp[225] = dt*tmp[224];
	tmp[226] = P[107] + P[110]*dt;
	tmp[227] = dt*tmp[226];
	tmp[228] = P[122] + P[125]*dt;
	tmp[229] = dt*tmp[228];
	tmp[230] = powf(dt, 2);
	tmp[231] = Q[1]*tmp[230];
	tmp[232] = Q[2]*tmp[230];
	tmp[233] = Q[0]*tmp[230];
	tmp[234] = dt*tmp[129];
	tmp[235] = dt*tmp[136];
	tmp[236] = dt*tmp[120];
	tmp[237] = dt*tmp[64];
	tmp[238] = dt*tmp[99];
	tmp[239] = dt*tmp[109];
	tmp[240] = dt*tmp[84];
	tmp[241] = P[81] + P[84]*tmp[237] + P[85]*tmp[240] + P[86]*tmp[238] + P[87]*tmp[239] + P[88]*tmp[236] + P[89]*tmp[234] + P[90]*tmp[235];
	tmp[242] = P[69] + P[72]*tmp[237] + P[73]*tmp[240] + P[74]*tmp[238] + P[75]*tmp[239] + P[76]*tmp[236] + P[77]*tmp[234] + P[89]*tmp[235];
	tmp[243] = P[58] + P[61]*tmp[237] + P[62]*tmp[240] + P[63]*tmp[238] + P[64]*tmp[239] + P[65]*tmp[236] + P[76]*tmp[234] + P[88]*tmp[235];
	tmp[244] = P[24] + P[27]*tmp[237] + P[34]*tmp[240] + P[42]*tmp[238] + P[51]*tmp[239] + P[61]*tmp[236] + P[72]*tmp[234] + P[84]*tmp[235];
	tmp[245] = P[39] + P[42]*tmp[237] + P[43]*tmp[240] + P[44]*tmp[238] + P[53]*tmp[239] + P[63]*tmp[236] + P[74]*tmp[234] + P[86]*tmp[235];
	tmp[246] = P[48] + P[51]*tmp[237] + P[52]*tmp[240] + P[53]*tmp[238] + P[54]*tmp[239] + P[64]*tmp[236] + P[75]*tmp[234] + P[87]*tmp[235];
	tmp[247] = P[31] + P[34]*tmp[237] + P[35]*tmp[240] + P[43]*tmp[238] + P[52]*tmp[239] + P[62]*tmp[236] + P[73]*tmp[234] + P[85]*tmp[235];
	tmp[248] = tmp[136]*tmp[232];
	tmp[249] = tmp[120]*tmp[233];
	tmp[250] = tmp[129]*tmp[231];
	tmp[251] = dt*tmp[241];
	tmp[252] = dt*tmp[243];
	tmp[253] = dt*tmp[242];
	tmp[254] = dt*tmp[244];
	tmp[255] = dt*tmp[247];
	tmp[256] = dt*tmp[246];
	tmp[257] = dt*tmp[245];
	tmp[258] = P[100]*tmp[239] + P[101]*tmp[236] + P[102]*tmp[234] + P[103]*tmp[235] + P[94] + P[97]*tmp[237] + P[98]*tmp[240] + P[99]*tmp[238];
	tmp[259] = dt*tmp[258];
	tmp[260] = P[108] + P[111]*tmp[237] + P[112]*tmp[240] + P[113]*tmp[238] + P[114]*tmp[239] + P[115]*tmp[236] + P[116]*tmp[234] + P[117]*tmp[235];
	tmp[261] = dt*tmp[260];
	tmp[262] = P[123] + P[126]*tmp[237] + P[127]*tmp[240] + P[128]*tmp[238] + P[129]*tmp[239] + P[130]*tmp[236] + P[131]*tmp[234] + P[132]*tmp[235];
	tmp[263] = dt*tmp[262];
	tmp[264] = dt*tmp[147];
	tmp[265] = dt*tmp[152];
	tmp[266] = dt*tmp[149];
	tmp[267] = dt*tmp[141];
	tmp[268] = dt*tmp[143];
	tmp[269] = dt*tmp[146];
	tmp[270] = dt*tmp[144];
	tmp[271] = P[82] + P[84]*tmp[267] + P[85]*tmp[268] + P[86]*tmp[270] + P[87]*tmp[269] + P[88]*tmp[264] + P[89]*tmp[266] + P[90]*tmp[265];
	tmp[272] = P[59] + P[61]*tmp[267] + P[62]*tmp[268] + P[63]*tmp[270] + P[64]*tmp[269] + P[65]*tmp[264] + P[76]*tmp[266] + P[88]*tmp[265];
	tmp[273] = P[70] + P[72]*tmp[267] + P[73]*tmp[268] + P[74]*tmp[270] + P[75]*tmp[269] + P[76]*tmp[264] + P[77]*tmp[266] + P[89]*tmp[265];
	tmp[274] = P[25] + P[27]*tmp[267] + P[34]*tmp[268] + P[42]*tmp[270] + P[51]*tmp[269] + P[61]*tmp[264] + P[72]*tmp[266] + P[84]*tmp[265];
	tmp[275] = P[32] + P[34]*tmp[267] + P[35]*tmp[268] + P[43]*tmp[270] + P[52]*tmp[269] + P[62]*tmp[264] + P[73]*tmp[266] + P[85]*tmp[265];
	tmp[276] = P[49] + P[51]*tmp[267] + P[52]*tmp[268] + P[53]*tmp[270] + P[54]*tmp[269] + P[64]*tmp[264] + P[75]*tmp[266] + P[87]*tmp[265];
	tmp[277] = P[40] + P[42]*tmp[267] + P[43]*tmp[268] + P[44]*tmp[270] + P[53]*tmp[269] + P[63]*tmp[264] + P[74]*tmp[266] + P[86]*tmp[265];
	tmp[278] = dt*tmp[158];
	tmp[279] = dt*tmp[157];
	tmp[280] = dt*tmp[159];
	tmp[281] = dt*tmp[274];
	tmp[282] = dt*tmp[275];
	tmp[283] = dt*tmp[277];
	tmp[284] = dt*tmp[276];
	tmp[285] = P[100]*tmp[269] + P[101]*tmp[264] + P[102]*tmp[266] + P[103]*tmp[265] + P[95] + P[97]*tmp[267] + P[98]*tmp[268] + P[99]*tmp[270];
	tmp[286] = dt*tmp[285];
	tmp[287] = P[109] + P[111]*tmp[267] + P[112]*tmp[268] + P[113]*tmp[270] + P[114]*tmp[269] + P[115]*tmp[264] + P[116]*tmp[266] + P[117]*tmp[265];
	tmp[288] = dt*tmp[287];
	tmp[289] = P[124] + P[126]*tmp[267] + P[127]*tmp[268] + P[128]*tmp[270] + P[129]*tmp[269] + P[130]*tmp[264] + P[131]*tmp[266] + P[132]*tmp[265];
	tmp[290] = dt*tmp[289];
	tmp[291] = dt*tmp[153];
	tmp[292] = dt*tmp[154];
	tmp[293] = dt*tmp[155];
	tmp[294] = dt*tmp[156];
	tmp[295] = P[71] + P[72]*tmp[291] + P[73]*tmp[292] + P[74]*tmp[293] + P[75]*tmp[294] + P[76]*tmp[279] + P[77]*tmp[278] + P[89]*tmp[280];
	tmp[296] = P[60] + P[61]*tmp[291] + P[62]*tmp[292] + P[63]*tmp[293] + P[64]*tmp[294] + P[65]*tmp[279] + P[76]*tmp[278] + P[88]*tmp[280];
	tmp[297] = P[83] + P[84]*tmp[291] + P[85]*tmp[292] + P[86]*tmp[293] + P[87]*tmp[294] + P[88]*tmp[279] + P[89]*tmp[278] + P[90]*tmp[280];
	tmp[298] = P[26] + P[27]*tmp[291] + P[34]*tmp[292] + P[42]*tmp[293] + P[51]*tmp[294] + P[61]*tmp[279] + P[72]*tmp[278] + P[84]*tmp[280];
	tmp[299] = P[33] + P[34]*tmp[291] + P[35]*tmp[292] + P[43]*tmp[293] + P[52]*tmp[294] + P[62]*tmp[279] + P[73]*tmp[278] + P[85]*tmp[280];
	tmp[300] = P[41] + P[42]*tmp[291] + P[43]*tmp[292] + P[44]*tmp[293] + P[53]*tmp[294] + P[63]*tmp[279] + P[74]*tmp[278] + P[86]*tmp[280];
	tmp[301] = P[50] + P[51]*tmp[291] + P[52]*tmp[292] + P[53]*tmp[293] + P[54]*tmp[294] + P[64]*tmp[279] + P[75]*tmp[278] + P[87]*tmp[280];
	tmp[302] = dt*tmp[299];
	tmp[303] = dt*tmp[300];
	tmp[304] = dt*tmp[301];
	tmp[305] = P[100]*tmp[294] + P[101]*tmp[279] + P[102]*tmp[278] + P[103]*tmp[280] + P[96] + P[97]*tmp[291] + P[98]*tmp[292] + P[99]*tmp[293];
	tmp[306] = dt*tmp[305];
	tmp[307] = P[110] + P[111]*tmp[291] + P[112]*tmp[292] + P[113]*tmp[293] + P[114]*tmp[294] + P[115]*tmp[279] + P[116]*tmp[278] + P[117]*tmp[280];
	tmp[308] = dt*tmp[307];
	tmp[309] = P[125] + P[126]*tmp[291] + P[127]*tmp[292] + P[128]*tmp[293] + P[129]*tmp[294] + P[130]*tmp[279] + P[131]*tmp[278] + P[132]*tmp[280];
	tmp[310] = dt*tmp[309];
	tmp[311] = dt*tmp[298];
	tmp[312] = dt*tmp[24];
	tmp[313] = dt*tmp[26];
	tmp[314] = dt*tmp[28];
	tmp[315] = dt*tmp[161];
	tmp[316] = dt*tmp[163];
	tmp[317] = dt*tmp[165];
	tmp[318] = P[52]*tmp[317];
	tmp[319] = P[112]*tmp[312] + P[127]*tmp[313] + P[34] + P[35]*tmp[315] + P[43]*tmp[316] + P[98]*tmp[314] + tmp[318];
	tmp[320] = P[43]*tmp[315];
	tmp[321] = P[113]*tmp[312] + P[128]*tmp[313] + P[42] + P[44]*tmp[316] + P[53]*tmp[317] + P[99]*tmp[314] + tmp[320];
	tmp[322] = P[53]*tmp[316];
	tmp[323] = P[100]*tmp[314] + P[114]*tmp[312] + P[129]*tmp[313] + P[51] + P[52]*tmp[315] + P[54]*tmp[317] + tmp[322];
	tmp[324] = 0.25*tmp[230];
	tmp[325] = Q[3]*tmp[324];
	tmp[326] = Q[4]*tmp[324];
	tmp[327] = Q[5]*tmp[324];
	tmp[328] = P[118]*tmp[312];
	tmp[329] = P[133]*tmp[313];
	tmp[330] = P[100]*tmp[317] + P[104]*tmp[314] + P[97] + P[98]*tmp[315] + P[99]*tmp[316] + tmp[328] + tmp[329];
	tmp[331] = P[118]*tmp[314];
	tmp[332] = P[134]*tmp[313];
	tmp[333] = P[111] + P[112]*tmp[315] + P[113]*tmp[316] + P[114]*tmp[317] + P[119]*tmp[312] + tmp[331] + tmp[332];
	tmp[334] = P[133]*tmp[314];
	tmp[335] = P[134]*tmp[312];
	tmp[336] = P[126] + P[127]*tmp[315] + P[128]*tmp[316] + P[129]*tmp[317] + P[135]*tmp[313] + tmp[334] + tmp[335];
	tmp[337] = P[111]*tmp[312] + P[126]*tmp[313] + P[27] + P[34]*tmp[315] + P[42]*tmp[316] + P[51]*tmp[317] + P[97]*tmp[314];
	tmp[338] = dt*tmp[160];
	tmp[339] = dt*tmp[164];
	tmp[340] = dt*tmp[27];
	tmp[341] = X[6]*tmp[325];
	tmp[342] = dt*tmp[162];
	tmp[343] = X[6]*tmp[326];
	tmp[344] = X[6]*tmp[327];
	tmp[345] = P[42]*tmp[339];
	tmp[346] = P[111]*tmp[313] - P[126]*tmp[312] + P[27]*tmp[338] + P[34] + P[51]*tmp[316] - P[97]*tmp[340] + tmp[345];
	tmp[347] = P[113]*tmp[313] - P[128]*tmp[312] + P[42]*tmp[338] + P[43] + P[44]*tmp[339] - P[99]*tmp[340] + tmp[322];
	tmp[348] = P[51]*tmp[338];
	tmp[349] = -P[100]*tmp[340] + P[114]*tmp[313] - P[129]*tmp[312] + P[52] + P[53]*tmp[339] + P[54]*tmp[316] + tmp[348];
	tmp[350] = -P[118]*tmp[340];
	tmp[351] = P[111]*tmp[338] + P[112] + P[113]*tmp[339] + P[114]*tmp[316] + P[119]*tmp[313] - tmp[335] + tmp[350];
	tmp[352] = P[118]*tmp[313];
	tmp[353] = P[133]*tmp[312];
	tmp[354] = P[100]*tmp[316] - P[104]*tmp[340] + P[97]*tmp[338] + P[98] + P[99]*tmp[339] + tmp[352] - tmp[353];
	tmp[355] = -P[133]*tmp[340];
	tmp[356] = P[126]*tmp[338] + P[127] + P[128]*tmp[339] + P[129]*tmp[316] - P[135]*tmp[312] + tmp[332] + tmp[355];
	tmp[357] = P[112]*tmp[313] - P[127]*tmp[312] + P[34]*tmp[338] + P[35] + P[43]*tmp[339] + P[52]*tmp[316] - P[98]*tmp[340];
	tmp[358] = -P[100]*tmp[313] - P[114]*tmp[340] + P[129]*tmp[314] + P[51]*tmp[342] + P[53] + P[54]*tmp[338] + tmp[318];
	tmp[359] = -P[111]*tmp[340] + P[126]*tmp[314] + P[27]*tmp[342] + P[34]*tmp[317] + P[42] - P[97]*tmp[313] + tmp[348];
	tmp[360] = P[34]*tmp[342];
	tmp[361] = -P[112]*tmp[340] + P[127]*tmp[314] + P[35]*tmp[317] + P[43] + P[52]*tmp[338] - P[98]*tmp[313] + tmp[360];
	tmp[362] = -P[134]*tmp[340];
	tmp[363] = P[126]*tmp[342] + P[127]*tmp[317] + P[128] + P[129]*tmp[338] + P[135]*tmp[314] - tmp[329] + tmp[362];
	tmp[364] = P[134]*tmp[314];
	tmp[365] = P[111]*tmp[342] + P[112]*tmp[317] + P[113] + P[114]*tmp[338] - P[119]*tmp[340] - tmp[352] + tmp[364];
	tmp[366] = P[100]*tmp[338] - P[104]*tmp[313] + P[97]*tmp[342] + P[98]*tmp[317] + P[99] + tmp[334] + tmp[350];
	tmp[367] = -P[113]*tmp[340] + P[128]*tmp[314] + P[42]*tmp[342] + P[43]*tmp[317] + P[44] + P[53]*tmp[338] - P[99]*tmp[313];
	tmp[368] = P[126]*tmp[339] + P[127]*tmp[342] + P[128]*tmp[315] + P[129] - P[135]*tmp[340] + tmp[353] - tmp[364];
	tmp[369] = P[111]*tmp[339] + P[112]*tmp[342] + P[113]*tmp[315] + P[114] - P[119]*tmp[314] + tmp[328] + tmp[362];
	tmp[370] = P[100] + P[104]*tmp[312] + P[97]*tmp[339] + P[98]*tmp[342] + P[99]*tmp[315] - tmp[331] + tmp[355];
	X_new[0] = X[0] + X[3]*dt;
	X_new[1] = X[1] + X[4]*dt;
	X_new[2] = X[2] + X[5]*dt;
	X_new[3] = X[3] + dt*(X[6]*tmp[13] - X[7]*tmp[19] + X[8]*tmp[15] - X[9]*tmp[17]);
	X_new[4] = X[4] + dt*(X[6]*tmp[16]*tmp[5] - X[7]*tmp[15] - X[8]*tmp[19] - X[9]*tmp[21]);
	X_new[5] = X[5] + dt*(X[6]*tmp[15] + X[7]*tmp[17] - X[8]*tmp[13] - X[9]*tmp[19] + 9.8100000000000005);
	X_new[6] = X[6] + dt*(-X[7]*tmp[22] - tmp[23]*tmp[24] - tmp[25]*tmp[26]);
	X_new[7] = X[7] + dt*(X[6]*tmp[22] - tmp[23]*tmp[26] + tmp[24]*tmp[25]);
	X_new[8] = X[8] + dt*(X[9]*tmp[22] + tmp[23]*tmp[27] - tmp[25]*tmp[28]);
	X_new[9] = X[9] + dt*(-X[8]*tmp[22] + tmp[23]*tmp[28] + tmp[25]*tmp[27]);
	X_new[10] = X[10];
	X_new[11] = X[11];
	X_new[12] = X[12];
	X_new[13] = X[13];
	X_new[14] = X[14];
	X_new[15] = X[15];
	P_new[0] = P[0] + P[6]*dt + dt*tmp[29];
	P_new[1] = P[1] + P[7]*dt + dt*tmp[31];
	P_new[3] = P[3] + P[8]*dt + dt*tmp[33];
	P_new[6] = tmp[102]*tmp[99] + tmp[109]*tmp[112] + tmp[120]*tmp[123] + tmp[129]*tmp[132] + tmp[136]*tmp[139] + tmp[29] + tmp[64]*tmp[67] + tmp[84]*tmp[87];
	P_new[10] = tmp[102]*tmp[144] + tmp[112]*tmp[146] + tmp[123]*tmp[147] + tmp[132]*tmp[149] + tmp[139]*tmp[152] + tmp[141]*tmp[67] + tmp[143]*tmp[87] + tmp[31];
	P_new[15] = tmp[102]*tmp[155] + tmp[112]*tmp[156] + tmp[123]*tmp[157] + tmp[132]*tmp[158] + tmp[139]*tmp[159] + tmp[153]*tmp[67] + tmp[154]*tmp[87] + tmp[33];
	P_new[21] = tmp[102]*tmp[163] + tmp[112]*tmp[165] + tmp[161]*tmp[87] + tmp[167]*tmp[28] + tmp[169]*tmp[24] + tmp[171]*tmp[26] + tmp[66];
	P_new[28] = tmp[102]*tmp[164] + tmp[112]*tmp[163] + tmp[160]*tmp[67] - tmp[167]*tmp[27] + tmp[169]*tmp[26] - tmp[171]*tmp[24] + tmp[86];
	P_new[36] = tmp[101] + tmp[112]*tmp[160] + tmp[162]*tmp[67] + tmp[165]*tmp[87] - tmp[167]*tmp[26] - tmp[169]*tmp[27] + tmp[171]*tmp[28];
	P_new[45] = tmp[102]*tmp[161] + tmp[111] + tmp[162]*tmp[87] + tmp[164]*tmp[67] + tmp[167]*tmp[24] - tmp[169]*tmp[28] - tmp[171]*tmp[27];
	P_new[55] = tmp[122];
	P_new[66] = tmp[131];
	P_new[78] = tmp[138];
	P_new[91] = tmp[166];
	P_new[105] = tmp[168];
	P_new[120] = tmp[170];
	P_new[2] = P[11]*dt + P[2] + dt*tmp[172];
	P_new[4] = P[12]*dt + P[4] + dt*tmp[174];
	P_new[7] = P[7] + tmp[109]*tmp[192] + tmp[120]*tmp[183] + tmp[129]*tmp[177] + tmp[136]*tmp[180] + tmp[186]*tmp[64] + tmp[189]*tmp[99] + tmp[195]*tmp[84] + tmp[30];
	P_new[11] = tmp[141]*tmp[186] + tmp[143]*tmp[195] + tmp[144]*tmp[189] + tmp[146]*tmp[192] + tmp[147]*tmp[183] + tmp[149]*tmp[177] + tmp[152]*tmp[180] + tmp[172];
	P_new[16] = tmp[153]*tmp[186] + tmp[154]*tmp[195] + tmp[155]*tmp[189] + tmp[156]*tmp[192] + tmp[157]*tmp[183] + tmp[158]*tmp[177] + tmp[159]*tmp[180] + tmp[174];
	P_new[22] = tmp[161]*tmp[195] + tmp[163]*tmp[189] + tmp[165]*tmp[192] + tmp[185] + tmp[197]*tmp[28] + tmp[199]*tmp[24] + tmp[201]*tmp[26];
	P_new[29] = tmp[160]*tmp[186] + tmp[163]*tmp[192] + tmp[164]*tmp[189] + tmp[194] - tmp[197]*tmp[27] + tmp[199]*tmp[26] - tmp[201]*tmp[24];
	P_new[37] = tmp[160]*tmp[192] + tmp[162]*tmp[186] + tmp[165]*tmp[195] + tmp[188] - tmp[197]*tmp[26] - tmp[199]*tmp[27] + tmp[201]*tmp[28];
	P_new[46] = tmp[161]*tmp[189] + tmp[162]*tmp[195] + tmp[164]*tmp[186] + tmp[191] + tmp[197]*tmp[24] - tmp[199]*tmp[28] - tmp[201]*tmp[27];
	P_new[56] = tmp[182];
	P_new[67] = tmp[176];
	P_new[79] = tmp[179];
	P_new[92] = tmp[196];
	P_new[106] = tmp[198];
	P_new[121] = tmp[200];
	P_new[5] = P[17]*dt + P[5] + dt*tmp[202];
	P_new[8] = P[8] + tmp[109]*tmp[220] + tmp[120]*tmp[211] + tmp[129]*tmp[205] + tmp[136]*tmp[208] + tmp[214]*tmp[64] + tmp[217]*tmp[99] + tmp[223]*tmp[84] + tmp[32];
	P_new[12] = P[12] + tmp[141]*tmp[214] + tmp[143]*tmp[223] + tmp[144]*tmp[217] + tmp[146]*tmp[220] + tmp[147]*tmp[211] + tmp[149]*tmp[205] + tmp[152]*tmp[208] + tmp[173];
	P_new[17] = tmp[153]*tmp[214] + tmp[154]*tmp[223] + tmp[155]*tmp[217] + tmp[156]*tmp[220] + tmp[157]*tmp[211] + tmp[158]*tmp[205] + tmp[159]*tmp[208] + tmp[202];
	P_new[23] = tmp[161]*tmp[223] + tmp[163]*tmp[217] + tmp[165]*tmp[220] + tmp[213] + tmp[225]*tmp[28] + tmp[227]*tmp[24] + tmp[229]*tmp[26];
	P_new[30] = tmp[160]*tmp[214] + tmp[163]*tmp[220] + tmp[164]*tmp[217] + tmp[222] - tmp[225]*tmp[27] + tmp[227]*tmp[26] - tmp[229]*tmp[24];
	P_new[38] = tmp[160]*tmp[220] + tmp[162]*tmp[214] + tmp[165]*tmp[223] + tmp[216] - tmp[225]*tmp[26] - tmp[227]*tmp[27] + tmp[229]*tmp[28];
	P_new[47] = tmp[161]*tmp[217] + tmp[162]*tmp[223] + tmp[164]*tmp[214] + tmp[219] + tmp[225]*tmp[24] - tmp[227]*tmp[28] - tmp[229]*tmp[27];
	P_new[57] = tmp[210];
	P_new[68] = tmp[204];
	P_new[80] = tmp[207];
	P_new[93] = tmp[224];
	P_new[107] = tmp[226];
	P_new[122] = tmp[228];
	P_new[9] = P[9] + tmp[100]*tmp[99] + tmp[109]*tmp[110] + powf(tmp[120], 2)*tmp[233] + tmp[120]*tmp[121] + powf(tmp[129], 2)*tmp[231] + tmp[129]*tmp[130] + powf(tmp[136], 2)*tmp[232] + tmp[136]*tmp[137] + tmp[234]*tmp[242] + tmp[235]*tmp[241] + tmp[236]*tmp[243] + tmp[237]*tmp[244] + tmp[238]*tmp[245] + tmp[239]*tmp[246] + tmp[240]*tmp[247] + tmp[64]*tmp[65] + tmp[84]*tmp[85];
	P_new[13] = P[13] + tmp[109]*tmp[190] + tmp[120]*tmp[181] + tmp[129]*tmp[175] + tmp[136]*tmp[178] + tmp[141]*tmp[254] + tmp[143]*tmp[255] + tmp[144]*tmp[257] + tmp[146]*tmp[256] + tmp[147]*tmp[249] + tmp[147]*tmp[252] + tmp[149]*tmp[250] + tmp[149]*tmp[253] + tmp[152]*tmp[248] + tmp[152]*tmp[251] + tmp[184]*tmp[64] + tmp[187]*tmp[99] + tmp[193]*tmp[84];
	P_new[18] = P[18] + tmp[109]*tmp[218] + tmp[120]*tmp[209] + tmp[129]*tmp[203] + tmp[136]*tmp[206] + tmp[153]*tmp[254] + tmp[154]*tmp[255] + tmp[155]*tmp[257] + tmp[156]*tmp[256] + tmp[157]*tmp[249] + tmp[157]*tmp[252] + tmp[158]*tmp[250] + tmp[158]*tmp[253] + tmp[159]*tmp[248] + tmp[159]*tmp[251] + tmp[212]*tmp[64] + tmp[215]*tmp[99] + tmp[221]*tmp[84];
	P_new[24] = tmp[161]*tmp[255] + tmp[163]*tmp[257] + tmp[165]*tmp[256] + tmp[244] + tmp[24]*tmp[261] + tmp[259]*tmp[28] + tmp[263]*tmp[26];
	P_new[31] = tmp[160]*tmp[254] + tmp[163]*tmp[256] + tmp[164]*tmp[257] + tmp[247] - tmp[24]*tmp[263] - tmp[259]*tmp[27] + tmp[261]*tmp[26];
	P_new[39] = tmp[160]*tmp[256] + tmp[162]*tmp[254] + tmp[165]*tmp[255] + tmp[245] - tmp[259]*tmp[26] - tmp[261]*tmp[27] + tmp[263]*tmp[28];
	P_new[48] = tmp[161]*tmp[257] + tmp[162]*tmp[255] + tmp[164]*tmp[254] + tmp[246] + tmp[24]*tmp[259] - tmp[261]*tmp[28] - tmp[263]*tmp[27];
	P_new[58] = tmp[243];
	P_new[69] = tmp[242];
	P_new[81] = tmp[241];
	P_new[94] = tmp[258];
	P_new[108] = tmp[260];
	P_new[123] = tmp[262];
	P_new[14] = P[14] + tmp[141]*tmp[184] + tmp[143]*tmp[193] + tmp[144]*tmp[187] + tmp[146]*tmp[190] + powf(tmp[147], 2)*tmp[233] + tmp[147]*tmp[181] + powf(tmp[149], 2)*tmp[231] + tmp[149]*tmp[175] + powf(tmp[152], 2)*tmp[232] + tmp[152]*tmp[178] + tmp[264]*tmp[272] + tmp[265]*tmp[271] + tmp[266]*tmp[273] + tmp[267]*tmp[274] + tmp[268]*tmp[275] + tmp[269]*tmp[276] + tmp[270]*tmp[277];
	P_new[19] = P[19] + tmp[141]*tmp[212] + tmp[143]*tmp[221] + tmp[144]*tmp[215] + tmp[146]*tmp[218] + tmp[147]*tmp[157]*tmp[233] + tmp[147]*tmp[209] + tmp[149]*tmp[158]*tmp[231] + tmp[149]*tmp[203] + tmp[152]*tmp[159]*tmp[232] + tmp[152]*tmp[206] + tmp[153]*tmp[281] + tmp[154]*tmp[282] + tmp[155]*tmp[283] + tmp[156]*tmp[284] + tmp[271]*tmp[280] + tmp[272]*tmp[279] + tmp[273]*tmp[278];
	P_new[25] = tmp[161]*tmp[282] + tmp[163]*tmp[283] + tmp[165]*tmp[284] + tmp[24]*tmp[288] + tmp[26]*tmp[290] + tmp[274] + tmp[286]*tmp[28];
	P_new[32] = tmp[160]*tmp[281] + tmp[163]*tmp[284] + tmp[164]*tmp[283] - tmp[24]*tmp[290] + tmp[26]*tmp[288] + tmp[275] - tmp[27]*tmp[286];
	P_new[40] = tmp[160]*tmp[284] + tmp[162]*tmp[281] + tmp[165]*tmp[282] - tmp[26]*tmp[286] + tmp[277] - tmp[27]*tmp[288] + tmp[28]*tmp[290];
	P_new[49] = tmp[161]*tmp[283] + tmp[162]*tmp[282] + tmp[164]*tmp[281] + tmp[24]*tmp[286] + tmp[276] - tmp[27]*tmp[290] - tmp[288]*tmp[28];
	P_new[59] = tmp[272];
	P_new[70] = tmp[273];
	P_new[82] = tmp[271];
	P_new[95] = tmp[285];
	P_new[109] = tmp[287];
	P_new[124] = tmp[289];
	P_new[20] = P[20] + tmp[153]*tmp[212] + tmp[154]*tmp[221] + tmp[155]*tmp[215] + tmp[156]*tmp[218] + powf(tmp[157], 2)*tmp[233] + tmp[157]*tmp[209] + powf(tmp[158], 2)*tmp[231] + tmp[158]*tmp[203] + powf(tmp[159], 2)*tmp[232] + tmp[159]*tmp[206] + tmp[278]*tmp[295] + tmp[279]*tmp[296] + tmp[280]*tmp[297] + tmp[291]*tmp[298] + tmp[292]*tmp[299] + tmp[293]*tmp[300] + tmp[294]*tmp[301];
	P_new[26] = tmp[161]*tmp[302] + tmp[163]*tmp[303] + tmp[165]*tmp[304] + tmp[24]*tmp[308] + tmp[26]*tmp[310] + tmp[28]*tmp[306] + tmp[298];
	P_new[33] = tmp[160]*tmp[311] + tmp[163]*tmp[304] + tmp[164]*tmp[303] - tmp[24]*tmp[310] + tmp[26]*tmp[308] - tmp[27]*tmp[306] + tmp[299];
	P_new[41] = tmp[160]*tmp[304] + tmp[162]*tmp[311] + tmp[165]*tmp[302] - tmp[26]*tmp[306] - tmp[27]*tmp[308] + tmp[28]*tmp[310] + tmp[300];
	P_new[50] = tmp[161]*tmp[303] + tmp[162]*tmp[302] + tmp[164]*tmp[311] + tmp[24]*tmp[306] - tmp[27]*tmp[310] - tmp[28]*tmp[308] + tmp[301];
	P_new[60] = tmp[296];
	P_new[71] = tmp[295];
	P_new[83] = tmp[297];
	P_new[96] = tmp[305];
	P_new[110] = tmp[307];
	P_new[125] = tmp[309];
	P_new[27] = tmp[1]*tmp[325] + tmp[2]*tmp[326] + tmp[312]*tmp[333] + tmp[313]*tmp[336] + tmp[314]*tmp[330] + tmp[315]*tmp[319] + tmp[316]*tmp[321] + tmp[317]*tmp[323] + tmp[327]*tmp[3] + tmp[337];
	P_new[34] = -X[7]*tmp[341] - tmp[312]*tmp[336] + tmp[313]*tmp[333] + tmp[316]*tmp[323] + tmp[319] + tmp[321]*tmp[339] + tmp[326]*tmp[88] - tmp[327]*tmp[88] - tmp[330]*tmp[340] + tmp[337]*tmp[338];
	P_new[42] = -X[8]*tmp[343] - tmp[134]*tmp[325] + tmp[134]*tmp[327] - tmp[313]*tmp[330] + tmp[314]*tmp[336] + tmp[317]*tmp[319] + tmp[321] + tmp[323]*tmp[338] - tmp[333]*tmp[340] + tmp[337]*tmp[342];
	P_new[51] = -X[9]*tmp[344] + tmp[127]*tmp[325] - tmp[127]*tmp[326] + tmp[312]*tmp[330] - tmp[314]*tmp[333] + tmp[315]*tmp[321] + tmp[319]*tmp[342] + tmp[323] - tmp[336]*tmp[340] + tmp[337]*tmp[339];
	P_new[61] = P[101]*tmp[314] + P[115]*tmp[312] + P[130]*tmp[313] + P[61] + P[62]*tmp[315] + P[63]*tmp[316] + P[64]*tmp[317];
	P_new[72] = P[102]*tmp[314] + P[116]*tmp[312] + P[131]*tmp[313] + P[72] + P[73]*tmp[315] + P[74]*tmp[316] + P[75]*tmp[317];
	P_new[84] = P[103]*tmp[314] + P[117]*tmp[312] + P[132]*tmp[313] + P[84] + P[85]*tmp[315] + P[86]*tmp[316] + P[87]*tmp[317];
	P_new[97] = tmp[330];
	P_new[111] = tmp[333];
	P_new[126] = tmp[336];
	P_new[35] = tmp[0]*tmp[325] + tmp[2]*tmp[327] - tmp[312]*tmp[356] + tmp[313]*tmp[351] + tmp[316]*tmp[349] + tmp[326]*tmp[3] + tmp[338]*tmp[346] + tmp[339]*tmp[347] - tmp[340]*tmp[354] + tmp[357];
	P_new[43] = X[9]*tmp[341] - X[9]*tmp[343] - tmp[127]*tmp[327] - tmp[313]*tmp[354] + tmp[314]*tmp[356] + tmp[317]*tmp[357] + tmp[338]*tmp[349] - tmp[340]*tmp[351] + tmp[342]*tmp[346] + tmp[347];
	P_new[52] = -X[8]*tmp[341] + X[8]*tmp[344] - tmp[134]*tmp[326] + tmp[312]*tmp[354] - tmp[314]*tmp[351] + tmp[315]*tmp[347] + tmp[339]*tmp[346] - tmp[340]*tmp[356] + tmp[342]*tmp[357] + tmp[349];
	P_new[62] = -P[101]*tmp[340] + P[115]*tmp[313] - P[130]*tmp[312] + P[61]*tmp[338] + P[62] + P[63]*tmp[339] + P[64]*tmp[316];
	P_new[73] = -P[102]*tmp[340] + P[116]*tmp[313] - P[131]*tmp[312] + P[72]*tmp[338] + P[73] + P[74]*tmp[339] + P[75]*tmp[316];
	P_new[85] = -P[103]*tmp[340] + P[117]*tmp[313] - P[132]*tmp[312] + P[84]*tmp[338] + P[85] + P[86]*tmp[339] + P[87]*tmp[316];
	P_new[98] = tmp[354];
	P_new[112] = tmp[351];
	P_new[127] = tmp[356];
	P_new[44] = tmp[0]*tmp[326] + tmp[1]*tmp[327] - tmp[313]*tmp[366] + tmp[314]*tmp[363] + tmp[317]*tmp[361] + tmp[325]*tmp[3] + tmp[338]*tmp[358] - tmp[340]*tmp[365] + tmp[342]*tmp[359] + tmp[367];
	P_new[53] = X[7]*tmp[343] - X[7]*tmp[344] + tmp[312]*tmp[366] - tmp[314]*tmp[365] + tmp[315]*tmp[367] - tmp[325]*tmp[88] + tmp[339]*tmp[359] - tmp[340]*tmp[363] + tmp[342]*tmp[361] + tmp[358];
	P_new[63] = -P[101]*tmp[313] - P[115]*tmp[340] + P[130]*tmp[314] + P[61]*tmp[342] + P[62]*tmp[317] + P[63] + P[64]*tmp[338];
	P_new[74] = -P[102]*tmp[313] - P[116]*tmp[340] + P[131]*tmp[314] + P[72]*tmp[342] + P[73]*tmp[317] + P[74] + P[75]*tmp[338];
	P_new[86] = -P[103]*tmp[313] - P[117]*tmp[340] + P[132]*tmp[314] + P[84]*tmp[342] + P[85]*tmp[317] + P[86] + P[87]*tmp[338];
	P_new[99] = tmp[366];
	P_new[113] = tmp[365];
	P_new[128] = tmp[363];
	P_new[54] = P[100]*tmp[312] - P[114]*tmp[314] - P[129]*tmp[340] + P[51]*tmp[339] + P[52]*tmp[342] + P[53]*tmp[315] + P[54] + tmp[0]*tmp[327] + tmp[1]*tmp[326] + tmp[2]*tmp[325] + tmp[312]*tmp[370] - tmp[314]*tmp[369] + tmp[315]*(-P[113]*tmp[314] - P[128]*tmp[340] + P[43]*tmp[342] + P[44]*tmp[315] + P[53] + P[99]*tmp[312] + tmp[345]) + tmp[339]*(-P[111]*tmp[314] - P[126]*tmp[340] + P[27]*tmp[339] + P[42]*tmp[315] + P[51] + P[97]*tmp[312] + tmp[360]) - tmp[340]*tmp[368] + tmp[342]*(-P[112]*tmp[314] - P[127]*tmp[340] + P[34]*tmp[339] + P[35]*tmp[342] + P[52] + P[98]*tmp[312] + tmp[320]);
	P_new[64] = P[101]*tmp[312] - P[115]*tmp[314] - P[130]*tmp[340] + P[61]*tmp[339] + P[62]*tmp[342] + P[63]*tmp[315] + P[64];
	P_new[75] = P[102]*tmp[312] - P[116]*tmp[314] - P[131]*tmp[340] + P[72]*tmp[339] + P[73]*tmp[342] + P[74]*tmp[315] + P[75];
	P_new[87] = P[103]*tmp[312] - P[117]*tmp[314] - P[132]*tmp[340] + P[84]*tmp[339] + P[85]*tmp[342] + P[86]*tmp[315] + P[87];
	P_new[100] = tmp[370];
	P_new[114] = tmp[369];
	P_new[129] = tmp[368];
	P_new[65] = P[65] + Q[6]*tmp[230];
	P_new[76] = P[76];
	P_new[88] = P[88];
	P_new[101] = P[101];
	P_new[115] = P[115];
	P_new[130] = P[130];
	P_new[77] = P[77] + Q[7]*tmp[230];
	P_new[89] = P[89];
	P_new[102] = P[102];
	P_new[116] = P[116];
	P_new[131] = P[131];
	P_new[90] = P[90] + Q[8]*tmp[230];
	P_new[103] = P[103];
	P_new[117] = P[117];
	P_new[132] = P[132];
	P_new[104] = P[104] + Q[9]*tmp[230];
	P_new[118] = P[118];
	P_new[133] = P[133];
	P_new[119] = P[119] + Q[10]*tmp[230];
	P_new[134] = P[134];
	P_new[135] = P[135] + Q[11]*tmp[230];

    // swap X, X_new and P, P_new pointers
    swap_ptr = X;
    X = X_new;
    X_new = swap_ptr;

    swap_ptr = P;
    P = P_new;
    P_new = swap_ptr;
}


void normalize_quaternion(float* q) {
    float norm = q[0]*q[0] + q[1]*q[1] + q[2]*q[2] + q[3]*q[3];
    if (norm > 1e-4f) {
        float inorm = 1.f / sqrtf(norm);
        q[0] *= inorm;
        q[1] *= inorm;
        q[2] *= inorm;
        q[3] *= inorm;
    }
}


void ekf_update_mocap(float Z[N_MEASUREMENTS_MOCAP]) {
    // prepare gain calculation
    tmp[0] = P[21]*ekf_use_quat;
	tmp[1] = P[28]*ekf_use_quat;
	tmp[2] = P[36]*ekf_use_quat;
	tmp[3] = P[45]*ekf_use_quat;
	tmp[4] = P[22]*ekf_use_quat;
	tmp[5] = P[29]*ekf_use_quat;
	tmp[6] = P[37]*ekf_use_quat;
	tmp[7] = P[46]*ekf_use_quat;
	tmp[8] = P[23]*ekf_use_quat;
	tmp[9] = P[30]*ekf_use_quat;
	tmp[10] = P[38]*ekf_use_quat;
	tmp[11] = P[47]*ekf_use_quat;
	tmp[12] = powf(ekf_use_quat, 2);
	tmp[13] = P[34]*tmp[12];
	tmp[14] = P[42]*tmp[12];
	tmp[15] = P[51]*tmp[12];
	tmp[16] = P[43]*tmp[12];
	tmp[17] = P[52]*tmp[12];
	tmp[18] = P[53]*tmp[12];
	tmp[19] = P[34]*ekf_use_quat;
	tmp[20] = P[42]*ekf_use_quat;
	tmp[21] = P[51]*ekf_use_quat;
	tmp[22] = P[43]*ekf_use_quat;
	tmp[23] = P[52]*ekf_use_quat;
	tmp[24] = P[53]*ekf_use_quat;
	S_mocap[0] = P[0] + R_mocap[0];
	S_mocap[7] = P[1];
	S_mocap[14] = P[3];
	S_mocap[21] = tmp[0];
	S_mocap[28] = tmp[1];
	S_mocap[35] = tmp[2];
	S_mocap[42] = tmp[3];
	S_mocap[1] = P[1];
	S_mocap[8] = P[2] + R_mocap[1];
	S_mocap[15] = P[4];
	S_mocap[22] = tmp[4];
	S_mocap[29] = tmp[5];
	S_mocap[36] = tmp[6];
	S_mocap[43] = tmp[7];
	S_mocap[2] = P[3];
	S_mocap[9] = P[4];
	S_mocap[16] = P[5] + R_mocap[2];
	S_mocap[23] = tmp[8];
	S_mocap[30] = tmp[9];
	S_mocap[37] = tmp[10];
	S_mocap[44] = tmp[11];
	S_mocap[3] = tmp[0];
	S_mocap[10] = tmp[4];
	S_mocap[17] = tmp[8];
	S_mocap[24] = P[27]*tmp[12] + R_mocap[3];
	S_mocap[31] = tmp[13];
	S_mocap[38] = tmp[14];
	S_mocap[45] = tmp[15];
	S_mocap[4] = tmp[1];
	S_mocap[11] = tmp[5];
	S_mocap[18] = tmp[9];
	S_mocap[25] = tmp[13];
	S_mocap[32] = P[35]*tmp[12] + R_mocap[4];
	S_mocap[39] = tmp[16];
	S_mocap[46] = tmp[17];
	S_mocap[5] = tmp[2];
	S_mocap[12] = tmp[6];
	S_mocap[19] = tmp[10];
	S_mocap[26] = tmp[14];
	S_mocap[33] = tmp[16];
	S_mocap[40] = P[44]*tmp[12] + R_mocap[5];
	S_mocap[47] = tmp[18];
	S_mocap[6] = tmp[3];
	S_mocap[13] = tmp[7];
	S_mocap[20] = tmp[11];
	S_mocap[27] = tmp[15];
	S_mocap[34] = tmp[17];
	S_mocap[41] = tmp[18];
	S_mocap[48] = P[54]*tmp[12] + R_mocap[6];
	HP_mocap[0] = P[0];
	HP_mocap[1] = P[1];
	HP_mocap[2] = P[3];
	HP_mocap[3] = tmp[0];
	HP_mocap[4] = tmp[1];
	HP_mocap[5] = tmp[2];
	HP_mocap[6] = tmp[3];
	HP_mocap[7] = P[1];
	HP_mocap[8] = P[2];
	HP_mocap[9] = P[4];
	HP_mocap[10] = tmp[4];
	HP_mocap[11] = tmp[5];
	HP_mocap[12] = tmp[6];
	HP_mocap[13] = tmp[7];
	HP_mocap[14] = P[3];
	HP_mocap[15] = P[4];
	HP_mocap[16] = P[5];
	HP_mocap[17] = tmp[8];
	HP_mocap[18] = tmp[9];
	HP_mocap[19] = tmp[10];
	HP_mocap[20] = tmp[11];
	HP_mocap[21] = P[6];
	HP_mocap[22] = P[7];
	HP_mocap[23] = P[8];
	HP_mocap[24] = P[24]*ekf_use_quat;
	HP_mocap[25] = P[31]*ekf_use_quat;
	HP_mocap[26] = P[39]*ekf_use_quat;
	HP_mocap[27] = P[48]*ekf_use_quat;
	HP_mocap[28] = P[10];
	HP_mocap[29] = P[11];
	HP_mocap[30] = P[12];
	HP_mocap[31] = P[25]*ekf_use_quat;
	HP_mocap[32] = P[32]*ekf_use_quat;
	HP_mocap[33] = P[40]*ekf_use_quat;
	HP_mocap[34] = P[49]*ekf_use_quat;
	HP_mocap[35] = P[15];
	HP_mocap[36] = P[16];
	HP_mocap[37] = P[17];
	HP_mocap[38] = P[26]*ekf_use_quat;
	HP_mocap[39] = P[33]*ekf_use_quat;
	HP_mocap[40] = P[41]*ekf_use_quat;
	HP_mocap[41] = P[50]*ekf_use_quat;
	HP_mocap[42] = P[21];
	HP_mocap[43] = P[22];
	HP_mocap[44] = P[23];
	HP_mocap[45] = P[27]*ekf_use_quat;
	HP_mocap[46] = tmp[19];
	HP_mocap[47] = tmp[20];
	HP_mocap[48] = tmp[21];
	HP_mocap[49] = P[28];
	HP_mocap[50] = P[29];
	HP_mocap[51] = P[30];
	HP_mocap[52] = tmp[19];
	HP_mocap[53] = P[35]*ekf_use_quat;
	HP_mocap[54] = tmp[22];
	HP_mocap[55] = tmp[23];
	HP_mocap[56] = P[36];
	HP_mocap[57] = P[37];
	HP_mocap[58] = P[38];
	HP_mocap[59] = tmp[20];
	HP_mocap[60] = tmp[22];
	HP_mocap[61] = P[44]*ekf_use_quat;
	HP_mocap[62] = tmp[24];
	HP_mocap[63] = P[45];
	HP_mocap[64] = P[46];
	HP_mocap[65] = P[47];
	HP_mocap[66] = tmp[21];
	HP_mocap[67] = tmp[23];
	HP_mocap[68] = tmp[24];
	HP_mocap[69] = P[54]*ekf_use_quat;
	HP_mocap[70] = P[55];
	HP_mocap[71] = P[56];
	HP_mocap[72] = P[57];
	HP_mocap[73] = P[61]*ekf_use_quat;
	HP_mocap[74] = P[62]*ekf_use_quat;
	HP_mocap[75] = P[63]*ekf_use_quat;
	HP_mocap[76] = P[64]*ekf_use_quat;
	HP_mocap[77] = P[66];
	HP_mocap[78] = P[67];
	HP_mocap[79] = P[68];
	HP_mocap[80] = P[72]*ekf_use_quat;
	HP_mocap[81] = P[73]*ekf_use_quat;
	HP_mocap[82] = P[74]*ekf_use_quat;
	HP_mocap[83] = P[75]*ekf_use_quat;
	HP_mocap[84] = P[78];
	HP_mocap[85] = P[79];
	HP_mocap[86] = P[80];
	HP_mocap[87] = P[84]*ekf_use_quat;
	HP_mocap[88] = P[85]*ekf_use_quat;
	HP_mocap[89] = P[86]*ekf_use_quat;
	HP_mocap[90] = P[87]*ekf_use_quat;
	HP_mocap[91] = P[91];
	HP_mocap[92] = P[92];
	HP_mocap[93] = P[93];
	HP_mocap[94] = P[97]*ekf_use_quat;
	HP_mocap[95] = P[98]*ekf_use_quat;
	HP_mocap[96] = P[99]*ekf_use_quat;
	HP_mocap[97] = P[100]*ekf_use_quat;
	HP_mocap[98] = P[105];
	HP_mocap[99] = P[106];
	HP_mocap[100] = P[107];
	HP_mocap[101] = P[111]*ekf_use_quat;
	HP_mocap[102] = P[112]*ekf_use_quat;
	HP_mocap[103] = P[113]*ekf_use_quat;
	HP_mocap[104] = P[114]*ekf_use_quat;
	HP_mocap[105] = P[120];
	HP_mocap[106] = P[121];
	HP_mocap[107] = P[122];
	HP_mocap[108] = P[126]*ekf_use_quat;
	HP_mocap[109] = P[127]*ekf_use_quat;
	HP_mocap[110] = P[128]*ekf_use_quat;
	HP_mocap[111] = P[129]*ekf_use_quat;

    // renorm quat
    normalize_quaternion(X+6);

    // we have symmetric S and PHT in col major.
    // Solve K as K^T = invS * H*P, as we have columns of HP. We solve columns of K^T, which are actually rows of K
    if (!ekf_use_quat) {
        // 3 state kalman update, yay
        float S_small[3*3];
        for (int i = 0; i < 3; i++) {
            for (int j = 0; j < 3; j++) {
                S_small[i + j*3] = S_mocap[i + j*N_MEASUREMENTS_MOCAP];
            }
        }
        float k_row[3];
        float S_small_chol[3*3];
        chol(S_small_chol, S_small, ekf_S_iDiag_mocap, 3);
        for (int i = 0; i < N_STATES; i++) {
            chol_solve(S_small_chol, ekf_S_iDiag_mocap, 3, (HP_mocap+(i*N_MEASUREMENTS_MOCAP)), k_row);
            for (int j = 0; j < 3; j++) {
                K_mocap[i + j*N_STATES] = k_row[j];
            }
            for (int j = 3; j < N_MEASUREMENTS_MOCAP; j++) {
                K_mocap[i + j*N_STATES] = 0.f;
            }
        }
    } else {
        // full state kalman update, meh
        chol(ekf_S_chol_mocap, S_mocap, ekf_S_iDiag_mocap, N_MEASUREMENTS_MOCAP);
        for (int i = 0; i < N_STATES; i++) {
            float k_row[N_MEASUREMENTS_MOCAP];
            chol_solve(ekf_S_chol_mocap, ekf_S_iDiag_mocap, N_MEASUREMENTS_MOCAP, (HP_mocap+(i*N_MEASUREMENTS_MOCAP)), k_row);
            for (int j = 0; j < N_MEASUREMENTS_MOCAP; j++) {
                K_mocap[i + j*N_STATES] = k_row[j];
            }
        }
    }

    float qerror2 = 0.f;
    for (int i = 0; i < 4; i++) {
        qerror2 += (Z[3+i] - X[6+i])*(Z[3+i] - X[6+i]);
    }

    if (qerror2 > 2.f) {
        // quaternion error is too big, negating the measured quaternion will
        // give better convergence
        for (int i = 0; i < 4; i++) {
            Z[3+i] = -Z[3+i];
        }
    }

    // UPDATE STEP X_new, P_new = ...
    tmp[0] = -X[0] + Z[0];
	tmp[1] = -X[1] + Z[1];
	tmp[2] = -X[2] + Z[2];
	tmp[3] = -X[6]*ekf_use_quat + Z[3];
	tmp[4] = -X[7]*ekf_use_quat + Z[4];
	tmp[5] = -X[8]*ekf_use_quat + Z[5];
	tmp[6] = -X[9]*ekf_use_quat + Z[6];
	tmp[7] = K_mocap[48]*ekf_use_quat;
	tmp[8] = K_mocap[64]*ekf_use_quat;
	tmp[9] = K_mocap[80]*ekf_use_quat;
	tmp[10] = K_mocap[96]*ekf_use_quat;
	tmp[11] = 1 - K_mocap[0];
	tmp[12] = K_mocap[49]*ekf_use_quat;
	tmp[13] = K_mocap[65]*ekf_use_quat;
	tmp[14] = K_mocap[81]*ekf_use_quat;
	tmp[15] = K_mocap[97]*ekf_use_quat;
	tmp[16] = 1 - K_mocap[17];
	tmp[17] = K_mocap[50]*ekf_use_quat;
	tmp[18] = K_mocap[66]*ekf_use_quat;
	tmp[19] = K_mocap[82]*ekf_use_quat;
	tmp[20] = K_mocap[98]*ekf_use_quat;
	tmp[21] = 1 - K_mocap[34];
	tmp[22] = K_mocap[51]*ekf_use_quat;
	tmp[23] = K_mocap[67]*ekf_use_quat;
	tmp[24] = K_mocap[83]*ekf_use_quat;
	tmp[25] = K_mocap[99]*ekf_use_quat;
	tmp[26] = K_mocap[100]*ekf_use_quat;
	tmp[27] = K_mocap[52]*ekf_use_quat;
	tmp[28] = K_mocap[68]*ekf_use_quat;
	tmp[29] = K_mocap[84]*ekf_use_quat;
	tmp[30] = K_mocap[101]*ekf_use_quat;
	tmp[31] = K_mocap[53]*ekf_use_quat;
	tmp[32] = K_mocap[69]*ekf_use_quat;
	tmp[33] = K_mocap[85]*ekf_use_quat;
	tmp[34] = K_mocap[102]*ekf_use_quat;
	tmp[35] = K_mocap[70]*ekf_use_quat;
	tmp[36] = K_mocap[86]*ekf_use_quat;
	tmp[37] = -K_mocap[54]*ekf_use_quat + 1;
	tmp[38] = K_mocap[103]*ekf_use_quat;
	tmp[39] = K_mocap[55]*ekf_use_quat;
	tmp[40] = K_mocap[87]*ekf_use_quat;
	tmp[41] = -K_mocap[71]*ekf_use_quat + 1;
	tmp[42] = K_mocap[104]*ekf_use_quat;
	tmp[43] = K_mocap[56]*ekf_use_quat;
	tmp[44] = K_mocap[72]*ekf_use_quat;
	tmp[45] = -K_mocap[88]*ekf_use_quat + 1;
	tmp[46] = K_mocap[57]*ekf_use_quat;
	tmp[47] = K_mocap[73]*ekf_use_quat;
	tmp[48] = K_mocap[89]*ekf_use_quat;
	tmp[49] = -K_mocap[105]*ekf_use_quat + 1;
	tmp[50] = K_mocap[106]*ekf_use_quat;
	tmp[51] = K_mocap[58]*ekf_use_quat;
	tmp[52] = K_mocap[74]*ekf_use_quat;
	tmp[53] = K_mocap[90]*ekf_use_quat;
	tmp[54] = K_mocap[107]*ekf_use_quat;
	tmp[55] = K_mocap[59]*ekf_use_quat;
	tmp[56] = K_mocap[75]*ekf_use_quat;
	tmp[57] = K_mocap[91]*ekf_use_quat;
	tmp[58] = K_mocap[108]*ekf_use_quat;
	tmp[59] = K_mocap[60]*ekf_use_quat;
	tmp[60] = K_mocap[76]*ekf_use_quat;
	tmp[61] = K_mocap[92]*ekf_use_quat;
	tmp[62] = K_mocap[109]*ekf_use_quat;
	tmp[63] = K_mocap[61]*ekf_use_quat;
	tmp[64] = K_mocap[77]*ekf_use_quat;
	tmp[65] = K_mocap[93]*ekf_use_quat;
	tmp[66] = K_mocap[110]*ekf_use_quat;
	tmp[67] = K_mocap[62]*ekf_use_quat;
	tmp[68] = K_mocap[78]*ekf_use_quat;
	tmp[69] = K_mocap[94]*ekf_use_quat;
	X_new[0] = K_mocap[0]*tmp[0] + K_mocap[16]*tmp[1] + K_mocap[32]*tmp[2] + K_mocap[48]*tmp[3] + K_mocap[64]*tmp[4] + K_mocap[80]*tmp[5] + K_mocap[96]*tmp[6] + X[0];
	X_new[1] = K_mocap[17]*tmp[1] + K_mocap[1]*tmp[0] + K_mocap[33]*tmp[2] + K_mocap[49]*tmp[3] + K_mocap[65]*tmp[4] + K_mocap[81]*tmp[5] + K_mocap[97]*tmp[6] + X[1];
	X_new[2] = K_mocap[18]*tmp[1] + K_mocap[2]*tmp[0] + K_mocap[34]*tmp[2] + K_mocap[50]*tmp[3] + K_mocap[66]*tmp[4] + K_mocap[82]*tmp[5] + K_mocap[98]*tmp[6] + X[2];
	X_new[3] = K_mocap[19]*tmp[1] + K_mocap[35]*tmp[2] + K_mocap[3]*tmp[0] + K_mocap[51]*tmp[3] + K_mocap[67]*tmp[4] + K_mocap[83]*tmp[5] + K_mocap[99]*tmp[6] + X[3];
	X_new[4] = K_mocap[100]*tmp[6] + K_mocap[20]*tmp[1] + K_mocap[36]*tmp[2] + K_mocap[4]*tmp[0] + K_mocap[52]*tmp[3] + K_mocap[68]*tmp[4] + K_mocap[84]*tmp[5] + X[4];
	X_new[5] = K_mocap[101]*tmp[6] + K_mocap[21]*tmp[1] + K_mocap[37]*tmp[2] + K_mocap[53]*tmp[3] + K_mocap[5]*tmp[0] + K_mocap[69]*tmp[4] + K_mocap[85]*tmp[5] + X[5];
	X_new[6] = K_mocap[102]*tmp[6] + K_mocap[22]*tmp[1] + K_mocap[38]*tmp[2] + K_mocap[54]*tmp[3] + K_mocap[6]*tmp[0] + K_mocap[70]*tmp[4] + K_mocap[86]*tmp[5] + X[6];
	X_new[7] = K_mocap[103]*tmp[6] + K_mocap[23]*tmp[1] + K_mocap[39]*tmp[2] + K_mocap[55]*tmp[3] + K_mocap[71]*tmp[4] + K_mocap[7]*tmp[0] + K_mocap[87]*tmp[5] + X[7];
	X_new[8] = K_mocap[104]*tmp[6] + K_mocap[24]*tmp[1] + K_mocap[40]*tmp[2] + K_mocap[56]*tmp[3] + K_mocap[72]*tmp[4] + K_mocap[88]*tmp[5] + K_mocap[8]*tmp[0] + X[8];
	X_new[9] = K_mocap[105]*tmp[6] + K_mocap[25]*tmp[1] + K_mocap[41]*tmp[2] + K_mocap[57]*tmp[3] + K_mocap[73]*tmp[4] + K_mocap[89]*tmp[5] + K_mocap[9]*tmp[0] + X[9];
	X_new[10] = K_mocap[106]*tmp[6] + K_mocap[10]*tmp[0] + K_mocap[26]*tmp[1] + K_mocap[42]*tmp[2] + K_mocap[58]*tmp[3] + K_mocap[74]*tmp[4] + K_mocap[90]*tmp[5] + X[10];
	X_new[11] = K_mocap[107]*tmp[6] + K_mocap[11]*tmp[0] + K_mocap[27]*tmp[1] + K_mocap[43]*tmp[2] + K_mocap[59]*tmp[3] + K_mocap[75]*tmp[4] + K_mocap[91]*tmp[5] + X[11];
	X_new[12] = K_mocap[108]*tmp[6] + K_mocap[12]*tmp[0] + K_mocap[28]*tmp[1] + K_mocap[44]*tmp[2] + K_mocap[60]*tmp[3] + K_mocap[76]*tmp[4] + K_mocap[92]*tmp[5] + X[12];
	X_new[13] = K_mocap[109]*tmp[6] + K_mocap[13]*tmp[0] + K_mocap[29]*tmp[1] + K_mocap[45]*tmp[2] + K_mocap[61]*tmp[3] + K_mocap[77]*tmp[4] + K_mocap[93]*tmp[5] + X[13];
	X_new[14] = K_mocap[110]*tmp[6] + K_mocap[14]*tmp[0] + K_mocap[30]*tmp[1] + K_mocap[46]*tmp[2] + K_mocap[62]*tmp[3] + K_mocap[78]*tmp[4] + K_mocap[94]*tmp[5] + X[14];
	X_new[15] = K_mocap[111]*tmp[6] + K_mocap[15]*tmp[0] + K_mocap[31]*tmp[1] + K_mocap[47]*tmp[2] + K_mocap[63]*tmp[3] + K_mocap[79]*tmp[4] + K_mocap[95]*tmp[5] + X[15];
	P_new[0] = -K_mocap[16]*P[1] - K_mocap[32]*P[3] + P[0]*tmp[11] - P[21]*tmp[7] - P[28]*tmp[8] - P[36]*tmp[9] - P[45]*tmp[10];
	P_new[1] = -K_mocap[16]*P[2] - K_mocap[32]*P[4] + P[1]*tmp[11] - P[22]*tmp[7] - P[29]*tmp[8] - P[37]*tmp[9] - P[46]*tmp[10];
	P_new[3] = -K_mocap[16]*P[4] - K_mocap[32]*P[5] - P[23]*tmp[7] - P[30]*tmp[8] - P[38]*tmp[9] + P[3]*tmp[11] - P[47]*tmp[10];
	P_new[6] = -K_mocap[16]*P[7] - K_mocap[32]*P[8] - P[24]*tmp[7] - P[31]*tmp[8] - P[39]*tmp[9] - P[48]*tmp[10] + P[6]*tmp[11];
	P_new[10] = -K_mocap[16]*P[11] - K_mocap[32]*P[12] + P[10]*tmp[11] - P[25]*tmp[7] - P[32]*tmp[8] - P[40]*tmp[9] - P[49]*tmp[10];
	P_new[15] = -K_mocap[16]*P[16] - K_mocap[32]*P[17] + P[15]*tmp[11] - P[26]*tmp[7] - P[33]*tmp[8] - P[41]*tmp[9] - P[50]*tmp[10];
	P_new[21] = -K_mocap[16]*P[22] - K_mocap[32]*P[23] + P[21]*tmp[11] - P[27]*tmp[7] - P[34]*tmp[8] - P[42]*tmp[9] - P[51]*tmp[10];
	P_new[28] = -K_mocap[16]*P[29] - K_mocap[32]*P[30] + P[28]*tmp[11] - P[34]*tmp[7] - P[35]*tmp[8] - P[43]*tmp[9] - P[52]*tmp[10];
	P_new[36] = -K_mocap[16]*P[37] - K_mocap[32]*P[38] + P[36]*tmp[11] - P[42]*tmp[7] - P[43]*tmp[8] - P[44]*tmp[9] - P[53]*tmp[10];
	P_new[45] = -K_mocap[16]*P[46] - K_mocap[32]*P[47] + P[45]*tmp[11] - P[51]*tmp[7] - P[52]*tmp[8] - P[53]*tmp[9] - P[54]*tmp[10];
	P_new[55] = -K_mocap[16]*P[56] - K_mocap[32]*P[57] + P[55]*tmp[11] - P[61]*tmp[7] - P[62]*tmp[8] - P[63]*tmp[9] - P[64]*tmp[10];
	P_new[66] = -K_mocap[16]*P[67] - K_mocap[32]*P[68] + P[66]*tmp[11] - P[72]*tmp[7] - P[73]*tmp[8] - P[74]*tmp[9] - P[75]*tmp[10];
	P_new[78] = -K_mocap[16]*P[79] - K_mocap[32]*P[80] + P[78]*tmp[11] - P[84]*tmp[7] - P[85]*tmp[8] - P[86]*tmp[9] - P[87]*tmp[10];
	P_new[91] = -K_mocap[16]*P[92] - K_mocap[32]*P[93] - P[100]*tmp[10] + P[91]*tmp[11] - P[97]*tmp[7] - P[98]*tmp[8] - P[99]*tmp[9];
	P_new[105] = -K_mocap[16]*P[106] - K_mocap[32]*P[107] + P[105]*tmp[11] - P[111]*tmp[7] - P[112]*tmp[8] - P[113]*tmp[9] - P[114]*tmp[10];
	P_new[120] = -K_mocap[16]*P[121] - K_mocap[32]*P[122] + P[120]*tmp[11] - P[126]*tmp[7] - P[127]*tmp[8] - P[128]*tmp[9] - P[129]*tmp[10];
	P_new[2] = -K_mocap[1]*P[1] - K_mocap[33]*P[4] - P[22]*tmp[12] - P[29]*tmp[13] + P[2]*tmp[16] - P[37]*tmp[14] - P[46]*tmp[15];
	P_new[4] = -K_mocap[1]*P[3] - K_mocap[33]*P[5] - P[23]*tmp[12] - P[30]*tmp[13] - P[38]*tmp[14] - P[47]*tmp[15] + P[4]*tmp[16];
	P_new[7] = -K_mocap[1]*P[6] - K_mocap[33]*P[8] - P[24]*tmp[12] - P[31]*tmp[13] - P[39]*tmp[14] - P[48]*tmp[15] + P[7]*tmp[16];
	P_new[11] = -K_mocap[1]*P[10] - K_mocap[33]*P[12] + P[11]*tmp[16] - P[25]*tmp[12] - P[32]*tmp[13] - P[40]*tmp[14] - P[49]*tmp[15];
	P_new[16] = -K_mocap[1]*P[15] - K_mocap[33]*P[17] + P[16]*tmp[16] - P[26]*tmp[12] - P[33]*tmp[13] - P[41]*tmp[14] - P[50]*tmp[15];
	P_new[22] = -K_mocap[1]*P[21] - K_mocap[33]*P[23] + P[22]*tmp[16] - P[27]*tmp[12] - P[34]*tmp[13] - P[42]*tmp[14] - P[51]*tmp[15];
	P_new[29] = -K_mocap[1]*P[28] - K_mocap[33]*P[30] + P[29]*tmp[16] - P[34]*tmp[12] - P[35]*tmp[13] - P[43]*tmp[14] - P[52]*tmp[15];
	P_new[37] = -K_mocap[1]*P[36] - K_mocap[33]*P[38] + P[37]*tmp[16] - P[42]*tmp[12] - P[43]*tmp[13] - P[44]*tmp[14] - P[53]*tmp[15];
	P_new[46] = -K_mocap[1]*P[45] - K_mocap[33]*P[47] + P[46]*tmp[16] - P[51]*tmp[12] - P[52]*tmp[13] - P[53]*tmp[14] - P[54]*tmp[15];
	P_new[56] = -K_mocap[1]*P[55] - K_mocap[33]*P[57] + P[56]*tmp[16] - P[61]*tmp[12] - P[62]*tmp[13] - P[63]*tmp[14] - P[64]*tmp[15];
	P_new[67] = -K_mocap[1]*P[66] - K_mocap[33]*P[68] + P[67]*tmp[16] - P[72]*tmp[12] - P[73]*tmp[13] - P[74]*tmp[14] - P[75]*tmp[15];
	P_new[79] = -K_mocap[1]*P[78] - K_mocap[33]*P[80] + P[79]*tmp[16] - P[84]*tmp[12] - P[85]*tmp[13] - P[86]*tmp[14] - P[87]*tmp[15];
	P_new[92] = -K_mocap[1]*P[91] - K_mocap[33]*P[93] - P[100]*tmp[15] + P[92]*tmp[16] - P[97]*tmp[12] - P[98]*tmp[13] - P[99]*tmp[14];
	P_new[106] = -K_mocap[1]*P[105] - K_mocap[33]*P[107] + P[106]*tmp[16] - P[111]*tmp[12] - P[112]*tmp[13] - P[113]*tmp[14] - P[114]*tmp[15];
	P_new[121] = -K_mocap[1]*P[120] - K_mocap[33]*P[122] + P[121]*tmp[16] - P[126]*tmp[12] - P[127]*tmp[13] - P[128]*tmp[14] - P[129]*tmp[15];
	P_new[5] = -K_mocap[18]*P[4] - K_mocap[2]*P[3] - P[23]*tmp[17] - P[30]*tmp[18] - P[38]*tmp[19] - P[47]*tmp[20] + P[5]*tmp[21];
	P_new[8] = -K_mocap[18]*P[7] - K_mocap[2]*P[6] - P[24]*tmp[17] - P[31]*tmp[18] - P[39]*tmp[19] - P[48]*tmp[20] + P[8]*tmp[21];
	P_new[12] = -K_mocap[18]*P[11] - K_mocap[2]*P[10] + P[12]*tmp[21] - P[25]*tmp[17] - P[32]*tmp[18] - P[40]*tmp[19] - P[49]*tmp[20];
	P_new[17] = -K_mocap[18]*P[16] - K_mocap[2]*P[15] + P[17]*tmp[21] - P[26]*tmp[17] - P[33]*tmp[18] - P[41]*tmp[19] - P[50]*tmp[20];
	P_new[23] = -K_mocap[18]*P[22] - K_mocap[2]*P[21] + P[23]*tmp[21] - P[27]*tmp[17] - P[34]*tmp[18] - P[42]*tmp[19] - P[51]*tmp[20];
	P_new[30] = -K_mocap[18]*P[29] - K_mocap[2]*P[28] + P[30]*tmp[21] - P[34]*tmp[17] - P[35]*tmp[18] - P[43]*tmp[19] - P[52]*tmp[20];
	P_new[38] = -K_mocap[18]*P[37] - K_mocap[2]*P[36] + P[38]*tmp[21] - P[42]*tmp[17] - P[43]*tmp[18] - P[44]*tmp[19] - P[53]*tmp[20];
	P_new[47] = -K_mocap[18]*P[46] - K_mocap[2]*P[45] + P[47]*tmp[21] - P[51]*tmp[17] - P[52]*tmp[18] - P[53]*tmp[19] - P[54]*tmp[20];
	P_new[57] = -K_mocap[18]*P[56] - K_mocap[2]*P[55] + P[57]*tmp[21] - P[61]*tmp[17] - P[62]*tmp[18] - P[63]*tmp[19] - P[64]*tmp[20];
	P_new[68] = -K_mocap[18]*P[67] - K_mocap[2]*P[66] + P[68]*tmp[21] - P[72]*tmp[17] - P[73]*tmp[18] - P[74]*tmp[19] - P[75]*tmp[20];
	P_new[80] = -K_mocap[18]*P[79] - K_mocap[2]*P[78] + P[80]*tmp[21] - P[84]*tmp[17] - P[85]*tmp[18] - P[86]*tmp[19] - P[87]*tmp[20];
	P_new[93] = -K_mocap[18]*P[92] - K_mocap[2]*P[91] - P[100]*tmp[20] + P[93]*tmp[21] - P[97]*tmp[17] - P[98]*tmp[18] - P[99]*tmp[19];
	P_new[107] = -K_mocap[18]*P[106] - K_mocap[2]*P[105] + P[107]*tmp[21] - P[111]*tmp[17] - P[112]*tmp[18] - P[113]*tmp[19] - P[114]*tmp[20];
	P_new[122] = -K_mocap[18]*P[121] - K_mocap[2]*P[120] + P[122]*tmp[21] - P[126]*tmp[17] - P[127]*tmp[18] - P[128]*tmp[19] - P[129]*tmp[20];
	P_new[9] = -K_mocap[19]*P[7] - K_mocap[35]*P[8] - K_mocap[3]*P[6] - P[24]*tmp[22] - P[31]*tmp[23] - P[39]*tmp[24] - P[48]*tmp[25] + P[9];
	P_new[13] = -K_mocap[19]*P[11] - K_mocap[35]*P[12] - K_mocap[3]*P[10] + P[13] - P[25]*tmp[22] - P[32]*tmp[23] - P[40]*tmp[24] - P[49]*tmp[25];
	P_new[18] = -K_mocap[19]*P[16] - K_mocap[35]*P[17] - K_mocap[3]*P[15] + P[18] - P[26]*tmp[22] - P[33]*tmp[23] - P[41]*tmp[24] - P[50]*tmp[25];
	P_new[24] = -K_mocap[19]*P[22] - K_mocap[35]*P[23] - K_mocap[3]*P[21] + P[24] - P[27]*tmp[22] - P[34]*tmp[23] - P[42]*tmp[24] - P[51]*tmp[25];
	P_new[31] = -K_mocap[19]*P[29] - K_mocap[35]*P[30] - K_mocap[3]*P[28] + P[31] - P[34]*tmp[22] - P[35]*tmp[23] - P[43]*tmp[24] - P[52]*tmp[25];
	P_new[39] = -K_mocap[19]*P[37] - K_mocap[35]*P[38] - K_mocap[3]*P[36] + P[39] - P[42]*tmp[22] - P[43]*tmp[23] - P[44]*tmp[24] - P[53]*tmp[25];
	P_new[48] = -K_mocap[19]*P[46] - K_mocap[35]*P[47] - K_mocap[3]*P[45] + P[48] - P[51]*tmp[22] - P[52]*tmp[23] - P[53]*tmp[24] - P[54]*tmp[25];
	P_new[58] = -K_mocap[19]*P[56] - K_mocap[35]*P[57] - K_mocap[3]*P[55] + P[58] - P[61]*tmp[22] - P[62]*tmp[23] - P[63]*tmp[24] - P[64]*tmp[25];
	P_new[69] = -K_mocap[19]*P[67] - K_mocap[35]*P[68] - K_mocap[3]*P[66] + P[69] - P[72]*tmp[22] - P[73]*tmp[23] - P[74]*tmp[24] - P[75]*tmp[25];
	P_new[81] = -K_mocap[19]*P[79] - K_mocap[35]*P[80] - K_mocap[3]*P[78] + P[81] - P[84]*tmp[22] - P[85]*tmp[23] - P[86]*tmp[24] - P[87]*tmp[25];
	P_new[94] = -K_mocap[19]*P[92] - K_mocap[35]*P[93] - K_mocap[3]*P[91] - P[100]*tmp[25] + P[94] - P[97]*tmp[22] - P[98]*tmp[23] - P[99]*tmp[24];
	P_new[108] = -K_mocap[19]*P[106] - K_mocap[35]*P[107] - K_mocap[3]*P[105] + P[108] - P[111]*tmp[22] - P[112]*tmp[23] - P[113]*tmp[24] - P[114]*tmp[25];
	P_new[123] = -K_mocap[19]*P[121] - K_mocap[35]*P[122] - K_mocap[3]*P[120] + P[123] - P[126]*tmp[22] - P[127]*tmp[23] - P[128]*tmp[24] - P[129]*tmp[25];
	P_new[14] = -K_mocap[20]*P[11] - K_mocap[36]*P[12] - K_mocap[4]*P[10] + P[14] - P[25]*tmp[27] - P[32]*tmp[28] - P[40]*tmp[29] - P[49]*tmp[26];
	P_new[19] = -K_mocap[20]*P[16] - K_mocap[36]*P[17] - K_mocap[4]*P[15] + P[19] - P[26]*tmp[27] - P[33]*tmp[28] - P[41]*tmp[29] - P[50]*tmp[26];
	P_new[25] = -K_mocap[20]*P[22] - K_mocap[36]*P[23] - K_mocap[4]*P[21] + P[25] - P[27]*tmp[27] - P[34]*tmp[28] - P[42]*tmp[29] - P[51]*tmp[26];
	P_new[32] = -K_mocap[20]*P[29] - K_mocap[36]*P[30] - K_mocap[4]*P[28] + P[32] - P[34]*tmp[27] - P[35]*tmp[28] - P[43]*tmp[29] - P[52]*tmp[26];
	P_new[40] = -K_mocap[20]*P[37] - K_mocap[36]*P[38] - K_mocap[4]*P[36] + P[40] - P[42]*tmp[27] - P[43]*tmp[28] - P[44]*tmp[29] - P[53]*tmp[26];
	P_new[49] = -K_mocap[20]*P[46] - K_mocap[36]*P[47] - K_mocap[4]*P[45] + P[49] - P[51]*tmp[27] - P[52]*tmp[28] - P[53]*tmp[29] - P[54]*tmp[26];
	P_new[59] = -K_mocap[20]*P[56] - K_mocap[36]*P[57] - K_mocap[4]*P[55] + P[59] - P[61]*tmp[27] - P[62]*tmp[28] - P[63]*tmp[29] - P[64]*tmp[26];
	P_new[70] = -K_mocap[20]*P[67] - K_mocap[36]*P[68] - K_mocap[4]*P[66] + P[70] - P[72]*tmp[27] - P[73]*tmp[28] - P[74]*tmp[29] - P[75]*tmp[26];
	P_new[82] = -K_mocap[20]*P[79] - K_mocap[36]*P[80] - K_mocap[4]*P[78] + P[82] - P[84]*tmp[27] - P[85]*tmp[28] - P[86]*tmp[29] - P[87]*tmp[26];
	P_new[95] = -K_mocap[20]*P[92] - K_mocap[36]*P[93] - K_mocap[4]*P[91] - P[100]*tmp[26] + P[95] - P[97]*tmp[27] - P[98]*tmp[28] - P[99]*tmp[29];
	P_new[109] = -K_mocap[20]*P[106] - K_mocap[36]*P[107] - K_mocap[4]*P[105] + P[109] - P[111]*tmp[27] - P[112]*tmp[28] - P[113]*tmp[29] - P[114]*tmp[26];
	P_new[124] = -K_mocap[20]*P[121] - K_mocap[36]*P[122] - K_mocap[4]*P[120] + P[124] - P[126]*tmp[27] - P[127]*tmp[28] - P[128]*tmp[29] - P[129]*tmp[26];
	P_new[20] = -K_mocap[21]*P[16] - K_mocap[37]*P[17] - K_mocap[5]*P[15] + P[20] - P[26]*tmp[31] - P[33]*tmp[32] - P[41]*tmp[33] - P[50]*tmp[30];
	P_new[26] = -K_mocap[21]*P[22] - K_mocap[37]*P[23] - K_mocap[5]*P[21] + P[26] - P[27]*tmp[31] - P[34]*tmp[32] - P[42]*tmp[33] - P[51]*tmp[30];
	P_new[33] = -K_mocap[21]*P[29] - K_mocap[37]*P[30] - K_mocap[5]*P[28] + P[33] - P[34]*tmp[31] - P[35]*tmp[32] - P[43]*tmp[33] - P[52]*tmp[30];
	P_new[41] = -K_mocap[21]*P[37] - K_mocap[37]*P[38] - K_mocap[5]*P[36] + P[41] - P[42]*tmp[31] - P[43]*tmp[32] - P[44]*tmp[33] - P[53]*tmp[30];
	P_new[50] = -K_mocap[21]*P[46] - K_mocap[37]*P[47] - K_mocap[5]*P[45] + P[50] - P[51]*tmp[31] - P[52]*tmp[32] - P[53]*tmp[33] - P[54]*tmp[30];
	P_new[60] = -K_mocap[21]*P[56] - K_mocap[37]*P[57] - K_mocap[5]*P[55] + P[60] - P[61]*tmp[31] - P[62]*tmp[32] - P[63]*tmp[33] - P[64]*tmp[30];
	P_new[71] = -K_mocap[21]*P[67] - K_mocap[37]*P[68] - K_mocap[5]*P[66] + P[71] - P[72]*tmp[31] - P[73]*tmp[32] - P[74]*tmp[33] - P[75]*tmp[30];
	P_new[83] = -K_mocap[21]*P[79] - K_mocap[37]*P[80] - K_mocap[5]*P[78] + P[83] - P[84]*tmp[31] - P[85]*tmp[32] - P[86]*tmp[33] - P[87]*tmp[30];
	P_new[96] = -K_mocap[21]*P[92] - K_mocap[37]*P[93] - K_mocap[5]*P[91] - P[100]*tmp[30] + P[96] - P[97]*tmp[31] - P[98]*tmp[32] - P[99]*tmp[33];
	P_new[110] = -K_mocap[21]*P[106] - K_mocap[37]*P[107] - K_mocap[5]*P[105] + P[110] - P[111]*tmp[31] - P[112]*tmp[32] - P[113]*tmp[33] - P[114]*tmp[30];
	P_new[125] = -K_mocap[21]*P[121] - K_mocap[37]*P[122] - K_mocap[5]*P[120] + P[125] - P[126]*tmp[31] - P[127]*tmp[32] - P[128]*tmp[33] - P[129]*tmp[30];
	P_new[27] = -K_mocap[22]*P[22] - K_mocap[38]*P[23] - K_mocap[6]*P[21] + P[27]*tmp[37] - P[34]*tmp[35] - P[42]*tmp[36] - P[51]*tmp[34];
	P_new[34] = -K_mocap[22]*P[29] - K_mocap[38]*P[30] - K_mocap[6]*P[28] + P[34]*tmp[37] - P[35]*tmp[35] - P[43]*tmp[36] - P[52]*tmp[34];
	P_new[42] = -K_mocap[22]*P[37] - K_mocap[38]*P[38] - K_mocap[6]*P[36] + P[42]*tmp[37] - P[43]*tmp[35] - P[44]*tmp[36] - P[53]*tmp[34];
	P_new[51] = -K_mocap[22]*P[46] - K_mocap[38]*P[47] - K_mocap[6]*P[45] + P[51]*tmp[37] - P[52]*tmp[35] - P[53]*tmp[36] - P[54]*tmp[34];
	P_new[61] = -K_mocap[22]*P[56] - K_mocap[38]*P[57] - K_mocap[6]*P[55] + P[61]*tmp[37] - P[62]*tmp[35] - P[63]*tmp[36] - P[64]*tmp[34];
	P_new[72] = -K_mocap[22]*P[67] - K_mocap[38]*P[68] - K_mocap[6]*P[66] + P[72]*tmp[37] - P[73]*tmp[35] - P[74]*tmp[36] - P[75]*tmp[34];
	P_new[84] = -K_mocap[22]*P[79] - K_mocap[38]*P[80] - K_mocap[6]*P[78] + P[84]*tmp[37] - P[85]*tmp[35] - P[86]*tmp[36] - P[87]*tmp[34];
	P_new[97] = -K_mocap[22]*P[92] - K_mocap[38]*P[93] - K_mocap[6]*P[91] - P[100]*tmp[34] + P[97]*tmp[37] - P[98]*tmp[35] - P[99]*tmp[36];
	P_new[111] = -K_mocap[22]*P[106] - K_mocap[38]*P[107] - K_mocap[6]*P[105] + P[111]*tmp[37] - P[112]*tmp[35] - P[113]*tmp[36] - P[114]*tmp[34];
	P_new[126] = -K_mocap[22]*P[121] - K_mocap[38]*P[122] - K_mocap[6]*P[120] + P[126]*tmp[37] - P[127]*tmp[35] - P[128]*tmp[36] - P[129]*tmp[34];
	P_new[35] = -K_mocap[23]*P[29] - K_mocap[39]*P[30] - K_mocap[7]*P[28] - P[34]*tmp[39] + P[35]*tmp[41] - P[43]*tmp[40] - P[52]*tmp[38];
	P_new[43] = -K_mocap[23]*P[37] - K_mocap[39]*P[38] - K_mocap[7]*P[36] - P[42]*tmp[39] + P[43]*tmp[41] - P[44]*tmp[40] - P[53]*tmp[38];
	P_new[52] = -K_mocap[23]*P[46] - K_mocap[39]*P[47] - K_mocap[7]*P[45] - P[51]*tmp[39] + P[52]*tmp[41] - P[53]*tmp[40] - P[54]*tmp[38];
	P_new[62] = -K_mocap[23]*P[56] - K_mocap[39]*P[57] - K_mocap[7]*P[55] - P[61]*tmp[39] + P[62]*tmp[41] - P[63]*tmp[40] - P[64]*tmp[38];
	P_new[73] = -K_mocap[23]*P[67] - K_mocap[39]*P[68] - K_mocap[7]*P[66] - P[72]*tmp[39] + P[73]*tmp[41] - P[74]*tmp[40] - P[75]*tmp[38];
	P_new[85] = -K_mocap[23]*P[79] - K_mocap[39]*P[80] - K_mocap[7]*P[78] - P[84]*tmp[39] + P[85]*tmp[41] - P[86]*tmp[40] - P[87]*tmp[38];
	P_new[98] = -K_mocap[23]*P[92] - K_mocap[39]*P[93] - K_mocap[7]*P[91] - P[100]*tmp[38] - P[97]*tmp[39] + P[98]*tmp[41] - P[99]*tmp[40];
	P_new[112] = -K_mocap[23]*P[106] - K_mocap[39]*P[107] - K_mocap[7]*P[105] - P[111]*tmp[39] + P[112]*tmp[41] - P[113]*tmp[40] - P[114]*tmp[38];
	P_new[127] = -K_mocap[23]*P[121] - K_mocap[39]*P[122] - K_mocap[7]*P[120] - P[126]*tmp[39] + P[127]*tmp[41] - P[128]*tmp[40] - P[129]*tmp[38];
	P_new[44] = -K_mocap[24]*P[37] - K_mocap[40]*P[38] - K_mocap[8]*P[36] - P[42]*tmp[43] - P[43]*tmp[44] + P[44]*tmp[45] - P[53]*tmp[42];
	P_new[53] = -K_mocap[24]*P[46] - K_mocap[40]*P[47] - K_mocap[8]*P[45] - P[51]*tmp[43] - P[52]*tmp[44] + P[53]*tmp[45] - P[54]*tmp[42];
	P_new[63] = -K_mocap[24]*P[56] - K_mocap[40]*P[57] - K_mocap[8]*P[55] - P[61]*tmp[43] - P[62]*tmp[44] + P[63]*tmp[45] - P[64]*tmp[42];
	P_new[74] = -K_mocap[24]*P[67] - K_mocap[40]*P[68] - K_mocap[8]*P[66] - P[72]*tmp[43] - P[73]*tmp[44] + P[74]*tmp[45] - P[75]*tmp[42];
	P_new[86] = -K_mocap[24]*P[79] - K_mocap[40]*P[80] - K_mocap[8]*P[78] - P[84]*tmp[43] - P[85]*tmp[44] + P[86]*tmp[45] - P[87]*tmp[42];
	P_new[99] = -K_mocap[24]*P[92] - K_mocap[40]*P[93] - K_mocap[8]*P[91] - P[100]*tmp[42] - P[97]*tmp[43] - P[98]*tmp[44] + P[99]*tmp[45];
	P_new[113] = -K_mocap[24]*P[106] - K_mocap[40]*P[107] - K_mocap[8]*P[105] - P[111]*tmp[43] - P[112]*tmp[44] + P[113]*tmp[45] - P[114]*tmp[42];
	P_new[128] = -K_mocap[24]*P[121] - K_mocap[40]*P[122] - K_mocap[8]*P[120] - P[126]*tmp[43] - P[127]*tmp[44] + P[128]*tmp[45] - P[129]*tmp[42];
	P_new[54] = -K_mocap[25]*P[46] - K_mocap[41]*P[47] - K_mocap[9]*P[45] - P[51]*tmp[46] - P[52]*tmp[47] - P[53]*tmp[48] + P[54]*tmp[49];
	P_new[64] = -K_mocap[25]*P[56] - K_mocap[41]*P[57] - K_mocap[9]*P[55] - P[61]*tmp[46] - P[62]*tmp[47] - P[63]*tmp[48] + P[64]*tmp[49];
	P_new[75] = -K_mocap[25]*P[67] - K_mocap[41]*P[68] - K_mocap[9]*P[66] - P[72]*tmp[46] - P[73]*tmp[47] - P[74]*tmp[48] + P[75]*tmp[49];
	P_new[87] = -K_mocap[25]*P[79] - K_mocap[41]*P[80] - K_mocap[9]*P[78] - P[84]*tmp[46] - P[85]*tmp[47] - P[86]*tmp[48] + P[87]*tmp[49];
	P_new[100] = -K_mocap[25]*P[92] - K_mocap[41]*P[93] - K_mocap[9]*P[91] + P[100]*tmp[49] - P[97]*tmp[46] - P[98]*tmp[47] - P[99]*tmp[48];
	P_new[114] = -K_mocap[25]*P[106] - K_mocap[41]*P[107] - K_mocap[9]*P[105] - P[111]*tmp[46] - P[112]*tmp[47] - P[113]*tmp[48] + P[114]*tmp[49];
	P_new[129] = -K_mocap[25]*P[121] - K_mocap[41]*P[122] - K_mocap[9]*P[120] - P[126]*tmp[46] - P[127]*tmp[47] - P[128]*tmp[48] + P[129]*tmp[49];
	P_new[65] = -K_mocap[10]*P[55] - K_mocap[26]*P[56] - K_mocap[42]*P[57] - P[61]*tmp[51] - P[62]*tmp[52] - P[63]*tmp[53] - P[64]*tmp[50] + P[65];
	P_new[76] = -K_mocap[10]*P[66] - K_mocap[26]*P[67] - K_mocap[42]*P[68] - P[72]*tmp[51] - P[73]*tmp[52] - P[74]*tmp[53] - P[75]*tmp[50] + P[76];
	P_new[88] = -K_mocap[10]*P[78] - K_mocap[26]*P[79] - K_mocap[42]*P[80] - P[84]*tmp[51] - P[85]*tmp[52] - P[86]*tmp[53] - P[87]*tmp[50] + P[88];
	P_new[101] = -K_mocap[10]*P[91] - K_mocap[26]*P[92] - K_mocap[42]*P[93] - P[100]*tmp[50] + P[101] - P[97]*tmp[51] - P[98]*tmp[52] - P[99]*tmp[53];
	P_new[115] = -K_mocap[10]*P[105] - K_mocap[26]*P[106] - K_mocap[42]*P[107] - P[111]*tmp[51] - P[112]*tmp[52] - P[113]*tmp[53] - P[114]*tmp[50] + P[115];
	P_new[130] = -K_mocap[10]*P[120] - K_mocap[26]*P[121] - K_mocap[42]*P[122] - P[126]*tmp[51] - P[127]*tmp[52] - P[128]*tmp[53] - P[129]*tmp[50] + P[130];
	P_new[77] = -K_mocap[11]*P[66] - K_mocap[27]*P[67] - K_mocap[43]*P[68] - P[72]*tmp[55] - P[73]*tmp[56] - P[74]*tmp[57] - P[75]*tmp[54] + P[77];
	P_new[89] = -K_mocap[11]*P[78] - K_mocap[27]*P[79] - K_mocap[43]*P[80] - P[84]*tmp[55] - P[85]*tmp[56] - P[86]*tmp[57] - P[87]*tmp[54] + P[89];
	P_new[102] = -K_mocap[11]*P[91] - K_mocap[27]*P[92] - K_mocap[43]*P[93] - P[100]*tmp[54] + P[102] - P[97]*tmp[55] - P[98]*tmp[56] - P[99]*tmp[57];
	P_new[116] = -K_mocap[11]*P[105] - K_mocap[27]*P[106] - K_mocap[43]*P[107] - P[111]*tmp[55] - P[112]*tmp[56] - P[113]*tmp[57] - P[114]*tmp[54] + P[116];
	P_new[131] = -K_mocap[11]*P[120] - K_mocap[27]*P[121] - K_mocap[43]*P[122] - P[126]*tmp[55] - P[127]*tmp[56] - P[128]*tmp[57] - P[129]*tmp[54] + P[131];
	P_new[90] = -K_mocap[12]*P[78] - K_mocap[28]*P[79] - K_mocap[44]*P[80] - P[84]*tmp[59] - P[85]*tmp[60] - P[86]*tmp[61] - P[87]*tmp[58] + P[90];
	P_new[103] = -K_mocap[12]*P[91] - K_mocap[28]*P[92] - K_mocap[44]*P[93] - P[100]*tmp[58] + P[103] - P[97]*tmp[59] - P[98]*tmp[60] - P[99]*tmp[61];
	P_new[117] = -K_mocap[12]*P[105] - K_mocap[28]*P[106] - K_mocap[44]*P[107] - P[111]*tmp[59] - P[112]*tmp[60] - P[113]*tmp[61] - P[114]*tmp[58] + P[117];
	P_new[132] = -K_mocap[12]*P[120] - K_mocap[28]*P[121] - K_mocap[44]*P[122] - P[126]*tmp[59] - P[127]*tmp[60] - P[128]*tmp[61] - P[129]*tmp[58] + P[132];
	P_new[104] = -K_mocap[13]*P[91] - K_mocap[29]*P[92] - K_mocap[45]*P[93] - P[100]*tmp[62] + P[104] - P[97]*tmp[63] - P[98]*tmp[64] - P[99]*tmp[65];
	P_new[118] = -K_mocap[13]*P[105] - K_mocap[29]*P[106] - K_mocap[45]*P[107] - P[111]*tmp[63] - P[112]*tmp[64] - P[113]*tmp[65] - P[114]*tmp[62] + P[118];
	P_new[133] = -K_mocap[13]*P[120] - K_mocap[29]*P[121] - K_mocap[45]*P[122] - P[126]*tmp[63] - P[127]*tmp[64] - P[128]*tmp[65] - P[129]*tmp[62] + P[133];
	P_new[119] = -K_mocap[14]*P[105] - K_mocap[30]*P[106] - K_mocap[46]*P[107] - P[111]*tmp[67] - P[112]*tmp[68] - P[113]*tmp[69] - P[114]*tmp[66] + P[119];
	P_new[134] = -K_mocap[14]*P[120] - K_mocap[30]*P[121] - K_mocap[46]*P[122] - P[126]*tmp[67] - P[127]*tmp[68] - P[128]*tmp[69] - P[129]*tmp[66] + P[134];
	P_new[135] = -K_mocap[111]*P[129]*ekf_use_quat - K_mocap[15]*P[120] - K_mocap[31]*P[121] - K_mocap[47]*P[122] - K_mocap[63]*P[126]*ekf_use_quat - K_mocap[79]*P[127]*ekf_use_quat - K_mocap[95]*P[128]*ekf_use_quat + P[135];

    // swap X, X_new and P, P_new pointers
    swap_ptr = X;
    X = X_new;
    X_new = swap_ptr;

    normalize_quaternion(X+6);

    swap_ptr = P;
    P = P_new;
    P_new = swap_ptr;
}

void ekf_update_vbody(float Z[N_MEASUREMENTS_VBODY]) {
    // prepare gain calculation
    tmp[0] = powf(X[6], 2);
	tmp[1] = powf(X[7], 2);
	tmp[2] = powf(X[8], 2);
	tmp[3] = powf(X[9], 2);
	tmp[4] = tmp[0] + tmp[1] + tmp[2] + tmp[3];
	tmp[5] = 1.0/tmp[4];
	tmp[6] = 2*tmp[5];
	tmp[7] = X[6]*X[8];
	tmp[8] = 2*X[7]*X[9]*tmp[5] - tmp[6]*tmp[7];
	tmp[9] = X[9]*tmp[6];
	tmp[10] = X[6]*tmp[9];
	tmp[11] = X[7]*X[8];
	tmp[12] = tmp[10] + tmp[11]*tmp[6];
	tmp[13] = tmp[1]*tmp[5];
	tmp[14] = tmp[2]*tmp[5];
	tmp[15] = tmp[0]*tmp[5] - tmp[3]*tmp[5];
	tmp[16] = tmp[13] - tmp[14] + tmp[15];
	tmp[17] = powf(tmp[4], -1.0/2.0);
	tmp[18] = X[3]*tmp[17];
	tmp[19] = X[4]*tmp[17];
	tmp[20] = X[5]*tmp[17];
	tmp[21] = X[6]*tmp[18] - X[8]*tmp[20] + X[9]*tmp[19];
	tmp[22] = X[7]*tmp[18] + X[8]*tmp[19] + X[9]*tmp[20];
	tmp[23] = powf(tmp[4], -3.0/2.0);
	tmp[24] = X[6]*tmp[23];
	tmp[25] = X[7]*tmp[24];
	tmp[26] = X[6]*tmp[20] - X[7]*tmp[19] + X[8]*tmp[18];
	tmp[27] = tmp[23]*tmp[7];
	tmp[28] = X[6]*tmp[19] + X[7]*tmp[20] - X[9]*tmp[18];
	tmp[29] = X[9]*tmp[24];
	tmp[30] = -tmp[28]*tmp[29];
	tmp[31] = tmp[0]*tmp[23];
	tmp[32] = X[3]*tmp[25];
	tmp[33] = X[4]*tmp[27];
	tmp[34] = X[5]*tmp[29];
	tmp[35] = -tmp[32] - tmp[33] - tmp[34];
	tmp[36] = X[7]*tmp[17];
	tmp[37] = -tmp[18];
	tmp[38] = X[4]*tmp[29];
	tmp[39] = X[5]*tmp[27];
	tmp[40] = X[3]*tmp[31] + tmp[37] + tmp[38] - tmp[39];
	tmp[41] = X[6]*tmp[17];
	tmp[42] = X[3]*tmp[29];
	tmp[43] = X[5]*tmp[25];
	tmp[44] = -X[4]*tmp[31] + tmp[19] + tmp[42] - tmp[43];
	tmp[45] = X[9]*tmp[17];
	tmp[46] = -tmp[20];
	tmp[47] = X[3]*tmp[27];
	tmp[48] = -X[4]*tmp[25];
	tmp[49] = -X[5]*tmp[31] - tmp[46] - tmp[47] - tmp[48];
	tmp[50] = X[8]*tmp[17];
	tmp[51] = tmp[17]*tmp[21] - tmp[21]*tmp[31] - tmp[22]*tmp[25] + tmp[26]*tmp[27] + tmp[30] + tmp[35]*tmp[36] - tmp[40]*tmp[41] + tmp[44]*tmp[45] - tmp[49]*tmp[50];
	tmp[52] = tmp[17]*tmp[22];
	tmp[53] = tmp[11]*tmp[23];
	tmp[54] = tmp[26]*tmp[53];
	tmp[55] = tmp[1]*tmp[23];
	tmp[56] = X[9]*tmp[23];
	tmp[57] = X[7]*tmp[56];
	tmp[58] = X[4]*tmp[57];
	tmp[59] = X[5]*tmp[53];
	tmp[60] = tmp[32] + tmp[58] - tmp[59];
	tmp[61] = X[3]*tmp[57];
	tmp[62] = -X[5]*tmp[55] + tmp[20] + tmp[48] + tmp[61];
	tmp[63] = X[4]*tmp[53];
	tmp[64] = X[5]*tmp[57];
	tmp[65] = -X[3]*tmp[55] - tmp[37] - tmp[63] - tmp[64];
	tmp[66] = X[3]*tmp[53];
	tmp[67] = X[4]*tmp[1]*tmp[23] - tmp[19] - tmp[43] - tmp[66];
	tmp[68] = -tmp[21]*tmp[25] - tmp[22]*tmp[55] - tmp[28]*tmp[57] + tmp[36]*tmp[65] - tmp[41]*tmp[60] + tmp[45]*tmp[62] - tmp[50]*tmp[67] + tmp[52] + tmp[54];
	tmp[69] = tmp[17]*tmp[28];
	tmp[70] = X[8]*tmp[56];
	tmp[71] = tmp[23]*tmp[3];
	tmp[72] = X[3]*tmp[70];
	tmp[73] = -tmp[34] + tmp[58] - tmp[72];
	tmp[74] = -tmp[19];
	tmp[75] = X[5]*tmp[70];
	tmp[76] = X[4]*tmp[71] + tmp[42] + tmp[74] - tmp[75];
	tmp[77] = X[4]*tmp[70];
	tmp[78] = -X[5]*tmp[71] - tmp[46] - tmp[61] - tmp[77];
	tmp[79] = X[3]*tmp[23]*tmp[3] - tmp[18] - tmp[38] - tmp[64];
	tmp[80] = -tmp[21]*tmp[29] - tmp[22]*tmp[57] + tmp[26]*tmp[70] - tmp[28]*tmp[71] + tmp[36]*tmp[78] - tmp[41]*tmp[76] + tmp[45]*tmp[79] - tmp[50]*tmp[73] + tmp[69];
	tmp[81] = tmp[17]*tmp[26];
	tmp[82] = tmp[22]*tmp[53];
	tmp[83] = -tmp[33] - tmp[59] + tmp[72];
	tmp[84] = tmp[23]*tmp[2];
	tmp[85] = -X[3]*tmp[84] - tmp[37] - tmp[39] + tmp[63];
	tmp[86] = -X[5]*tmp[23]*tmp[2] + tmp[20] + tmp[47] + tmp[77];
	tmp[87] = -X[4]*tmp[84] - tmp[66] - tmp[74] - tmp[75];
	tmp[88] = -X[6]*tmp[17]*tmp[86] + X[7]*tmp[17]*tmp[87] + X[9]*tmp[17]*tmp[83] - tmp[21]*tmp[27] + tmp[23]*tmp[26]*tmp[2] - tmp[28]*tmp[70] - tmp[50]*tmp[85] - tmp[81] - tmp[82];
	tmp[89] = P[18]*tmp[16] + P[19]*tmp[12] + P[20]*tmp[8] + P[26]*tmp[51] + P[33]*tmp[68] + P[41]*tmp[88] + P[50]*tmp[80];
	tmp[90] = P[13]*tmp[16] + P[14]*tmp[12] + P[19]*tmp[8] + P[25]*tmp[51] + P[32]*tmp[68] + P[40]*tmp[88] + P[49]*tmp[80];
	tmp[91] = P[13]*tmp[12] + P[18]*tmp[8] + P[24]*tmp[51] + P[31]*tmp[68] + P[39]*tmp[88] + P[48]*tmp[80] + P[9]*tmp[16];
	tmp[92] = P[24]*tmp[16] + P[25]*tmp[12] + P[26]*tmp[8] + P[27]*tmp[51] + P[34]*tmp[68] + P[42]*tmp[88] + P[51]*tmp[80];
	tmp[93] = P[31]*tmp[16] + P[32]*tmp[12] + P[33]*tmp[8] + P[34]*tmp[51] + P[35]*tmp[68] + P[43]*tmp[88] + P[52]*tmp[80];
	tmp[94] = P[48]*tmp[16] + P[49]*tmp[12] + P[50]*tmp[8] + P[51]*tmp[51] + P[52]*tmp[68] + P[53]*tmp[88] + P[54]*tmp[80];
	tmp[95] = P[39]*tmp[16] + P[40]*tmp[12] + P[41]*tmp[8] + P[42]*tmp[51] + P[43]*tmp[68] + P[44]*tmp[88] + P[53]*tmp[80];
	tmp[96] = X[6]*X[7]*tmp[6] + X[8]*tmp[9];
	tmp[97] = 2*X[7]*X[8]*tmp[5] - tmp[10];
	tmp[98] = -tmp[13] + tmp[14] + tmp[15];
	tmp[99] = -tmp[21];
	tmp[100] = -tmp[22]*tmp[84] - tmp[27]*tmp[28] + tmp[36]*tmp[85] + tmp[41]*tmp[83] + tmp[45]*tmp[86] + tmp[50]*tmp[87] + tmp[52] - tmp[54] - tmp[70]*tmp[99];
	tmp[101] = -tmp[22]*tmp[27] - tmp[25]*tmp[26] - tmp[28]*tmp[31] - tmp[29]*tmp[99] + tmp[35]*tmp[50] + tmp[36]*tmp[49] + tmp[40]*tmp[45] + tmp[41]*tmp[44] + tmp[69];
	tmp[102] = -tmp[25]*tmp[28] - tmp[26]*tmp[55] + tmp[36]*tmp[67] + tmp[41]*tmp[62] + tmp[45]*tmp[60] + tmp[50]*tmp[65] - tmp[57]*tmp[99] + tmp[81] - tmp[82];
	tmp[103] = tmp[17]*tmp[99] - tmp[22]*tmp[70] - tmp[26]*tmp[57] + tmp[30] + tmp[36]*tmp[73] + tmp[41]*tmp[79] + tmp[45]*tmp[76] + tmp[50]*tmp[78] - tmp[71]*tmp[99];
	tmp[104] = P[18]*tmp[97] + P[19]*tmp[98] + P[20]*tmp[96] + P[26]*tmp[101] + P[33]*tmp[102] + P[41]*tmp[100] + P[50]*tmp[103];
	tmp[105] = P[13]*tmp[97] + P[14]*tmp[98] + P[19]*tmp[96] + P[25]*tmp[101] + P[32]*tmp[102] + P[40]*tmp[100] + P[49]*tmp[103];
	tmp[106] = P[13]*tmp[98] + P[18]*tmp[96] + P[24]*tmp[101] + P[31]*tmp[102] + P[39]*tmp[100] + P[48]*tmp[103] + P[9]*tmp[97];
	tmp[107] = P[24]*tmp[97] + P[25]*tmp[98] + P[26]*tmp[96] + P[27]*tmp[101] + P[34]*tmp[102] + P[42]*tmp[100] + P[51]*tmp[103];
	tmp[108] = P[31]*tmp[97] + P[32]*tmp[98] + P[33]*tmp[96] + P[34]*tmp[101] + P[35]*tmp[102] + P[43]*tmp[100] + P[52]*tmp[103];
	tmp[109] = P[48]*tmp[97] + P[49]*tmp[98] + P[50]*tmp[96] + P[51]*tmp[101] + P[52]*tmp[102] + P[53]*tmp[100] + P[54]*tmp[103];
	tmp[110] = P[39]*tmp[97] + P[40]*tmp[98] + P[41]*tmp[96] + P[42]*tmp[101] + P[43]*tmp[102] + P[44]*tmp[100] + P[53]*tmp[103];
	S_vbody[0] = R_vbody[0] + tmp[12]*tmp[90] + tmp[16]*tmp[91] + tmp[51]*tmp[92] + tmp[68]*tmp[93] + tmp[80]*tmp[94] + tmp[88]*tmp[95] + tmp[89]*tmp[8];
	S_vbody[2] = tmp[100]*tmp[95] + tmp[101]*tmp[92] + tmp[102]*tmp[93] + tmp[103]*tmp[94] + tmp[89]*tmp[96] + tmp[90]*tmp[98] + tmp[91]*tmp[97];
	S_vbody[1] = tmp[104]*tmp[8] + tmp[105]*tmp[12] + tmp[106]*tmp[16] + tmp[107]*tmp[51] + tmp[108]*tmp[68] + tmp[109]*tmp[80] + tmp[110]*tmp[88];
	S_vbody[3] = R_vbody[1] + tmp[100]*tmp[110] + tmp[101]*tmp[107] + tmp[102]*tmp[108] + tmp[103]*tmp[109] + tmp[104]*tmp[96] + tmp[105]*tmp[98] + tmp[106]*tmp[97];
	HP_vbody[0] = P[10]*tmp[12] + P[15]*tmp[8] + P[21]*tmp[51] + P[28]*tmp[68] + P[36]*tmp[88] + P[45]*tmp[80] + P[6]*tmp[16];
	HP_vbody[1] = P[10]*tmp[98] + P[15]*tmp[96] + P[21]*tmp[101] + P[28]*tmp[102] + P[36]*tmp[100] + P[45]*tmp[103] + P[6]*tmp[97];
	HP_vbody[2] = P[11]*tmp[12] + P[16]*tmp[8] + P[22]*tmp[51] + P[29]*tmp[68] + P[37]*tmp[88] + P[46]*tmp[80] + P[7]*tmp[16];
	HP_vbody[3] = P[11]*tmp[98] + P[16]*tmp[96] + P[22]*tmp[101] + P[29]*tmp[102] + P[37]*tmp[100] + P[46]*tmp[103] + P[7]*tmp[97];
	HP_vbody[4] = P[12]*tmp[12] + P[17]*tmp[8] + P[23]*tmp[51] + P[30]*tmp[68] + P[38]*tmp[88] + P[47]*tmp[80] + P[8]*tmp[16];
	HP_vbody[5] = P[12]*tmp[98] + P[17]*tmp[96] + P[23]*tmp[101] + P[30]*tmp[102] + P[38]*tmp[100] + P[47]*tmp[103] + P[8]*tmp[97];
	HP_vbody[6] = tmp[91];
	HP_vbody[7] = tmp[106];
	HP_vbody[8] = tmp[90];
	HP_vbody[9] = tmp[105];
	HP_vbody[10] = tmp[89];
	HP_vbody[11] = tmp[104];
	HP_vbody[12] = tmp[92];
	HP_vbody[13] = tmp[107];
	HP_vbody[14] = tmp[93];
	HP_vbody[15] = tmp[108];
	HP_vbody[16] = tmp[95];
	HP_vbody[17] = tmp[110];
	HP_vbody[18] = tmp[94];
	HP_vbody[19] = tmp[109];
	HP_vbody[20] = P[58]*tmp[16] + P[59]*tmp[12] + P[60]*tmp[8] + P[61]*tmp[51] + P[62]*tmp[68] + P[63]*tmp[88] + P[64]*tmp[80];
	HP_vbody[21] = P[58]*tmp[97] + P[59]*tmp[98] + P[60]*tmp[96] + P[61]*tmp[101] + P[62]*tmp[102] + P[63]*tmp[100] + P[64]*tmp[103];
	HP_vbody[22] = P[69]*tmp[16] + P[70]*tmp[12] + P[71]*tmp[8] + P[72]*tmp[51] + P[73]*tmp[68] + P[74]*tmp[88] + P[75]*tmp[80];
	HP_vbody[23] = P[69]*tmp[97] + P[70]*tmp[98] + P[71]*tmp[96] + P[72]*tmp[101] + P[73]*tmp[102] + P[74]*tmp[100] + P[75]*tmp[103];
	HP_vbody[24] = P[81]*tmp[16] + P[82]*tmp[12] + P[83]*tmp[8] + P[84]*tmp[51] + P[85]*tmp[68] + P[86]*tmp[88] + P[87]*tmp[80];
	HP_vbody[25] = P[81]*tmp[97] + P[82]*tmp[98] + P[83]*tmp[96] + P[84]*tmp[101] + P[85]*tmp[102] + P[86]*tmp[100] + P[87]*tmp[103];
	HP_vbody[26] = P[100]*tmp[80] + P[94]*tmp[16] + P[95]*tmp[12] + P[96]*tmp[8] + P[97]*tmp[51] + P[98]*tmp[68] + P[99]*tmp[88];
	HP_vbody[27] = P[100]*tmp[103] + P[94]*tmp[97] + P[95]*tmp[98] + P[96]*tmp[96] + P[97]*tmp[101] + P[98]*tmp[102] + P[99]*tmp[100];
	HP_vbody[28] = P[108]*tmp[16] + P[109]*tmp[12] + P[110]*tmp[8] + P[111]*tmp[51] + P[112]*tmp[68] + P[113]*tmp[88] + P[114]*tmp[80];
	HP_vbody[29] = P[108]*tmp[97] + P[109]*tmp[98] + P[110]*tmp[96] + P[111]*tmp[101] + P[112]*tmp[102] + P[113]*tmp[100] + P[114]*tmp[103];
	HP_vbody[30] = P[123]*tmp[16] + P[124]*tmp[12] + P[125]*tmp[8] + P[126]*tmp[51] + P[127]*tmp[68] + P[128]*tmp[88] + P[129]*tmp[80];
	HP_vbody[31] = P[123]*tmp[97] + P[124]*tmp[98] + P[125]*tmp[96] + P[126]*tmp[101] + P[127]*tmp[102] + P[128]*tmp[100] + P[129]*tmp[103];

    // renorm quat
    normalize_quaternion(X+6);

    // we have symmetric S and PHT in col major.
    // Solve K as K^T = invS * H*P, as we have columns of HP. We solve columns of K^T, which are actually rows of K
    // full state kalman update
    chol(ekf_S_chol_vbody, S_vbody, ekf_S_iDiag_vbody, N_MEASUREMENTS_VBODY);
    for (int i = 0; i < N_STATES; i++) {
        float k_row[N_MEASUREMENTS_VBODY];
        chol_solve(ekf_S_chol_vbody, ekf_S_iDiag_vbody, N_MEASUREMENTS_VBODY, (HP_vbody+(i*N_MEASUREMENTS_VBODY)), k_row);
        for (int j = 0; j < N_MEASUREMENTS_VBODY; j++) {
            K_vbody[i + j*N_STATES] = k_row[j];
        }
    }

    // UPDATE STEP X_new, P_new = ...
    tmp[0] = powf(X[6], 2);
	tmp[1] = powf(X[7], 2);
	tmp[2] = powf(X[8], 2);
	tmp[3] = powf(X[9], 2);
	tmp[4] = tmp[0] + tmp[1] + tmp[2] + tmp[3];
	tmp[5] = powf(tmp[4], -1.0/2.0);
	tmp[6] = X[3]*tmp[5];
	tmp[7] = X[4]*tmp[5];
	tmp[8] = X[5]*tmp[5];
	tmp[9] = X[7]*tmp[6] + X[8]*tmp[7] + X[9]*tmp[8];
	tmp[10] = tmp[5]*tmp[9];
	tmp[11] = X[6]*tmp[6] - X[8]*tmp[8] + X[9]*tmp[7];
	tmp[12] = tmp[11]*tmp[5];
	tmp[13] = X[6]*tmp[7] + X[7]*tmp[8] - X[9]*tmp[6];
	tmp[14] = tmp[13]*tmp[5];
	tmp[15] = X[6]*tmp[8] - X[7]*tmp[7] + X[8]*tmp[6];
	tmp[16] = -X[6]*tmp[12] - X[7]*tmp[10] + X[8]*tmp[15]*tmp[5] - X[9]*tmp[14] + Z[0];
	tmp[17] = tmp[15]*tmp[5];
	tmp[18] = -tmp[11];
	tmp[19] = tmp[18]*tmp[5];
	tmp[20] = -X[6]*tmp[14] - X[7]*tmp[17] - X[8]*tmp[10] - X[9]*tmp[19] + Z[1];
	tmp[21] = 1.0/tmp[4];
	tmp[22] = 2*tmp[21];
	tmp[23] = X[8]*tmp[22];
	tmp[24] = -X[6]*tmp[23] + 2*X[7]*X[9]*tmp[21];
	tmp[25] = X[6]*X[7]*tmp[22] + X[9]*tmp[23];
	tmp[26] = -K_vbody[0]*tmp[24] - K_vbody[16]*tmp[25];
	tmp[27] = X[6]*X[9];
	tmp[28] = tmp[22]*tmp[27];
	tmp[29] = X[7]*tmp[23] + tmp[28];
	tmp[30] = tmp[21]*tmp[2];
	tmp[31] = tmp[1]*tmp[21];
	tmp[32] = tmp[0]*tmp[21] - tmp[21]*tmp[3];
	tmp[33] = tmp[30] - tmp[31] + tmp[32];
	tmp[34] = -K_vbody[0]*tmp[29] - K_vbody[16]*tmp[33];
	tmp[35] = 2*X[7]*X[8]*tmp[21] - tmp[28];
	tmp[36] = -tmp[30] + tmp[31] + tmp[32];
	tmp[37] = -K_vbody[0]*tmp[36] - K_vbody[16]*tmp[35];
	tmp[38] = powf(tmp[4], -3.0/2.0);
	tmp[39] = X[6]*tmp[38];
	tmp[40] = X[7]*tmp[39];
	tmp[41] = X[8]*tmp[39];
	tmp[42] = tmp[27]*tmp[38];
	tmp[43] = -tmp[13]*tmp[42];
	tmp[44] = tmp[0]*tmp[38];
	tmp[45] = X[3]*tmp[40];
	tmp[46] = X[4]*tmp[41];
	tmp[47] = X[5]*tmp[42];
	tmp[48] = -tmp[45] - tmp[46] - tmp[47];
	tmp[49] = X[7]*tmp[5];
	tmp[50] = -tmp[6];
	tmp[51] = X[4]*tmp[42];
	tmp[52] = X[5]*tmp[41];
	tmp[53] = X[3]*tmp[44] + tmp[50] + tmp[51] - tmp[52];
	tmp[54] = X[6]*tmp[5];
	tmp[55] = X[3]*tmp[42];
	tmp[56] = X[5]*tmp[40];
	tmp[57] = -X[4]*tmp[44] + tmp[55] - tmp[56] + tmp[7];
	tmp[58] = X[9]*tmp[5];
	tmp[59] = -tmp[8];
	tmp[60] = X[3]*tmp[41];
	tmp[61] = -X[4]*tmp[40];
	tmp[62] = -X[5]*tmp[44] - tmp[59] - tmp[60] - tmp[61];
	tmp[63] = X[8]*tmp[5];
	tmp[64] = -tmp[11]*tmp[44] + tmp[12] + tmp[15]*tmp[41] - tmp[40]*tmp[9] + tmp[43] + tmp[48]*tmp[49] - tmp[53]*tmp[54] + tmp[57]*tmp[58] - tmp[62]*tmp[63];
	tmp[65] = -tmp[13]*tmp[44] + tmp[14] - tmp[15]*tmp[40] - tmp[18]*tmp[42] - tmp[41]*tmp[9] + tmp[48]*tmp[63] + tmp[49]*tmp[62] + tmp[53]*tmp[58] + tmp[54]*tmp[57];
	tmp[66] = -K_vbody[0]*tmp[64] - K_vbody[16]*tmp[65];
	tmp[67] = X[7]*tmp[38];
	tmp[68] = X[8]*tmp[67];
	tmp[69] = tmp[15]*tmp[68];
	tmp[70] = tmp[1]*tmp[38];
	tmp[71] = X[9]*tmp[67];
	tmp[72] = X[4]*tmp[71];
	tmp[73] = X[5]*tmp[68];
	tmp[74] = tmp[45] + tmp[72] - tmp[73];
	tmp[75] = X[3]*tmp[71];
	tmp[76] = -X[5]*tmp[70] + tmp[61] + tmp[75] + tmp[8];
	tmp[77] = X[4]*tmp[68];
	tmp[78] = X[5]*tmp[71];
	tmp[79] = -X[3]*tmp[70] - tmp[50] - tmp[77] - tmp[78];
	tmp[80] = X[3]*tmp[68];
	tmp[81] = X[4]*tmp[1]*tmp[38] - tmp[56] - tmp[7] - tmp[80];
	tmp[82] = tmp[10] - tmp[11]*tmp[40] - tmp[13]*tmp[71] + tmp[49]*tmp[79] - tmp[54]*tmp[74] + tmp[58]*tmp[76] - tmp[63]*tmp[81] + tmp[69] - tmp[70]*tmp[9];
	tmp[83] = tmp[68]*tmp[9];
	tmp[84] = -tmp[13]*tmp[40] - tmp[15]*tmp[70] + tmp[17] - tmp[18]*tmp[71] + tmp[49]*tmp[81] + tmp[54]*tmp[76] + tmp[58]*tmp[74] + tmp[63]*tmp[79] - tmp[83];
	tmp[85] = -K_vbody[0]*tmp[82] - K_vbody[16]*tmp[84];
	tmp[86] = tmp[2]*tmp[38];
	tmp[87] = X[8]*X[9]*tmp[38];
	tmp[88] = X[3]*tmp[87];
	tmp[89] = -tmp[46] - tmp[73] + tmp[88];
	tmp[90] = X[4]*tmp[87];
	tmp[91] = -X[5]*tmp[2]*tmp[38] + tmp[60] + tmp[8] + tmp[90];
	tmp[92] = -X[3]*tmp[86] - tmp[50] - tmp[52] + tmp[77];
	tmp[93] = -tmp[7];
	tmp[94] = X[5]*tmp[87];
	tmp[95] = -X[4]*tmp[86] - tmp[80] - tmp[93] - tmp[94];
	tmp[96] = tmp[10] - tmp[13]*tmp[41] - tmp[18]*tmp[87] + tmp[49]*tmp[92] + tmp[54]*tmp[89] + tmp[58]*tmp[91] + tmp[63]*tmp[95] - tmp[69] - tmp[86]*tmp[9];
	tmp[97] = -X[6]*tmp[5]*tmp[91] + X[7]*tmp[5]*tmp[95] + X[9]*tmp[5]*tmp[89] - tmp[11]*tmp[41] - tmp[13]*tmp[87] + tmp[15]*tmp[2]*tmp[38] - tmp[17] - tmp[63]*tmp[92] - tmp[83];
	tmp[98] = -K_vbody[0]*tmp[97] - K_vbody[16]*tmp[96];
	tmp[99] = tmp[38]*tmp[3];
	tmp[100] = -tmp[47] + tmp[72] - tmp[88];
	tmp[101] = X[4]*tmp[99] + tmp[55] + tmp[93] - tmp[94];
	tmp[102] = -X[5]*tmp[99] - tmp[59] - tmp[75] - tmp[90];
	tmp[103] = X[3]*tmp[38]*tmp[3] - tmp[51] - tmp[6] - tmp[78];
	tmp[104] = -tmp[100]*tmp[63] - tmp[101]*tmp[54] + tmp[102]*tmp[49] + tmp[103]*tmp[58] - tmp[11]*tmp[42] - tmp[13]*tmp[99] + tmp[14] + tmp[15]*tmp[87] - tmp[71]*tmp[9];
	tmp[105] = tmp[100]*tmp[49] + tmp[101]*tmp[58] + tmp[102]*tmp[63] + tmp[103]*tmp[54] - tmp[15]*tmp[71] - tmp[18]*tmp[99] + tmp[19] + tmp[43] - tmp[87]*tmp[9];
	tmp[106] = -K_vbody[0]*tmp[104] - K_vbody[16]*tmp[105];
	tmp[107] = -K_vbody[17]*tmp[25] - K_vbody[1]*tmp[24];
	tmp[108] = -K_vbody[17]*tmp[33] - K_vbody[1]*tmp[29];
	tmp[109] = -K_vbody[17]*tmp[35] - K_vbody[1]*tmp[36];
	tmp[110] = -K_vbody[17]*tmp[65] - K_vbody[1]*tmp[64];
	tmp[111] = -K_vbody[17]*tmp[84] - K_vbody[1]*tmp[82];
	tmp[112] = -K_vbody[17]*tmp[96] - K_vbody[1]*tmp[97];
	tmp[113] = -K_vbody[17]*tmp[105] - K_vbody[1]*tmp[104];
	tmp[114] = -K_vbody[18]*tmp[25] - K_vbody[2]*tmp[24];
	tmp[115] = -K_vbody[18]*tmp[33] - K_vbody[2]*tmp[29];
	tmp[116] = -K_vbody[18]*tmp[35] - K_vbody[2]*tmp[36];
	tmp[117] = -K_vbody[18]*tmp[65] - K_vbody[2]*tmp[64];
	tmp[118] = -K_vbody[18]*tmp[84] - K_vbody[2]*tmp[82];
	tmp[119] = -K_vbody[18]*tmp[96] - K_vbody[2]*tmp[97];
	tmp[120] = -K_vbody[18]*tmp[105] - K_vbody[2]*tmp[104];
	tmp[121] = -K_vbody[19]*tmp[25] - K_vbody[3]*tmp[24];
	tmp[122] = -K_vbody[19]*tmp[33] - K_vbody[3]*tmp[29];
	tmp[123] = -K_vbody[19]*tmp[35] - K_vbody[3]*tmp[36] + 1;
	tmp[124] = -K_vbody[19]*tmp[65] - K_vbody[3]*tmp[64];
	tmp[125] = -K_vbody[19]*tmp[84] - K_vbody[3]*tmp[82];
	tmp[126] = -K_vbody[19]*tmp[96] - K_vbody[3]*tmp[97];
	tmp[127] = -K_vbody[19]*tmp[105] - K_vbody[3]*tmp[104];
	tmp[128] = -K_vbody[20]*tmp[25] - K_vbody[4]*tmp[24];
	tmp[129] = -K_vbody[20]*tmp[35] - K_vbody[4]*tmp[36];
	tmp[130] = -K_vbody[20]*tmp[33] - K_vbody[4]*tmp[29] + 1;
	tmp[131] = -K_vbody[20]*tmp[65] - K_vbody[4]*tmp[64];
	tmp[132] = -K_vbody[20]*tmp[84] - K_vbody[4]*tmp[82];
	tmp[133] = -K_vbody[20]*tmp[96] - K_vbody[4]*tmp[97];
	tmp[134] = -K_vbody[20]*tmp[105] - K_vbody[4]*tmp[104];
	tmp[135] = -K_vbody[21]*tmp[25] - K_vbody[5]*tmp[24] + 1;
	tmp[136] = -K_vbody[21]*tmp[35] - K_vbody[5]*tmp[36];
	tmp[137] = -K_vbody[21]*tmp[33] - K_vbody[5]*tmp[29];
	tmp[138] = -K_vbody[21]*tmp[65] - K_vbody[5]*tmp[64];
	tmp[139] = -K_vbody[21]*tmp[84] - K_vbody[5]*tmp[82];
	tmp[140] = -K_vbody[21]*tmp[96] - K_vbody[5]*tmp[97];
	tmp[141] = -K_vbody[21]*tmp[105] - K_vbody[5]*tmp[104];
	tmp[142] = -K_vbody[22]*tmp[25] - K_vbody[6]*tmp[24];
	tmp[143] = -K_vbody[22]*tmp[35] - K_vbody[6]*tmp[36];
	tmp[144] = -K_vbody[22]*tmp[33] - K_vbody[6]*tmp[29];
	tmp[145] = -K_vbody[22]*tmp[84] - K_vbody[6]*tmp[82];
	tmp[146] = -K_vbody[22]*tmp[96] - K_vbody[6]*tmp[97];
	tmp[147] = -K_vbody[22]*tmp[65] - K_vbody[6]*tmp[64] + 1;
	tmp[148] = -K_vbody[22]*tmp[105] - K_vbody[6]*tmp[104];
	tmp[149] = -K_vbody[23]*tmp[25] - K_vbody[7]*tmp[24];
	tmp[150] = -K_vbody[23]*tmp[35] - K_vbody[7]*tmp[36];
	tmp[151] = -K_vbody[23]*tmp[33] - K_vbody[7]*tmp[29];
	tmp[152] = -K_vbody[23]*tmp[65] - K_vbody[7]*tmp[64];
	tmp[153] = -K_vbody[23]*tmp[96] - K_vbody[7]*tmp[97];
	tmp[154] = -K_vbody[23]*tmp[84] - K_vbody[7]*tmp[82] + 1;
	tmp[155] = -K_vbody[23]*tmp[105] - K_vbody[7]*tmp[104];
	tmp[156] = -K_vbody[24]*tmp[25] - K_vbody[8]*tmp[24];
	tmp[157] = -K_vbody[24]*tmp[35] - K_vbody[8]*tmp[36];
	tmp[158] = -K_vbody[24]*tmp[33] - K_vbody[8]*tmp[29];
	tmp[159] = -K_vbody[24]*tmp[65] - K_vbody[8]*tmp[64];
	tmp[160] = -K_vbody[24]*tmp[84] - K_vbody[8]*tmp[82];
	tmp[161] = -K_vbody[24]*tmp[96] - K_vbody[8]*tmp[97] + 1;
	tmp[162] = -K_vbody[24]*tmp[105] - K_vbody[8]*tmp[104];
	tmp[163] = -K_vbody[25]*tmp[25] - K_vbody[9]*tmp[24];
	tmp[164] = -K_vbody[25]*tmp[35] - K_vbody[9]*tmp[36];
	tmp[165] = -K_vbody[25]*tmp[33] - K_vbody[9]*tmp[29];
	tmp[166] = -K_vbody[25]*tmp[65] - K_vbody[9]*tmp[64];
	tmp[167] = -K_vbody[25]*tmp[84] - K_vbody[9]*tmp[82];
	tmp[168] = -K_vbody[25]*tmp[96] - K_vbody[9]*tmp[97];
	tmp[169] = -K_vbody[25]*tmp[105] - K_vbody[9]*tmp[104] + 1;
	tmp[170] = -K_vbody[10]*tmp[24] - K_vbody[26]*tmp[25];
	tmp[171] = -K_vbody[10]*tmp[36] - K_vbody[26]*tmp[35];
	tmp[172] = -K_vbody[10]*tmp[29] - K_vbody[26]*tmp[33];
	tmp[173] = -K_vbody[10]*tmp[64] - K_vbody[26]*tmp[65];
	tmp[174] = -K_vbody[10]*tmp[82] - K_vbody[26]*tmp[84];
	tmp[175] = -K_vbody[10]*tmp[97] - K_vbody[26]*tmp[96];
	tmp[176] = -K_vbody[10]*tmp[104] - K_vbody[26]*tmp[105];
	tmp[177] = -K_vbody[11]*tmp[24] - K_vbody[27]*tmp[25];
	tmp[178] = -K_vbody[11]*tmp[36] - K_vbody[27]*tmp[35];
	tmp[179] = -K_vbody[11]*tmp[29] - K_vbody[27]*tmp[33];
	tmp[180] = -K_vbody[11]*tmp[64] - K_vbody[27]*tmp[65];
	tmp[181] = -K_vbody[11]*tmp[82] - K_vbody[27]*tmp[84];
	tmp[182] = -K_vbody[11]*tmp[97] - K_vbody[27]*tmp[96];
	tmp[183] = -K_vbody[11]*tmp[104] - K_vbody[27]*tmp[105];
	tmp[184] = -K_vbody[12]*tmp[24] - K_vbody[28]*tmp[25];
	tmp[185] = -K_vbody[12]*tmp[36] - K_vbody[28]*tmp[35];
	tmp[186] = -K_vbody[12]*tmp[29] - K_vbody[28]*tmp[33];
	tmp[187] = -K_vbody[12]*tmp[64] - K_vbody[28]*tmp[65];
	tmp[188] = -K_vbody[12]*tmp[82] - K_vbody[28]*tmp[84];
	tmp[189] = -K_vbody[12]*tmp[97] - K_vbody[28]*tmp[96];
	tmp[190] = -K_vbody[12]*tmp[104] - K_vbody[28]*tmp[105];
	tmp[191] = -K_vbody[13]*tmp[24] - K_vbody[29]*tmp[25];
	tmp[192] = -K_vbody[13]*tmp[36] - K_vbody[29]*tmp[35];
	tmp[193] = -K_vbody[13]*tmp[29] - K_vbody[29]*tmp[33];
	tmp[194] = -K_vbody[13]*tmp[64] - K_vbody[29]*tmp[65];
	tmp[195] = -K_vbody[13]*tmp[82] - K_vbody[29]*tmp[84];
	tmp[196] = -K_vbody[13]*tmp[97] - K_vbody[29]*tmp[96];
	tmp[197] = -K_vbody[13]*tmp[104] - K_vbody[29]*tmp[105];
	tmp[198] = -K_vbody[14]*tmp[24] - K_vbody[30]*tmp[25];
	tmp[199] = -K_vbody[14]*tmp[36] - K_vbody[30]*tmp[35];
	tmp[200] = -K_vbody[14]*tmp[29] - K_vbody[30]*tmp[33];
	tmp[201] = -K_vbody[14]*tmp[64] - K_vbody[30]*tmp[65];
	tmp[202] = -K_vbody[14]*tmp[82] - K_vbody[30]*tmp[84];
	tmp[203] = -K_vbody[14]*tmp[97] - K_vbody[30]*tmp[96];
	tmp[204] = -K_vbody[14]*tmp[104] - K_vbody[30]*tmp[105];
	X_new[0] = K_vbody[0]*tmp[16] + K_vbody[16]*tmp[20] + X[0];
	X_new[1] = K_vbody[17]*tmp[20] + K_vbody[1]*tmp[16] + X[1];
	X_new[2] = K_vbody[18]*tmp[20] + K_vbody[2]*tmp[16] + X[2];
	X_new[3] = K_vbody[19]*tmp[20] + K_vbody[3]*tmp[16] + X[3];
	X_new[4] = K_vbody[20]*tmp[20] + K_vbody[4]*tmp[16] + X[4];
	X_new[5] = K_vbody[21]*tmp[20] + K_vbody[5]*tmp[16] + X[5];
	X_new[6] = K_vbody[22]*tmp[20] + K_vbody[6]*tmp[16] + X[6];
	X_new[7] = K_vbody[23]*tmp[20] + K_vbody[7]*tmp[16] + X[7];
	X_new[8] = K_vbody[24]*tmp[20] + K_vbody[8]*tmp[16] + X[8];
	X_new[9] = K_vbody[25]*tmp[20] + K_vbody[9]*tmp[16] + X[9];
	X_new[10] = K_vbody[10]*tmp[16] + K_vbody[26]*tmp[20] + X[10];
	X_new[11] = K_vbody[11]*tmp[16] + K_vbody[27]*tmp[20] + X[11];
	X_new[12] = K_vbody[12]*tmp[16] + K_vbody[28]*tmp[20] + X[12];
	X_new[13] = K_vbody[13]*tmp[16] + K_vbody[29]*tmp[20] + X[13];
	X_new[14] = K_vbody[14]*tmp[16] + K_vbody[30]*tmp[20] + X[14];
	X_new[15] = K_vbody[15]*tmp[16] + K_vbody[31]*tmp[20] + X[15];
	P_new[0] = P[0] + P[10]*tmp[34] + P[15]*tmp[26] + P[21]*tmp[66] + P[28]*tmp[85] + P[36]*tmp[98] + P[45]*tmp[106] + P[6]*tmp[37];
	P_new[1] = P[11]*tmp[34] + P[16]*tmp[26] + P[1] + P[22]*tmp[66] + P[29]*tmp[85] + P[37]*tmp[98] + P[46]*tmp[106] + P[7]*tmp[37];
	P_new[3] = P[12]*tmp[34] + P[17]*tmp[26] + P[23]*tmp[66] + P[30]*tmp[85] + P[38]*tmp[98] + P[3] + P[47]*tmp[106] + P[8]*tmp[37];
	P_new[6] = P[13]*tmp[34] + P[18]*tmp[26] + P[24]*tmp[66] + P[31]*tmp[85] + P[39]*tmp[98] + P[48]*tmp[106] + P[6] + P[9]*tmp[37];
	P_new[10] = P[10] + P[13]*tmp[37] + P[14]*tmp[34] + P[19]*tmp[26] + P[25]*tmp[66] + P[32]*tmp[85] + P[40]*tmp[98] + P[49]*tmp[106];
	P_new[15] = P[15] + P[18]*tmp[37] + P[19]*tmp[34] + P[20]*tmp[26] + P[26]*tmp[66] + P[33]*tmp[85] + P[41]*tmp[98] + P[50]*tmp[106];
	P_new[21] = P[21] + P[24]*tmp[37] + P[25]*tmp[34] + P[26]*tmp[26] + P[27]*tmp[66] + P[34]*tmp[85] + P[42]*tmp[98] + P[51]*tmp[106];
	P_new[28] = P[28] + P[31]*tmp[37] + P[32]*tmp[34] + P[33]*tmp[26] + P[34]*tmp[66] + P[35]*tmp[85] + P[43]*tmp[98] + P[52]*tmp[106];
	P_new[36] = P[36] + P[39]*tmp[37] + P[40]*tmp[34] + P[41]*tmp[26] + P[42]*tmp[66] + P[43]*tmp[85] + P[44]*tmp[98] + P[53]*tmp[106];
	P_new[45] = P[45] + P[48]*tmp[37] + P[49]*tmp[34] + P[50]*tmp[26] + P[51]*tmp[66] + P[52]*tmp[85] + P[53]*tmp[98] + P[54]*tmp[106];
	P_new[55] = P[55] + P[58]*tmp[37] + P[59]*tmp[34] + P[60]*tmp[26] + P[61]*tmp[66] + P[62]*tmp[85] + P[63]*tmp[98] + P[64]*tmp[106];
	P_new[66] = P[66] + P[69]*tmp[37] + P[70]*tmp[34] + P[71]*tmp[26] + P[72]*tmp[66] + P[73]*tmp[85] + P[74]*tmp[98] + P[75]*tmp[106];
	P_new[78] = P[78] + P[81]*tmp[37] + P[82]*tmp[34] + P[83]*tmp[26] + P[84]*tmp[66] + P[85]*tmp[85] + P[86]*tmp[98] + P[87]*tmp[106];
	P_new[91] = P[100]*tmp[106] + P[91] + P[94]*tmp[37] + P[95]*tmp[34] + P[96]*tmp[26] + P[97]*tmp[66] + P[98]*tmp[85] + P[99]*tmp[98];
	P_new[105] = P[105] + P[108]*tmp[37] + P[109]*tmp[34] + P[110]*tmp[26] + P[111]*tmp[66] + P[112]*tmp[85] + P[113]*tmp[98] + P[114]*tmp[106];
	P_new[120] = P[120] + P[123]*tmp[37] + P[124]*tmp[34] + P[125]*tmp[26] + P[126]*tmp[66] + P[127]*tmp[85] + P[128]*tmp[98] + P[129]*tmp[106];
	P_new[2] = P[11]*tmp[108] + P[16]*tmp[107] + P[22]*tmp[110] + P[29]*tmp[111] + P[2] + P[37]*tmp[112] + P[46]*tmp[113] + P[7]*tmp[109];
	P_new[4] = P[12]*tmp[108] + P[17]*tmp[107] + P[23]*tmp[110] + P[30]*tmp[111] + P[38]*tmp[112] + P[47]*tmp[113] + P[4] + P[8]*tmp[109];
	P_new[7] = P[13]*tmp[108] + P[18]*tmp[107] + P[24]*tmp[110] + P[31]*tmp[111] + P[39]*tmp[112] + P[48]*tmp[113] + P[7] + P[9]*tmp[109];
	P_new[11] = P[11] + P[13]*tmp[109] + P[14]*tmp[108] + P[19]*tmp[107] + P[25]*tmp[110] + P[32]*tmp[111] + P[40]*tmp[112] + P[49]*tmp[113];
	P_new[16] = P[16] + P[18]*tmp[109] + P[19]*tmp[108] + P[20]*tmp[107] + P[26]*tmp[110] + P[33]*tmp[111] + P[41]*tmp[112] + P[50]*tmp[113];
	P_new[22] = P[22] + P[24]*tmp[109] + P[25]*tmp[108] + P[26]*tmp[107] + P[27]*tmp[110] + P[34]*tmp[111] + P[42]*tmp[112] + P[51]*tmp[113];
	P_new[29] = P[29] + P[31]*tmp[109] + P[32]*tmp[108] + P[33]*tmp[107] + P[34]*tmp[110] + P[35]*tmp[111] + P[43]*tmp[112] + P[52]*tmp[113];
	P_new[37] = P[37] + P[39]*tmp[109] + P[40]*tmp[108] + P[41]*tmp[107] + P[42]*tmp[110] + P[43]*tmp[111] + P[44]*tmp[112] + P[53]*tmp[113];
	P_new[46] = P[46] + P[48]*tmp[109] + P[49]*tmp[108] + P[50]*tmp[107] + P[51]*tmp[110] + P[52]*tmp[111] + P[53]*tmp[112] + P[54]*tmp[113];
	P_new[56] = P[56] + P[58]*tmp[109] + P[59]*tmp[108] + P[60]*tmp[107] + P[61]*tmp[110] + P[62]*tmp[111] + P[63]*tmp[112] + P[64]*tmp[113];
	P_new[67] = P[67] + P[69]*tmp[109] + P[70]*tmp[108] + P[71]*tmp[107] + P[72]*tmp[110] + P[73]*tmp[111] + P[74]*tmp[112] + P[75]*tmp[113];
	P_new[79] = P[79] + P[81]*tmp[109] + P[82]*tmp[108] + P[83]*tmp[107] + P[84]*tmp[110] + P[85]*tmp[111] + P[86]*tmp[112] + P[87]*tmp[113];
	P_new[92] = P[100]*tmp[113] + P[92] + P[94]*tmp[109] + P[95]*tmp[108] + P[96]*tmp[107] + P[97]*tmp[110] + P[98]*tmp[111] + P[99]*tmp[112];
	P_new[106] = P[106] + P[108]*tmp[109] + P[109]*tmp[108] + P[110]*tmp[107] + P[111]*tmp[110] + P[112]*tmp[111] + P[113]*tmp[112] + P[114]*tmp[113];
	P_new[121] = P[121] + P[123]*tmp[109] + P[124]*tmp[108] + P[125]*tmp[107] + P[126]*tmp[110] + P[127]*tmp[111] + P[128]*tmp[112] + P[129]*tmp[113];
	P_new[5] = P[12]*tmp[115] + P[17]*tmp[114] + P[23]*tmp[117] + P[30]*tmp[118] + P[38]*tmp[119] + P[47]*tmp[120] + P[5] + P[8]*tmp[116];
	P_new[8] = P[13]*tmp[115] + P[18]*tmp[114] + P[24]*tmp[117] + P[31]*tmp[118] + P[39]*tmp[119] + P[48]*tmp[120] + P[8] + P[9]*tmp[116];
	P_new[12] = P[12] + P[13]*tmp[116] + P[14]*tmp[115] + P[19]*tmp[114] + P[25]*tmp[117] + P[32]*tmp[118] + P[40]*tmp[119] + P[49]*tmp[120];
	P_new[17] = P[17] + P[18]*tmp[116] + P[19]*tmp[115] + P[20]*tmp[114] + P[26]*tmp[117] + P[33]*tmp[118] + P[41]*tmp[119] + P[50]*tmp[120];
	P_new[23] = P[23] + P[24]*tmp[116] + P[25]*tmp[115] + P[26]*tmp[114] + P[27]*tmp[117] + P[34]*tmp[118] + P[42]*tmp[119] + P[51]*tmp[120];
	P_new[30] = P[30] + P[31]*tmp[116] + P[32]*tmp[115] + P[33]*tmp[114] + P[34]*tmp[117] + P[35]*tmp[118] + P[43]*tmp[119] + P[52]*tmp[120];
	P_new[38] = P[38] + P[39]*tmp[116] + P[40]*tmp[115] + P[41]*tmp[114] + P[42]*tmp[117] + P[43]*tmp[118] + P[44]*tmp[119] + P[53]*tmp[120];
	P_new[47] = P[47] + P[48]*tmp[116] + P[49]*tmp[115] + P[50]*tmp[114] + P[51]*tmp[117] + P[52]*tmp[118] + P[53]*tmp[119] + P[54]*tmp[120];
	P_new[57] = P[57] + P[58]*tmp[116] + P[59]*tmp[115] + P[60]*tmp[114] + P[61]*tmp[117] + P[62]*tmp[118] + P[63]*tmp[119] + P[64]*tmp[120];
	P_new[68] = P[68] + P[69]*tmp[116] + P[70]*tmp[115] + P[71]*tmp[114] + P[72]*tmp[117] + P[73]*tmp[118] + P[74]*tmp[119] + P[75]*tmp[120];
	P_new[80] = P[80] + P[81]*tmp[116] + P[82]*tmp[115] + P[83]*tmp[114] + P[84]*tmp[117] + P[85]*tmp[118] + P[86]*tmp[119] + P[87]*tmp[120];
	P_new[93] = P[100]*tmp[120] + P[93] + P[94]*tmp[116] + P[95]*tmp[115] + P[96]*tmp[114] + P[97]*tmp[117] + P[98]*tmp[118] + P[99]*tmp[119];
	P_new[107] = P[107] + P[108]*tmp[116] + P[109]*tmp[115] + P[110]*tmp[114] + P[111]*tmp[117] + P[112]*tmp[118] + P[113]*tmp[119] + P[114]*tmp[120];
	P_new[122] = P[122] + P[123]*tmp[116] + P[124]*tmp[115] + P[125]*tmp[114] + P[126]*tmp[117] + P[127]*tmp[118] + P[128]*tmp[119] + P[129]*tmp[120];
	P_new[9] = P[13]*tmp[122] + P[18]*tmp[121] + P[24]*tmp[124] + P[31]*tmp[125] + P[39]*tmp[126] + P[48]*tmp[127] + P[9]*tmp[123];
	P_new[13] = P[13]*tmp[123] + P[14]*tmp[122] + P[19]*tmp[121] + P[25]*tmp[124] + P[32]*tmp[125] + P[40]*tmp[126] + P[49]*tmp[127];
	P_new[18] = P[18]*tmp[123] + P[19]*tmp[122] + P[20]*tmp[121] + P[26]*tmp[124] + P[33]*tmp[125] + P[41]*tmp[126] + P[50]*tmp[127];
	P_new[24] = P[24]*tmp[123] + P[25]*tmp[122] + P[26]*tmp[121] + P[27]*tmp[124] + P[34]*tmp[125] + P[42]*tmp[126] + P[51]*tmp[127];
	P_new[31] = P[31]*tmp[123] + P[32]*tmp[122] + P[33]*tmp[121] + P[34]*tmp[124] + P[35]*tmp[125] + P[43]*tmp[126] + P[52]*tmp[127];
	P_new[39] = P[39]*tmp[123] + P[40]*tmp[122] + P[41]*tmp[121] + P[42]*tmp[124] + P[43]*tmp[125] + P[44]*tmp[126] + P[53]*tmp[127];
	P_new[48] = P[48]*tmp[123] + P[49]*tmp[122] + P[50]*tmp[121] + P[51]*tmp[124] + P[52]*tmp[125] + P[53]*tmp[126] + P[54]*tmp[127];
	P_new[58] = P[58]*tmp[123] + P[59]*tmp[122] + P[60]*tmp[121] + P[61]*tmp[124] + P[62]*tmp[125] + P[63]*tmp[126] + P[64]*tmp[127];
	P_new[69] = P[69]*tmp[123] + P[70]*tmp[122] + P[71]*tmp[121] + P[72]*tmp[124] + P[73]*tmp[125] + P[74]*tmp[126] + P[75]*tmp[127];
	P_new[81] = P[81]*tmp[123] + P[82]*tmp[122] + P[83]*tmp[121] + P[84]*tmp[124] + P[85]*tmp[125] + P[86]*tmp[126] + P[87]*tmp[127];
	P_new[94] = P[100]*tmp[127] + P[94]*tmp[123] + P[95]*tmp[122] + P[96]*tmp[121] + P[97]*tmp[124] + P[98]*tmp[125] + P[99]*tmp[126];
	P_new[108] = P[108]*tmp[123] + P[109]*tmp[122] + P[110]*tmp[121] + P[111]*tmp[124] + P[112]*tmp[125] + P[113]*tmp[126] + P[114]*tmp[127];
	P_new[123] = P[123]*tmp[123] + P[124]*tmp[122] + P[125]*tmp[121] + P[126]*tmp[124] + P[127]*tmp[125] + P[128]*tmp[126] + P[129]*tmp[127];
	P_new[14] = P[13]*tmp[129] + P[14]*tmp[130] + P[19]*tmp[128] + P[25]*tmp[131] + P[32]*tmp[132] + P[40]*tmp[133] + P[49]*tmp[134];
	P_new[19] = P[18]*tmp[129] + P[19]*tmp[130] + P[20]*tmp[128] + P[26]*tmp[131] + P[33]*tmp[132] + P[41]*tmp[133] + P[50]*tmp[134];
	P_new[25] = P[24]*tmp[129] + P[25]*tmp[130] + P[26]*tmp[128] + P[27]*tmp[131] + P[34]*tmp[132] + P[42]*tmp[133] + P[51]*tmp[134];
	P_new[32] = P[31]*tmp[129] + P[32]*tmp[130] + P[33]*tmp[128] + P[34]*tmp[131] + P[35]*tmp[132] + P[43]*tmp[133] + P[52]*tmp[134];
	P_new[40] = P[39]*tmp[129] + P[40]*tmp[130] + P[41]*tmp[128] + P[42]*tmp[131] + P[43]*tmp[132] + P[44]*tmp[133] + P[53]*tmp[134];
	P_new[49] = P[48]*tmp[129] + P[49]*tmp[130] + P[50]*tmp[128] + P[51]*tmp[131] + P[52]*tmp[132] + P[53]*tmp[133] + P[54]*tmp[134];
	P_new[59] = P[58]*tmp[129] + P[59]*tmp[130] + P[60]*tmp[128] + P[61]*tmp[131] + P[62]*tmp[132] + P[63]*tmp[133] + P[64]*tmp[134];
	P_new[70] = P[69]*tmp[129] + P[70]*tmp[130] + P[71]*tmp[128] + P[72]*tmp[131] + P[73]*tmp[132] + P[74]*tmp[133] + P[75]*tmp[134];
	P_new[82] = P[81]*tmp[129] + P[82]*tmp[130] + P[83]*tmp[128] + P[84]*tmp[131] + P[85]*tmp[132] + P[86]*tmp[133] + P[87]*tmp[134];
	P_new[95] = P[100]*tmp[134] + P[94]*tmp[129] + P[95]*tmp[130] + P[96]*tmp[128] + P[97]*tmp[131] + P[98]*tmp[132] + P[99]*tmp[133];
	P_new[109] = P[108]*tmp[129] + P[109]*tmp[130] + P[110]*tmp[128] + P[111]*tmp[131] + P[112]*tmp[132] + P[113]*tmp[133] + P[114]*tmp[134];
	P_new[124] = P[123]*tmp[129] + P[124]*tmp[130] + P[125]*tmp[128] + P[126]*tmp[131] + P[127]*tmp[132] + P[128]*tmp[133] + P[129]*tmp[134];
	P_new[20] = P[18]*tmp[136] + P[19]*tmp[137] + P[20]*tmp[135] + P[26]*tmp[138] + P[33]*tmp[139] + P[41]*tmp[140] + P[50]*tmp[141];
	P_new[26] = P[24]*tmp[136] + P[25]*tmp[137] + P[26]*tmp[135] + P[27]*tmp[138] + P[34]*tmp[139] + P[42]*tmp[140] + P[51]*tmp[141];
	P_new[33] = P[31]*tmp[136] + P[32]*tmp[137] + P[33]*tmp[135] + P[34]*tmp[138] + P[35]*tmp[139] + P[43]*tmp[140] + P[52]*tmp[141];
	P_new[41] = P[39]*tmp[136] + P[40]*tmp[137] + P[41]*tmp[135] + P[42]*tmp[138] + P[43]*tmp[139] + P[44]*tmp[140] + P[53]*tmp[141];
	P_new[50] = P[48]*tmp[136] + P[49]*tmp[137] + P[50]*tmp[135] + P[51]*tmp[138] + P[52]*tmp[139] + P[53]*tmp[140] + P[54]*tmp[141];
	P_new[60] = P[58]*tmp[136] + P[59]*tmp[137] + P[60]*tmp[135] + P[61]*tmp[138] + P[62]*tmp[139] + P[63]*tmp[140] + P[64]*tmp[141];
	P_new[71] = P[69]*tmp[136] + P[70]*tmp[137] + P[71]*tmp[135] + P[72]*tmp[138] + P[73]*tmp[139] + P[74]*tmp[140] + P[75]*tmp[141];
	P_new[83] = P[81]*tmp[136] + P[82]*tmp[137] + P[83]*tmp[135] + P[84]*tmp[138] + P[85]*tmp[139] + P[86]*tmp[140] + P[87]*tmp[141];
	P_new[96] = P[100]*tmp[141] + P[94]*tmp[136] + P[95]*tmp[137] + P[96]*tmp[135] + P[97]*tmp[138] + P[98]*tmp[139] + P[99]*tmp[140];
	P_new[110] = P[108]*tmp[136] + P[109]*tmp[137] + P[110]*tmp[135] + P[111]*tmp[138] + P[112]*tmp[139] + P[113]*tmp[140] + P[114]*tmp[141];
	P_new[125] = P[123]*tmp[136] + P[124]*tmp[137] + P[125]*tmp[135] + P[126]*tmp[138] + P[127]*tmp[139] + P[128]*tmp[140] + P[129]*tmp[141];
	P_new[27] = P[24]*tmp[143] + P[25]*tmp[144] + P[26]*tmp[142] + P[27]*tmp[147] + P[34]*tmp[145] + P[42]*tmp[146] + P[51]*tmp[148];
	P_new[34] = P[31]*tmp[143] + P[32]*tmp[144] + P[33]*tmp[142] + P[34]*tmp[147] + P[35]*tmp[145] + P[43]*tmp[146] + P[52]*tmp[148];
	P_new[42] = P[39]*tmp[143] + P[40]*tmp[144] + P[41]*tmp[142] + P[42]*tmp[147] + P[43]*tmp[145] + P[44]*tmp[146] + P[53]*tmp[148];
	P_new[51] = P[48]*tmp[143] + P[49]*tmp[144] + P[50]*tmp[142] + P[51]*tmp[147] + P[52]*tmp[145] + P[53]*tmp[146] + P[54]*tmp[148];
	P_new[61] = P[58]*tmp[143] + P[59]*tmp[144] + P[60]*tmp[142] + P[61]*tmp[147] + P[62]*tmp[145] + P[63]*tmp[146] + P[64]*tmp[148];
	P_new[72] = P[69]*tmp[143] + P[70]*tmp[144] + P[71]*tmp[142] + P[72]*tmp[147] + P[73]*tmp[145] + P[74]*tmp[146] + P[75]*tmp[148];
	P_new[84] = P[81]*tmp[143] + P[82]*tmp[144] + P[83]*tmp[142] + P[84]*tmp[147] + P[85]*tmp[145] + P[86]*tmp[146] + P[87]*tmp[148];
	P_new[97] = P[100]*tmp[148] + P[94]*tmp[143] + P[95]*tmp[144] + P[96]*tmp[142] + P[97]*tmp[147] + P[98]*tmp[145] + P[99]*tmp[146];
	P_new[111] = P[108]*tmp[143] + P[109]*tmp[144] + P[110]*tmp[142] + P[111]*tmp[147] + P[112]*tmp[145] + P[113]*tmp[146] + P[114]*tmp[148];
	P_new[126] = P[123]*tmp[143] + P[124]*tmp[144] + P[125]*tmp[142] + P[126]*tmp[147] + P[127]*tmp[145] + P[128]*tmp[146] + P[129]*tmp[148];
	P_new[35] = P[31]*tmp[150] + P[32]*tmp[151] + P[33]*tmp[149] + P[34]*tmp[152] + P[35]*tmp[154] + P[43]*tmp[153] + P[52]*tmp[155];
	P_new[43] = P[39]*tmp[150] + P[40]*tmp[151] + P[41]*tmp[149] + P[42]*tmp[152] + P[43]*tmp[154] + P[44]*tmp[153] + P[53]*tmp[155];
	P_new[52] = P[48]*tmp[150] + P[49]*tmp[151] + P[50]*tmp[149] + P[51]*tmp[152] + P[52]*tmp[154] + P[53]*tmp[153] + P[54]*tmp[155];
	P_new[62] = P[58]*tmp[150] + P[59]*tmp[151] + P[60]*tmp[149] + P[61]*tmp[152] + P[62]*tmp[154] + P[63]*tmp[153] + P[64]*tmp[155];
	P_new[73] = P[69]*tmp[150] + P[70]*tmp[151] + P[71]*tmp[149] + P[72]*tmp[152] + P[73]*tmp[154] + P[74]*tmp[153] + P[75]*tmp[155];
	P_new[85] = P[81]*tmp[150] + P[82]*tmp[151] + P[83]*tmp[149] + P[84]*tmp[152] + P[85]*tmp[154] + P[86]*tmp[153] + P[87]*tmp[155];
	P_new[98] = P[100]*tmp[155] + P[94]*tmp[150] + P[95]*tmp[151] + P[96]*tmp[149] + P[97]*tmp[152] + P[98]*tmp[154] + P[99]*tmp[153];
	P_new[112] = P[108]*tmp[150] + P[109]*tmp[151] + P[110]*tmp[149] + P[111]*tmp[152] + P[112]*tmp[154] + P[113]*tmp[153] + P[114]*tmp[155];
	P_new[127] = P[123]*tmp[150] + P[124]*tmp[151] + P[125]*tmp[149] + P[126]*tmp[152] + P[127]*tmp[154] + P[128]*tmp[153] + P[129]*tmp[155];
	P_new[44] = P[39]*tmp[157] + P[40]*tmp[158] + P[41]*tmp[156] + P[42]*tmp[159] + P[43]*tmp[160] + P[44]*tmp[161] + P[53]*tmp[162];
	P_new[53] = P[48]*tmp[157] + P[49]*tmp[158] + P[50]*tmp[156] + P[51]*tmp[159] + P[52]*tmp[160] + P[53]*tmp[161] + P[54]*tmp[162];
	P_new[63] = P[58]*tmp[157] + P[59]*tmp[158] + P[60]*tmp[156] + P[61]*tmp[159] + P[62]*tmp[160] + P[63]*tmp[161] + P[64]*tmp[162];
	P_new[74] = P[69]*tmp[157] + P[70]*tmp[158] + P[71]*tmp[156] + P[72]*tmp[159] + P[73]*tmp[160] + P[74]*tmp[161] + P[75]*tmp[162];
	P_new[86] = P[81]*tmp[157] + P[82]*tmp[158] + P[83]*tmp[156] + P[84]*tmp[159] + P[85]*tmp[160] + P[86]*tmp[161] + P[87]*tmp[162];
	P_new[99] = P[100]*tmp[162] + P[94]*tmp[157] + P[95]*tmp[158] + P[96]*tmp[156] + P[97]*tmp[159] + P[98]*tmp[160] + P[99]*tmp[161];
	P_new[113] = P[108]*tmp[157] + P[109]*tmp[158] + P[110]*tmp[156] + P[111]*tmp[159] + P[112]*tmp[160] + P[113]*tmp[161] + P[114]*tmp[162];
	P_new[128] = P[123]*tmp[157] + P[124]*tmp[158] + P[125]*tmp[156] + P[126]*tmp[159] + P[127]*tmp[160] + P[128]*tmp[161] + P[129]*tmp[162];
	P_new[54] = P[48]*tmp[164] + P[49]*tmp[165] + P[50]*tmp[163] + P[51]*tmp[166] + P[52]*tmp[167] + P[53]*tmp[168] + P[54]*tmp[169];
	P_new[64] = P[58]*tmp[164] + P[59]*tmp[165] + P[60]*tmp[163] + P[61]*tmp[166] + P[62]*tmp[167] + P[63]*tmp[168] + P[64]*tmp[169];
	P_new[75] = P[69]*tmp[164] + P[70]*tmp[165] + P[71]*tmp[163] + P[72]*tmp[166] + P[73]*tmp[167] + P[74]*tmp[168] + P[75]*tmp[169];
	P_new[87] = P[81]*tmp[164] + P[82]*tmp[165] + P[83]*tmp[163] + P[84]*tmp[166] + P[85]*tmp[167] + P[86]*tmp[168] + P[87]*tmp[169];
	P_new[100] = P[100]*tmp[169] + P[94]*tmp[164] + P[95]*tmp[165] + P[96]*tmp[163] + P[97]*tmp[166] + P[98]*tmp[167] + P[99]*tmp[168];
	P_new[114] = P[108]*tmp[164] + P[109]*tmp[165] + P[110]*tmp[163] + P[111]*tmp[166] + P[112]*tmp[167] + P[113]*tmp[168] + P[114]*tmp[169];
	P_new[129] = P[123]*tmp[164] + P[124]*tmp[165] + P[125]*tmp[163] + P[126]*tmp[166] + P[127]*tmp[167] + P[128]*tmp[168] + P[129]*tmp[169];
	P_new[65] = P[58]*tmp[171] + P[59]*tmp[172] + P[60]*tmp[170] + P[61]*tmp[173] + P[62]*tmp[174] + P[63]*tmp[175] + P[64]*tmp[176] + P[65];
	P_new[76] = P[69]*tmp[171] + P[70]*tmp[172] + P[71]*tmp[170] + P[72]*tmp[173] + P[73]*tmp[174] + P[74]*tmp[175] + P[75]*tmp[176] + P[76];
	P_new[88] = P[81]*tmp[171] + P[82]*tmp[172] + P[83]*tmp[170] + P[84]*tmp[173] + P[85]*tmp[174] + P[86]*tmp[175] + P[87]*tmp[176] + P[88];
	P_new[101] = P[100]*tmp[176] + P[101] + P[94]*tmp[171] + P[95]*tmp[172] + P[96]*tmp[170] + P[97]*tmp[173] + P[98]*tmp[174] + P[99]*tmp[175];
	P_new[115] = P[108]*tmp[171] + P[109]*tmp[172] + P[110]*tmp[170] + P[111]*tmp[173] + P[112]*tmp[174] + P[113]*tmp[175] + P[114]*tmp[176] + P[115];
	P_new[130] = P[123]*tmp[171] + P[124]*tmp[172] + P[125]*tmp[170] + P[126]*tmp[173] + P[127]*tmp[174] + P[128]*tmp[175] + P[129]*tmp[176] + P[130];
	P_new[77] = P[69]*tmp[178] + P[70]*tmp[179] + P[71]*tmp[177] + P[72]*tmp[180] + P[73]*tmp[181] + P[74]*tmp[182] + P[75]*tmp[183] + P[77];
	P_new[89] = P[81]*tmp[178] + P[82]*tmp[179] + P[83]*tmp[177] + P[84]*tmp[180] + P[85]*tmp[181] + P[86]*tmp[182] + P[87]*tmp[183] + P[89];
	P_new[102] = P[100]*tmp[183] + P[102] + P[94]*tmp[178] + P[95]*tmp[179] + P[96]*tmp[177] + P[97]*tmp[180] + P[98]*tmp[181] + P[99]*tmp[182];
	P_new[116] = P[108]*tmp[178] + P[109]*tmp[179] + P[110]*tmp[177] + P[111]*tmp[180] + P[112]*tmp[181] + P[113]*tmp[182] + P[114]*tmp[183] + P[116];
	P_new[131] = P[123]*tmp[178] + P[124]*tmp[179] + P[125]*tmp[177] + P[126]*tmp[180] + P[127]*tmp[181] + P[128]*tmp[182] + P[129]*tmp[183] + P[131];
	P_new[90] = P[81]*tmp[185] + P[82]*tmp[186] + P[83]*tmp[184] + P[84]*tmp[187] + P[85]*tmp[188] + P[86]*tmp[189] + P[87]*tmp[190] + P[90];
	P_new[103] = P[100]*tmp[190] + P[103] + P[94]*tmp[185] + P[95]*tmp[186] + P[96]*tmp[184] + P[97]*tmp[187] + P[98]*tmp[188] + P[99]*tmp[189];
	P_new[117] = P[108]*tmp[185] + P[109]*tmp[186] + P[110]*tmp[184] + P[111]*tmp[187] + P[112]*tmp[188] + P[113]*tmp[189] + P[114]*tmp[190] + P[117];
	P_new[132] = P[123]*tmp[185] + P[124]*tmp[186] + P[125]*tmp[184] + P[126]*tmp[187] + P[127]*tmp[188] + P[128]*tmp[189] + P[129]*tmp[190] + P[132];
	P_new[104] = P[100]*tmp[197] + P[104] + P[94]*tmp[192] + P[95]*tmp[193] + P[96]*tmp[191] + P[97]*tmp[194] + P[98]*tmp[195] + P[99]*tmp[196];
	P_new[118] = P[108]*tmp[192] + P[109]*tmp[193] + P[110]*tmp[191] + P[111]*tmp[194] + P[112]*tmp[195] + P[113]*tmp[196] + P[114]*tmp[197] + P[118];
	P_new[133] = P[123]*tmp[192] + P[124]*tmp[193] + P[125]*tmp[191] + P[126]*tmp[194] + P[127]*tmp[195] + P[128]*tmp[196] + P[129]*tmp[197] + P[133];
	P_new[119] = P[108]*tmp[199] + P[109]*tmp[200] + P[110]*tmp[198] + P[111]*tmp[201] + P[112]*tmp[202] + P[113]*tmp[203] + P[114]*tmp[204] + P[119];
	P_new[134] = P[123]*tmp[199] + P[124]*tmp[200] + P[125]*tmp[198] + P[126]*tmp[201] + P[127]*tmp[202] + P[128]*tmp[203] + P[129]*tmp[204] + P[134];
	P_new[135] = P[123]*(-K_vbody[15]*tmp[36] - K_vbody[31]*tmp[35]) + P[124]*(-K_vbody[15]*tmp[29] - K_vbody[31]*tmp[33]) + P[125]*(-K_vbody[15]*tmp[24] - K_vbody[31]*tmp[25]) + P[126]*(-K_vbody[15]*tmp[64] - K_vbody[31]*tmp[65]) + P[127]*(-K_vbody[15]*tmp[82] - K_vbody[31]*tmp[84]) + P[128]*(-K_vbody[15]*tmp[97] - K_vbody[31]*tmp[96]) + P[129]*(-K_vbody[15]*tmp[104] - K_vbody[31]*tmp[105]) + P[135];

    // swap X, X_new and P, P_new pointers
    swap_ptr = X;
    X = X_new;
    X_new = swap_ptr;

    normalize_quaternion(X+6);

    swap_ptr = P;
    P = P_new;
    P_new = swap_ptr;
}